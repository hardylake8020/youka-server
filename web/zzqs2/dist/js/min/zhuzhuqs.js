"use strict";function OrderFollow(e,n,t,r,o,i,a,s,c,l,u,d){function p(e){c.getUserProfile().then(function(t){if(!t)return console.log("get user profile failed"),e();if(t.err)return console.log(t.err),e();if(!t.user_profile)return console.log("customer do not has user profile content"),e();if(!t.user_profile.customize_columns_follow||t.user_profile.customize_columns_follow.length<=0)console.log("customer did not create customer profile until now");else{var r,o;for(o=0;o<n.orders.orderList.selectOptions.length;o++)r=n.orders.orderList.selectOptions[o],r.isSelected=!1;t.user_profile.customize_columns_follow.forEach(function(e){for(o=0;o<n.orders.orderList.selectOptions.length;o++)if(r=n.orders.orderList.selectOptions[o],r.key===e){r.isSelected=!0;break}})}return t.user_profile.max_page_count_follow&&(n.orders.orderList.pagination.limit=parseInt(t.user_profile.max_page_count_follow)||n.orders.orderList.pagination.limit,n.orders.orderList.pagination.currentLimit=n.orders.orderList.pagination.limit),e()},function(n){return console.log(n),e()})}function f(){!n.orders.orderList.selectOptions||n.orders.orderList.selectOptions.length<=0||(n.orders.orderList.fields=[],n.orders.orderList.selectOptions.forEach(function(e){e.isSelected&&n.orders.orderList.fields.push(e.value)}),n.orders.orderList.fields.length>n.orders.orderList.fields_length&&(n.orders.orderList.fields=n.orders.orderList.fields.slice(0,n.orders.orderList.fields_length)))}function h(e){var n="";return n+=(e.nickname?e.nickname:"未知")+"/",n+=(e.plate_numbers&&e.plate_numbers.length>0?e.plate_numbers[0]:"未知")+"/",n+=e.username?e.username:"未知"}function m(e){var t={};return n.orders.orderList.fields.forEach(function(r){switch(r.value){case"order_number":t.order_number=e.order_number;break;case"ref_number":t.ref_number=e.refer_order_number?e.refer_order_number:"未填";break;case"original_order_number":t.original_order_number=e.original_order_number?e.original_order_number:"未填";break;case"goods_name":t.goods_name=u.getGoodsNameString(e.goods);break;case"execute_driver":t.execute_driver=e.execute_drivers&&e.execute_drivers.length>0?h(e.execute_drivers[0]):"无";break;case"execute_company":t.execute_company=e.execute_companies&&e.execute_companies.length>0?e.execute_companies[0].name:"无";break;case"sender_name":t.sender_name=e.sender_name?e.sender_name:"未填";break;case"receiver_name":t.receiver_name=e.receiver_name?e.receiver_name:"未填";break;case"damage":t.damage=e.damaged===!0||"true"===e.damaged?"有货损 ":"无货损 ";break;case"description":t.description=e.description?e.description:"未填";break;case"status":t.status=n.generateOrderStatus(e.status,e.delete_status);break;case"abnormal_reason":t.abnormal_reason=e.abnormal_reason;break;case"assign_time":t.assign_time=e.assign_time?new Date(e.assign_time).Format("yyyy-MM-dd hh:mm:ss"):"无";break;case"entrance_time":e.pickup_sign_events&&e.pickup_sign_events.length>0?t.entrance_time=new Date(e.pickup_sign_events[0].created).Format("yyyy-MM-dd hh:mm:ss"):t.entrance_time="无";break;case"halfway":e.halfway_events&&e.halfway_events.length>0?(t.halfway=new Date(e.halfway_events[0].created).Format("yyyy-MM-dd hh:mm:ss")+" ",e.halfway_events[0].description?t.halfway+=e.halfway_events[0].description:t.halfway+="无描述"):t.halfway="无";break;case"confirm":e.confirm_events&&e.confirm_events.length>0?t.confirm="已确认":t.confirm="未确认"}}),t}function g(e){if(e&&!(e.length<=0))for(var n=0;n<e.length;n++){var t=e[n];t.audioPlayer&&(t.audioPlayer.close(),t.audioPlayer=null)}}function v(e){if(e&&!(e.length<=0))for(var t=0;t<e.length;t++){var r=e[t];r.voice_file.length>0&&(r.voice_file=i.qiniuServerAddress+r.voice_file,r.audioPlayer=new a(r.voice_file,function(e,t){setTimeout(function(){n.$apply()},1)}))}}function _(e){if(e&&!(e.length<=0))for(var n=0;n<e.length;n++){var t=e[n];t.order_codes&&t.order_codes.length>0?t.barcodes=t.order_codes.join(", "):t.barcodes=""}}function y(e){!e||e.length<=0||e.forEach(function(e){switch(e.type){case"pickup":case"delivery":e.goods_photos&&e.goods_photos.length>0&&e.goods_photos.forEach(function(t){Se+=we;var r={order:n.orderDetailInfo.currentOrderDetail.orderDetail.number,title:"提货货物照片",warning:e.damaged?"货物有损":"",url:P(t),remark:e.description};E(r)}),e.credential_photos&&e.credential_photos.length>0&&e.credential_photos.forEach(function(t){Se+=we;var r={order:n.orderDetailInfo.currentOrderDetail.orderDetail.number,title:"提货单据照片",warning:e.damaged?"货物有损":"",url:P(t),remark:e.description};E(r)});break;case"pickupSign":case"deliverySign":case"halfway":e.halfway_photos&&e.halfway_photos.length>0&&e.halfway_photos.forEach(function(t){Se+=we;var r={order:n.orderDetailInfo.currentOrderDetail.orderDetail.number,title:z(e.type),warning:e.damaged?"货物有损":"",url:P(t),remark:e.description};E(r)})}e.photos&&e.photos.length>0&&e.photos.forEach(function(t){Se+=we;var r={order:n.orderDetailInfo.currentOrderDetail.orderDetail.number,title:t.name,warning:e.damaged?"货物有损":"",url:P(t.url),remark:e.description};E(r)})})}function S(e){if(e&&!(e.length<=0))for(var n=0;n<e.length;n++){var t=e[n];if(t.actualGoods=[],t.actualShowing=!1,t.actual_more_goods_record&&t.actual_more_goods_record.length>0){for(var r=0;r<t.actual_more_goods_record.length;r++)(t.actual_more_goods_record[r].name||t.actual_more_goods_record[r].count)&&(t.actualShowing=!0),t.actualGoods.push({title:"实收货物"+(r+1),name:t.actual_more_goods_record[r].name||"未知名称",count:t.actual_more_goods_record[r].count||"未知数量",unit:t.actual_more_goods_record[r].unit});1===t.actualGoods.length&&(t.actualGoods[0].title="实收货物")}else t.actual_goods_record&&((t.actual_goods_record.goods_name||t.actual_goods_record.count||t.actual_goods_record.weight||t.actual_goods_record.volume)&&(t.actualShowing=!0),t.actualGoods.push({title:"实收货物",name:t.actual_goods_record.goods_name||"未知名称",count:u.getCountDetail(t.actual_goods_record),unit:""}))}}function w(e){n.orders.orderList.pagination.searchName=e.value,n.orders.orderList.pagination.searchValue=e.keyword,B()}function k(){f(),n.orders.currentOrderList&&n.orders.currentOrderList.length>0&&V(n.orders.currentOrderList)}function C(){for(var e,t=[],r=0;r<n.orders.orderList.selectOptions.length;r++)e=n.orders.orderList.selectOptions[r],e.isSelected&&t.push(e.key);t.length>0&&c.setFollowCustomizeColumns(t).then(function(e){return e?e.err?void console.log(e.err):void 0:void console.log("set customize columns failed")},function(e){console.log(e)})}function b(e,n){c.setMaxPageCount({column_name:e,max_page_count:n}).then(function(e){return!e||e.err?console.log("set follow page max count failed"):void console.log("set follow page max count success")},function(e){return console.log("set follow page max count failed")})}function I(e){n.orders.orderList.pagination.sortName=e.value,n.orders.orderList.pagination.sortValue=e.curSort.value,B()}function x(e){n.orderDetailInfo.showDialog=e}function D(e){e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0}function O(e){s[e]?n.$emit(o.onShowAlert,s[e]):n.$emit(o.onShowAlert,e+" 未知错误！请联系管理员")}function A(e){var n="";switch(e){case"unAssigned":n="未分配";break;case"assigning":n="分配中";break;case"unPickupSigned":case"unPickuped":n="未提货";break;case"unDeliverySigned":case"unDeliveried":n="未交货";break;case"confirm":n="确认接单";break;case"pickupSign":n="提货签到";break;case"pickup":n="提货";break;case"deliverySign":n="交货签到";break;case"delivery":n="交货";break;case"halfway":n="中途事件";break;case"completed":n="已完成"}return n}function P(e){return i.qiniuServerAddress+e}function L(e){if(0===n.orderDetailInfo.curPhotoList.length)return 0;for(var t=P(e),r=0;r<n.orderDetailInfo.curPhotoList.length;r++)if(n.orderDetailInfo.curPhotoList[r].url===t)return r;return 0}function z(e){switch(e){case"pickup":return"提货货物照片";case"delivery":return"交货货物照片";case"pickupSign":return"提货签到照片";case"deliverySign":return"交货签到照片";case"halfway":return"中途事件照片"}return""}function E(e){for(var t=0;t<n.orderDetailInfo.curPhotoList.length;t++)if(n.orderDetailInfo.curPhotoList[t]==e)return;n.orderDetailInfo.curPhotoList.push(e)}function T(e){var n=[];switch(e.type){case"pickup":case"delivery":e.goods_photos&&e.goods_photos.length>0&&n.push(e.goods_photos[0]),e.credential_photos&&e.credential_photos.length>0&&n.push(e.credential_photos[0]);break;case"pickupSign":case"deliverySign":case"halfway":e.halfway_photos&&e.halfway_photos.length>0&&n.push(e.halfway_photos[0])}var t="";return n.length>0&&(t+='<div id="'+e._id+'" class="photos">',n.forEach(function(e){t+='<div class="photo" onclick="angular.element(this).scope().showPhotos(\''+e+'\');"><img src="'+P(e)+'" onerror="this.src=\'images/icon/order_follow/error.jpg\'"/></div>'}),t+="</div>"),t}function M(e,t){if(console.log(e.length),!e||e.length<=0)n.orderShare.batchShareInfo.orders=[],n.orders.isShowBatchDelete=!1,n.orders.isShowBatchShare=!1;else{n.orderShare.batchShareInfo.orders=e,n.orders.isShowBatchDelete=!0,n.orders.isShowBatchShare=!0;for(var r=0;r<e.length;r++){var o=e[r];if(o.create_company_id!==o.execute_company_id||"unAssigned"!==o.status&&"assigning"!==o.status&&"unPickupSigned"!==o.status){n.orders.isShowBatchDelete=!1;break}}}D(t)}function R(e){e&&e._id&&(e.rowConfig.isDeleted||(n.orderDetailInfo.currentId=e._id,K(),j(e._id),d.onRowClick&&d.onRowClick(e,n.searchModule.currentLabel)))}function B(){n.$emit(o.onShowLoading,!0);var e=_e();d.getOrderList(n.orders.orderList.pagination.currentPage,n.orders.orderList.pagination.limit,n.orders.orderList.pagination.sortName,n.orders.orderList.pagination.sortValue,e).then(function(e){n.$emit(o.onShowLoading,!1),console.log(e.orders),e.err?O(e.err.type):(d.handleOrders&&"function"==typeof d.handleOrders&&d.handleOrders(e),n.orders.currentOrderList=e.orders,V(e.orders),n.orders.orderList.pagination.currentPage=parseInt(e.currentPage),n.orders.orderList.pagination.limit=parseInt(e.limit),n.orders.orderList.pagination.totalCount=parseInt(e.totalCount),n.orders.orderList.pagination.pageCount=Math.ceil(e.totalCount/e.limit),n.orders.orderList.pagination.render())},function(e){e&&console.log(e)})}function H(e){if(!e||e.length<=0)return[];for(var n=[],t=[],r=0;r<e.length;r++){for(var o=e[r],i=!1,a=0;a<t.length;a++){var s=t[a];if(s.order_id.toString()===o.order._id.toString()){if(i=!0,"pickupSign"===o.type&&s.events.indexOf("pickupSign")>-1)continue;if("pickup"===o.type&&s.events.indexOf("pickup")>-1)continue;if("deliverySign"===o.type&&s.events.indexOf("deliverySign")>-1)continue;if("delivery"===o.type&&s.events.indexOf("delivery")>-1)continue;s.events.push(o.type),n.push(o)}}i||(t.push({order_id:o.order._id,events:[o.type]}),n.push(o))}return n}function W(e){return e?Math.round(100*e)/100:e}function q(e,n){if(e){var t=[];if(e.count&&e.unit){var r=parseFloat(e.count);r&&(t.push(myFixed(r)+e.unit),n[e.unit]?n[e.unit]+=W(r):n[e.unit]=W(r))}if(e.count2&&e.unit2){var o=parseFloat(e.count2);o&&(t.push(myFixed(o)+e.unit2),n[e.unit2]?n[e.unit2]+=W(o):n[e.unit2]=W(o))}if(e.count3&&e.unit3){var i=parseFloat(e.count3);i&&(t.push(myFixed(i)+e.unit3),n[e.unit3]?n[e.unit3]+=W(i):n[e.unit3]=W(i))}return 0==t.length?"-":t.join("/")}return"-"}function U(e,r){t.getEventsByOrderId(e,n.searchModule.currentLabel).then(function(e){return e.err?O(e.err.type):(e&&e.events&&e.events instanceof Array&&e.events.forEach(function(e){if("pickup"==e.type||"delivery"==e.type){for(var n=r.goods,t=e.actual_more_goods_record,o=[],i={},a={},s="正常",c=0,l=n.length;c<l;c++){var u,d=n[c],p=t.filter(function(e){if(d._id.toString()==e._id.toString())return e})[0]||{},f=q(d,i),h=q(p,a);p&&p.count?d.count!=p.count?(u="缺货",s="缺货"):u="正常":(u="缺货",s="缺货"),o.push({name:d.name,planned:f,actual:h,compare:u})}var m="";for(var g in i)i.hasOwnProperty(g)&&(m+="/"+myFixed(i[g])+g);m.length>0&&(m=m.substring(1));var v="";for(g in a)a.hasOwnProperty(g)&&(v+="/"+myFixed(a[g])+g);v=v.length>0?v.substring(1):"-",o.push({name:"合计",planned:m,actual:v,compare:s}),e.compare_goods=o}}),e.events=H(e.events),n.orderDetailInfo.currentOrderEventInfo=e,n.orderDetailInfo.curPhotoList=[],y(n.orderDetailInfo.currentOrderEventInfo.events),v(n.orderDetailInfo.currentOrderEventInfo.events),_(n.orderDetailInfo.currentOrderEventInfo.events),void S(n.orderDetailInfo.currentOrderEventInfo.events))},function(e){return console.log(e),n.orderDetailInfo.currentOrderEventInfo={},O(e.err.type)})}function F(e,n,t){var r={};return t?(r.address=t.address||"未知地址",r.time=new Date(t.time).Format("yyyy/MM/dd hh:mm"),r.isActual=!0):(r.address=e||"未知地址",r.time=n?new Date(n).Format("yyyy/MM/dd hh:mm"):"未知时间",r.isActual=!1),r}function N(e){var n=l.getUser();e.companyOrdersWithAssignDriver=[],e&&e.assignedCompanyOrders&&e.assignedCompanyOrders.length>0&&(e.companyOrdersWithAssignDriver=e.assignedCompanyOrders.filter(function(e){return!!(e.drivers&&e.drivers.length>0)})),e.companyOrdersWithAssignDriver.sort(function(e,n){return!e.assign_time||!!n.assign_time&&new Date(e.assign_time)>new Date(n.assign_time)});for(var t=1,r=0;r<e.companyOrdersWithAssignDriver.length;r++){var o=e.companyOrdersWithAssignDriver[r];o.assign_time?o.assign_time_format=new Date(o.assign_time).Format("yyyy/MM/dd hh:mm"):o.assign_time_format="未知时间";for(var i=0;i<o.drivers.length;i++){var a=o.drivers[i];if(a.pickup_event_format=F(a.pickup_contacts.address,a.pickup_start_time,a.pickup_events[0]),a.delivery_event_format=F(a.delivery_contacts.address,a.delivery_start_time,a.delivery_events[0]),a.driver_evaluations&&a.driver_evaluations.length>0){var s=a.driver_evaluations.filter(function(e){return e.company_id.toString()===n.company._id.toString()});s.length>0&&(a.current_evaluation=s[0])}a.number=t,t++}}}function G(e){var n=[];if(e.goods&&e.goods.length>0){for(var t=0;t<e.goods.length;t++)n.push({title:"货物"+(t+1),name:e.goods[t].name||"未知名称",value:u.getSingleCountDetail(e.goods[t]),sum:(parseFloat(e.goods[t].count)||0)*(parseFloat(e.goods[t].price)||0)});1===n.length&&(n[0].title="货物")}else n.push({title:"货物",name:e.goods_name||"未知名称",value:u.getOrderCountVolumeWeight(e),sum:0});e.goodsInfo=n}function j(e){n.$emit(o.onShowLoading,!0),t.getAssignedOrderDetail(e,n.searchModule.currentLabel).then(function(t){if(n.$emit(o.onShowLoading,!1),console.log(t),console.log(e),t.err)return O(t.err.type);if(t&&t.orderDetail&&t.orderDetail.salesmen&&t.orderDetail.salesmen.length>0){for(var r=[],i=0,a=t.orderDetail.salesmen.length;i<a;i++){var s=t.orderDetail.salesmen[i];s&&(s.nickname&&s.nickname!=s.username?r.push(s.nickname+"("+s.username+")"):r.push(s.username))}t.orderDetail._salesmen=r}else t.orderDetail._salesmen=[];n.orderDetailInfo.showOrderDetail=!0,x(!0),N(t),G(t.orderDetail),n.orderDetailInfo.currentOrderDetail=t,U(e,t.orderDetail)},function(e){O(e)})}function V(e){n.orders.orderList.rows=[];for(var t=0;t<e.length;t++){var r=e[t],o={_id:r._id,status:r.status,columns:m(r),extendData:{refer_order_number:r.refer_order_number,original_order_number:r.original_order_number,goods_name:r.goods_name,pickup_contact_name:r.pickup_contacts.name,pickup_contact_phone:r.pickup_contacts.phone,pickup_contact_mobile_phone:r.pickup_contacts.mobile_phone,pickup_contact_address:r.pickup_contacts.address,delivery_contact_name:r.delivery_contacts.name,delivery_contact_phone:r.delivery_contacts.phone,delivery_contact_mobile_phone:r.delivery_contacts.mobile_phone,delivery_contact_address:r.delivery_contacts.address,pickup_start_time:r.pickup_start_time,pickup_end_time:r.pickup_end_time,delivery_start_time:r.delivery_start_time,delivery_end_time:r.delivery_end_time,customer_name:r.customer_name,create_user:r.create_user,create_group:r.create_group,execute_group:r.execute_group,description:r.description,count:r.count,weight:r.weight,volume:r.volume,count_unit:r.count_unit,weight_unit:r.weight_unit,volume_unit:r.volume_unit,freight_charge:r.freight_charge,details:r.details,sender_name:r.sender_name,receiver_name:r.receiver_name,receiver_company:r.receiver_company,sender_company:r.sender_company,salesmen:r.salesmen||[],goods:r.goods||[],pickup_deferred_duration:r.pickup_deferred_duration||0,delivery_early_duration:r.delivery_early_duration||0,abnormal_push:r.abnormal_push||!1,pickup_push:r.pickup_push||!1,create_push:r.create_push||!1,delivery_sign_push:r.delivery_sign_push||!1,delivery_push:r.delivery_push||!1,order_transport_type:r.order_transport_type||"ltl"},rowConfig:{isDeleted:r.delete_status,notOptional:!!r.delete_status,unEdited:!0,selfButtons:Y(r)}};d.generateRowData&&d.generateRowData(o,r,l.getUser()._id.toString()),n.orders.orderList.rows.push(o)}n.orders.orderList.load()}function Y(e){var t=[];if(e.delete_status===!0)return t;if("assign"===n.searchModule.currentLabel&&("unPickupSigned"===e.status||"assigning"===e.status)){var r=!0;e.assigned_infos&&e.assigned_infos.length>0&&r&&t.push({text:"",clickHandle:Q,className:"modify-assign-info",title:"重新分配"})}return t.push({text:"",clickHandle:le,className:"email-share",title:"分享到邮件"}),t.push({text:"",clickHandle:function(e,n){var t=ae([e]);se(t,n)},className:"wechat-share",title:"分享到微信"}),"assign"===n.searchModule.currentLabel,t}function Q(n,t){console.log("修改订单分配信息"),e.go("order_modify_assign",{id:n._id}),D(t)}function K(){n.orderDetailInfo.gpsCount=0,n.orderDetailInfo.ungpsCount=0}function Z(e){if(e){var n=new BMap.Marker(e,{icon:Ie});ye.addOverlay(n),xe.push(n)}}function J(e,o){t.getTracesByOrderId(n.orderDetailInfo.currentId,n.searchModule.currentLabel).then(function(t){if(console.log(t,"driverTraces==========="),t.err)return O(t.err.type),o();var i=[];K();var a={trace:"",time:new Date("1988-1-10")};t.forEach(function(t){var o=r.drawLine(ye,t.traces,a,e),s=o.points;n.orderDetailInfo.gpsCount+=o.gpsCount,n.orderDetailInfo.ungpsCount+=o.ungpsCount,s.forEach(function(e){i.push(e)})});var s=n.orderDetailInfo.currentOrderDetail.orderDetail;return"completed"!=s.status&&"unAssigned"!=s.status&&a.trace&&(te(),Z(new BMap.Point(a.trace.location[0],a.trace.location[1]))),o(null,i)},function(e){return console.log(e),o()})}function X(e){var n=[];e.parent_order||(e.pickup_contacts.location&&2===e.pickup_contacts.location.length&&n.push({point:e.pickup_contacts.location,type:"pickup",address:e.pickup_contacts.brief||e.pickup_contacts.address}),e.delivery_contacts.location&&2===e.delivery_contacts.location.length&&n.push({point:e.delivery_contacts.location,type:"delivery",address:e.delivery_contacts.brief||e.delivery_contacts.address})),0===n.length&&e.assigned_infos&&e.assigned_infos.length>0&&e.assigned_infos.forEach(function(e){e.pickup_contact_location&&2===e.pickup_contact_location.length&&n.push({point:e.pickup_contact_location,type:"pickup",address:e.pickup_contact_brief||e.pickup_contact_address}),e.delivery_contact_location&&2===e.delivery_contact_location.length&&n.push({point:e.delivery_contact_location,type:"delivery",address:e.delivery_contact_brief||e.delivery_contact_address})});var t=[];return n.length>0&&(t=r.drawCircle(ye,n)),t}function ee(){!n.orderDetailInfo.currentOrderEventInfo.events||n.orderDetailInfo.currentOrderEventInfo.events.length<=0||n.orderDetailInfo.currentOrderEventInfo.events.forEach(function(e){var n=oe(e);r.drawDriverEvent(ye,e,n)})}function ne(){ye.clearOverlays()}function te(){xe.length>0&&xe.forEach(function(e){ye.removeOverlay(e)})}function re(e){return A(e)}function oe(e){var n='<div class="event-tip"><div class="event_type">'+re(e.type)+'</div><div class="driver"><strong>司机:</strong><span>'+(e.driver.nickname?e.driver.nickname+" ":"")+(e.driver.username?e.driver.username+" ":"")+(e.driver.plate_numbers.length>0?e.driver.plate_numbers[0]+" ":"")+'</span></div><div class="time"><strong>时间:</strong><time>'+new Date(e.time).toLocaleString()+'</time></div><div class="address"><strong>地点:</strong><span>'+e.address+'</span></div><div class="damaged"><strong>货损:</strong><span>'+(e.damaged?"有":"无")+'</span></div><div class="description"><strong>备注:</strong><span>'+(e.description?e.description:"无")+"</span></div>"+T(e)+"</div>";return n}function ie(e,n){var t=ae(e);se(t,n)}function ae(e){if(e.length<=0)return[];for(var n=[],t=0;t<e.length;t++){var r={_id:e[t]._id,order_number:e[t].columns.order_number};n.push(r)}return n}function se(e,n){var t=JSON.stringify(e);t=encodeURIComponent(t);var r=i.serverAddress+"/wechat_share_qrcode?order_array="+t;ce(r),D(n)}function ce(e,n){null!=n&&""!=n||(n="WechatShare");var t=window.open(e,n);return t.focus(),t}function le(e,n){var t=[];t.push(e),ue(t),D(n)}function ue(e){n.$emit(o.onShowLoading,!0),ve(function(){n.orderShare.orders=e,n.orderShare.count=e.length,n.orderShare.order_number_text=de(e),n.orderShare.mainShareShow=!0,n.orderShare.editShareShow=!0,n.orderShare.staffShareShow=!0,n.orderShare.cooperateCompany.currentCompanyName="",n.orderShare.cooperateCompany.selectedCompanyStaffs="",x(!0),n.$emit(o.onShowLoading,!1)})}function de(e){if(!e.length||e.length<=0)return"";var n=e[0].columns.order_number;return e.length>1&&(n+="..."),n}function pe(e){if(!e||e.length<=0)return"";for(var n=[],t=0;t<e.length;t++)n.push(e[t]._id.toString());return n}function fe(e){if(!e||e.length<=0)return[];var t=[];return n.orderShare.staffRecipients=[],n.orderShare.allRecipients=[],e.forEach(function(e){return!e.staffs||e.staffs.length<=0||void e.staffs.forEach(function(e){e.isSelected&&(t.push(e),n.orderShare.staffRecipients.push(e.username),n.orderShare.allRecipients.push(e.nickname))})}),n.orderShare.allRecipients.length>0&&(n.orderShare.allRecipients=n.orderShare.allRecipients.join("、")),t}function he(e){if(!e||e.length<=0)return!1;var n=!0;return e.every(function(e,t,r){return!!e.isSelected||(n=!1,!1)}),n}function me(e){!e||e.length<=0||e.forEach(function(e){e.isSelected=!e.isSelected})}function ge(e){!e||e.length<=0||e.forEach(function(e){return!e.staffs||e.staffs.length<=0||void e.staffs.forEach(function(e){e.isSelected=!1})})}function ve(e){t.getCooperateCompanys().then(function(t){if(t.err)console.log(t.err);else{if(!t.companyIds||t.companyIds.length<=0)return console.log("no cooperation companys"),void e();if(!t.staffs||t.staffs.length<=0)return console.log("there are no users in cooperation companys"),void e();var r=[];t.companyIds.forEach(function(e){var n=[];t.staffs.forEach(function(t){e.toString()===t.company._id.toString()&&(t.isSelected=!1,n.push(t))}),n.length>0&&r.push({name:n[0].company.name,staffs:n})}),n.orderShare.cooperateCompany.allCompany=r}e()},function(n){console.log(n),e()})}function _e(){if(n.searchModule){var e=[],t=[],r=!1;return n.searchModule.statusOptions.forEach(function(n){n.isSelected&&("已撤销"===n.name?(e.push({key:"isDeleted",value:!0}),r=!0):t=t.concat(n.value))}),r||e.push({key:"isDeleted",value:!1}),t.length>0&&e.push({key:"order_status",value:t}),n.searchModule.createTimeRange&&(e.push({key:"createTimeStart",value:moment(n.searchModule.createTimeRange.startDate).toISOString()}),e.push({key:"createTimeEnd",value:moment(n.searchModule.createTimeRange.endDate).toISOString()})),n.searchModule.deliveryTimeRange&&(e.push({key:"deliveryTimeStart",value:moment(n.searchModule.deliveryTimeRange.startDate).toISOString()}),e.push({key:"deliveryTimeEnd",value:moment(n.searchModule.deliveryTimeRange.endDate).toISOString()})),n.searchModule.receiver&&e.push({key:"receiver",value:n.searchModule.receiver}),n.searchModule.goods_name&&e.push({key:"goods_name",value:n.searchModule.goods_name}),n.searchModule.damaged&&"不限"!==n.searchModule.damaged&&e.push({key:"damaged",value:"有"===n.searchModule.damaged}),n.searchModule.pickUpTimeRange&&(e.push({key:"pickupTimeStart",value:moment(n.searchModule.pickUpTimeRange.startDate).toISOString()}),e.push({key:"pickupTimeEnd",value:moment(n.searchModule.pickUpTimeRange.endDate).toISOString()})),n.searchModule.sender&&e.push({key:"sender",value:n.searchModule.sender}),n.searchModule.description&&e.push({key:"description",value:n.searchModule.description}),n.searchModule.order_number&&e.push({key:"order_number",value:n.searchModule.order_number}),n.searchModule.executeCompanyorDriver&&e.push({key:"executor",value:n.searchModule.executeCompanyorDriver}),n.searchModule.currentLabel&&e.push({key:"viewer",value:n.searchModule.currentLabel}),e}}var ye=r.create("orderTraceMap","北京",11,!0);n.orders={orderList:{selectOptions:d.selectOptions,selectionOption:{columnWidth:1},handleOption:{columnWidth:2},fields:[],fields_length:7,isShowPagination:!0,pagination:{currentPage:1,currentLimit:10,limit:10,totalCount:0,pageCount:0,pageNavigationCount:5,canSeekPage:!0,limitArray:[10,20,30,40,100],pageList:[1],sortName:"",sortValue:"",searchName:"",searchValue:"",onCurrentPageChanged:function(e){n.orders.orderList.pagination.currentLimit!==n.orders.orderList.pagination.limit&&(n.orders.orderList.pagination.currentLimit=n.orders.orderList.pagination.limit,b("max_page_count_follow",n.orders.orderList.pagination.limit)),B()}},rows:[],events:{selectedHandler:[M],rowClickHandler:[R],headerSortChangedHandler:[I],headerKeywordsChangedHandler:[w],updateDisplayFields:[k],saveDisplayFields:[C]}},transportEvent:{current:"",clickVoice:""},isShowBatchDelete:!1,isShowBatchShare:!1,currentOrderList:[]},n.orderDetailInfo={isAdmin:!1,showDialog:!1,imgIndex:0,showOrderDetail:!1,showPhotoScan:!1,currentTab:"timeline",currentId:"",currentOrderDetail:{},currentOrderEventInfo:{},curPhotoList:[],curPhotoItem:"",curPhotoIndex:0,gpsCount:0,ungpsCount:0,currentTitle:d.pageTitle||"运单跟踪"},n.close=function(e){n.orderDetailInfo.currentOrderEventInfo&&n.orderDetailInfo.currentOrderEventInfo.events&&g(n.orderDetailInfo.currentOrderEventInfo.events),n.orders.transportEvent.current="",n.orderDetailInfo.currentId="",n.orderDetailInfo.currentOrderDetail={},n.orderDetailInfo.currentTab="timeline",n.orderDetailInfo.curPhotoList=[],n.orderDetailInfo.showOrderDetail=!1,x(!1),ne(),D(e)},n.changeTab=function(e,t){n.orderDetailInfo.currentTab=e,"map"==e&&(ne(),J(t,function(e,t){var r=X(n.orderDetailInfo.currentOrderDetail.orderDetail);t=t||[];var o=t.concat(r);setTimeout(function(){ye.setViewport(o)},1e3)}),ee())},n.evaluateDriver=function(e){var n=l.getUser(),t="/driver/evaluation/page?driver_id="+e.execute_driver._id+"&order_id="+e._id+"&company_id="+n.company._id+"&access_token="+l.getToken();ce(t,"评价司机")},n.getEvaluationLevel=function(e){var n="";switch(e){case 1:n="好评";break;case 2:n="中评";break;case 3:n="差评"}return n},n.orders.transportEvent.clickVoice=function(e){if(e&&e.voice_file){var t=n.orders.transportEvent.current;return t&&t.voice_file===e.voice_file?void(t.audioPlayer&&("playing"===t.audioPlayer.status?t.audioPlayer.stop():t.audioPlayer.play())):void(e.audioPlayer&&(t&&t.audioPlayer&&t.audioPlayer.stop(),e.audioPlayer.play(),n.orders.transportEvent.current=e))}};var Se=(document.querySelector("[id='photo-thum-list']"),0),we=111,ke=0;n.generatePhoto=function(e){return e?P(e):"images/icon/order_follow/error.jpg"},n.showPhotos=function(e){n.orderDetailInfo.imgIndex=L(e),n.orderDetailInfo.showPhotoScan=!0,"map"==n.orderDetailInfo.currentTab&&n.$apply()},n.showPhotoByPhotos=function(e){n.orderDetailInfo.curPhotoItem=e},n.moveThumList=function(){var e=$(".photo-nav-view").width();Se<e||(ke-=we,ke-e+Se<=0||$("#photo-thum-list").css("left",ke+"px"))},n.generateOrderStatus=function(e,n){if(n)return"已撤销";var t=A(e);return t?t:"已完成"},n.generateEventTypeDescription=function(e){return"warehouse"===e.order.type?"仓储收货":re(e.type)},n.getDetailInfo=function(e){n.orderDetailInfo.currentId=e,K(),j(e)},n.exportOrderPdf=function(){t.exportOrderPdf(n.orderDetailInfo.currentId)},n.showPartners=function(e){e&&(n.partners="",e.forEach(function(e){n.partners+=e.partner_name+" "}))},n.batchDeleteOrders=function(){if(n.orders.isShowBatchDelete&&n.orderShare.batchShareInfo.orders&&!(n.orderShare.batchShareInfo.orders.length<=0)){for(var r=[],i=0;i<n.orderShare.batchShareInfo.orders.length;i++){var a=n.orderShare.batchShareInfo.orders[i];r.push(a._id)}n.$emit(o.onShowAlertConfirm,"确认要删除这"+n.orderShare.batchShareInfo.orders.length+"项运单吗？",function(i){n.$emit(o.onShowLoading,!0),t.batchDeleteOrders(r).then(function(t){if(n.$emit(o.onShowLoading,!1),console.log(t),!t)return O("");if(t.err)return O(t.err.type);var r="删除成功";t.failedOrders&&t.failedOrders.length>0&&(r="操作完成，失败"+t.failedOrders.length+"个"),n.$emit(o.onShowAlert,r,function(){e.go("order_follow",{},{reload:!0})})},function(e){n.$emit(o.onShowLoading,!1),console.log(e)})},null)}};var Ce=new BMap.Size(42,33),be=new BMap.Size(14,33),Ie=new BMap.Icon(i.serverWebAddress+"/images/icon/order_follow/map_current.gif",Ce,{anchor:be}),xe=[];n.orderShare={mainShareShow:!1,editShareShow:!0,staffShareShow:!0,count:0,orders:"",batchShareInfo:{orders:[]},suffix_customer:"",emailRecipients:"",staffRecipients:[],allRecipients:"",order_number_text:"",shareWithStaff:"",shareWithEmail:"",closeSharePage:"",clickShare:"",cooperateCompany:{allCompany:[],selectedCompanyStaffs:[],allSelectedCount:0,isSelectedAll:!1,isInvertSelected:!1,clickSingleCompany:"",clickSingleStaff:"",clickSelectAll:"",clickInvertSelect:"",clickClearAll:"",currentCompanyName:""}},n.batchWechatShareOrders=function(){!n.orderShare.batchShareInfo.orders||n.orderShare.batchShareInfo.orders.length<=0||ie(n.orderShare.batchShareInfo.orders)},n.batchEmailShareOrders=function(){!n.orderShare.batchShareInfo.orders||n.orderShare.batchShareInfo.orders.length<=0||ue(n.orderShare.batchShareInfo.orders)},n.orderShare.closeSharePage=function(){n.orderShare.mainShareShow=!1,x(!1)},n.orderShare.shareWithStaff=function(){n.orderShare.staffShareShow=!0},n.orderShare.shareWithEmail=function(){n.orderShare.staffShareShow=!1},n.orderShare.clickShare=function(){if(n.orderShare.staffShareShow&&n.orderShare.staffRecipients.length<=0||!n.orderShare.staffShareShow&&!n.orderShare.emailRecipients)return void n.$emit(o.onShowAlert,"请选择员工或输入邮箱地址");var e=[];n.orderShare.staffShareShow?e=n.orderShare.staffRecipients:e.push(n.orderShare.emailRecipients);var r=/^([a-zA-Z0-9_.-])+@([a-zA-Z0-9_-])+((.[a-zA-Z0-9_-]{2,}){1,2})$/,i=!0;return e.every(function(e,n,t){return!!r.test(e)||(console.log("invalid email address: "+e),i=!1,!1)}),i?(n.$emit(o.onShowLoading,!0),n.orderShare.staffShareShow||(n.orderShare.allRecipients=e[0]),e.length>1?n.orderShare.suffix_customer="等"+e.length.toString()+"位客户":n.orderShare.suffix_customer="1位客户",void t.shareOrders(pe(n.orderShare.orders),e,!n.orderShare.staffShareShow).then(function(e){if(n.$emit(o.onShowLoading,!1),e.err)"550 Mailbox not found or access denied"===e.err.data?n.$emit(o.onShowAlert,"您输入的邮箱可能不存在或者拒绝接受信件！请检查邮箱是否正确，重新输入。"):n.$emit(o.onShowAlert,"发送邮件失败！请检查邮箱是否正确，重新输入。");else if(e.totalReceptionsCount===e.successReceptions.length)n.orderShare.editShareShow=!1;else{var t="";e.invalidEmailReceptionsCount>0&&(t+="邮箱验证："+e.invalidEmailReceptionsCount+"个失败！"),e.failedReceptions.length>0&&(t+="用户分享："+e.failedReceptions.length+"个失败！"),e.successReceptions.length>0&&(t+="成功分享的邮箱有："+e.successReceptionsString+"的"+e.successReceptions.length+"个！"),n.$emit(o.onShowAlert,t)}},function(e){n.$emit(o.onShowLoading,!1),n.$emit(o.onShowAlert,"发送邮件失败")})):void n.$emit(o.onShowAlert,"邮箱地址不合法，请检查")},n.orderShare.cooperateCompany.clickSingleCompany=function(e){n.orderShare.cooperateCompany.selectedCompanyStaffs=e.staffs,n.orderShare.cooperateCompany.isSelectedAll=he(n.orderShare.cooperateCompany.selectedCompanyStaffs),n.orderShare.cooperateCompany.isInvertSelected=!1,n.orderShare.cooperateCompany.currentCompanyName=e.name},n.orderShare.cooperateCompany.clickSingleStaff=function(){var e=fe(n.orderShare.cooperateCompany.allCompany);n.orderShare.cooperateCompany.allSelectedCount=e.length,n.orderShare.cooperateCompany.isSelectedAll=he(n.orderShare.cooperateCompany.selectedCompanyStaffs),n.orderShare.cooperateCompany.isInvertSelected=!1},n.orderShare.cooperateCompany.clickSelectAll=function(){if(n.orderShare.cooperateCompany.selectedCompanyStaffs&&!(n.orderShare.cooperateCompany.selectedCompanyStaffs.length<=0)){n.orderShare.cooperateCompany.selectedCompanyStaffs.forEach(function(e){e.isSelected=n.orderShare.cooperateCompany.isSelectedAll});var e=fe(n.orderShare.cooperateCompany.allCompany);n.orderShare.cooperateCompany.allSelectedCount=e.length,n.orderShare.cooperateCompany.isInvertSelected=!1;
}},n.orderShare.cooperateCompany.clickInvertSelect=function(){me(n.orderShare.cooperateCompany.selectedCompanyStaffs);var e=fe(n.orderShare.cooperateCompany.allCompany);n.orderShare.cooperateCompany.allSelectedCount=e.length,n.orderShare.cooperateCompany.isSelectedAll=he(n.orderShare.cooperateCompany.selectedCompanyStaffs)},n.orderShare.cooperateCompany.clickClearAll=function(){ge(n.orderShare.cooperateCompany.allCompany),n.orderShare.cooperateCompany.clickSingleStaff()},n.searchModule={isShowHighSearch:!1,showHighSearchHandle:"",hideHighSearchHandle:"",executeCompanyorDriver:"",receiver:"",goods_name:"",damaged:"不限",sender:"",description:"",order_number:"",searchHandle:"",isShowStatusSelect:!1,isShowDamageSelect:!1,showStatusSelect:"",showDamageSelect:"",statusItemClickHandle:"",damageItemClickHandle:"",createTimeRange:"",pickUpTimeRange:"",deliveryTimeRange:"",cleanDeliveryTime:"",cleanPickupTime:"",currentLabel:"assign",changeLabel:"",statusOptions:[{name:"未分配",value:["unAssigned","assigning"],isSelected:!0},{name:"未提货",value:["unPickupSigned","unPickuped"],isSelected:!0},{name:"未交货",value:["unDeliverySigned","unDeliveried"],isSelected:!0},{name:"已完成",value:["completed"],isSelected:!0},{name:"已撤销",value:["deleted"],isSelected:!1}],dateOptions:{locale:{fromLabel:"起始时间",toLabel:"结束时间",cancelLabel:"取消",applyLabel:"确定",customRangeLabel:"区间",daysOfWeek:["日","一","二","三","四","五","六"],firstDay:1,monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]},timePicker:!0,timePicker12Hour:!1,timePickerIncrement:1,separator:" ~ ",format:"YY/MM/DD HH:mm"}},n.searchModule.showHighSearchHandle=function(){n.searchModule.isShowHighSearch=!0},n.searchModule.hideHighSearchHandle=function(){n.searchModule.isShowHighSearch=!1},n.searchModule.searchHandle=function(){n.orders.orderList.pagination.currentPage=1,B()},n.searchModule.showStatusSelect=function(e){n.searchModule.isShowStatusSelect=!n.searchModule.isShowStatusSelect,n.searchModule.isShowDamageSelect=!1,D(e)},n.searchModule.showDamageSelect=function(e){n.searchModule.isShowDamageSelect=!n.searchModule.isShowDamageSelect,n.searchModule.isShowStatusSelect=!1,D(e)},n.searchModule.statusItemClickHandle=function(e,t){if(e.isSelected=!e.isSelected,e.isSelected&&"已撤销"===e.name)n.searchModule.statusOptions.forEach(function(e){e.isSelected=!1}),e.isSelected=!0;else if("已撤销"!==e.name){var r=n.searchModule.statusOptions.zzGetByAttribute("name","已撤销");r[0].isSelected=!1}D(t)},n.searchModule.damageItemClickHandle=function(e){n.searchModule.damaged=e},n.searchModule.cleanDeliveryTime=function(e){n.searchModule.deliveryTimeRange="",D(e)},n.searchModule.cleanPickupTime=function(e){n.searchModule.pickUpTimeRange="",D(e)},n.searchModule.changeLabel=function(e){n.searchModule.currentLabel!==e&&(n.searchModule.currentLabel=e||"assign",n.orders.orderList.pagination.currentPage=1,B())},n.$on(o.onBodyClick,function(){n.searchModule.isShowStatusSelect=!1,n.searchModule.isShowDamageSelect=!1}),n.formatTime=function(e,n,t){return e?new Date(e).Format(n):t},p(function(){var e=l.getUser();e&&e.roles&&e.roles.indexOf("admin")>-1&&(n.orderDetailInfo.isAdmin=!0),f(),B()})}var zhuzhuqs=angular.module("zhuzhuqs",["ngAnimate","ui.router","ngMessages","pasvaz.bindonce","angularytics","LocalStorageModule","daterangepicker","ng-echarts","ae-datetimepicker"]);zhuzhuqs.config(["$stateProvider","$urlRouterProvider",function(e,n){e.state("home",{url:"/",templateUrl:"templates/home.client.view.html",controller:"HomeController"}).state("order_assign",{url:"/order_assign",templateUrl:"templates/order_assign.client.view.html",controller:"OrderAssignController"}).state("order_create",{url:"/order_create/:order/:modify_type/:title",templateUrl:"templates/order_create.client.view.html",controller:"OrderCreateController"}).state("order_batch_create",{url:"/order_batch_create",templateUrl:"templates/order_batch_create.client.view.html",controller:"OrderBatchCreateController"}).state("order_configuration",{url:"/order_configuration",templateUrl:"templates/order_configuration.client.view.html",controller:"OrderConfigurationController"}).state("order_follow",{url:"/order_follow",templateUrl:"templates/order_follow.client.view.html",controller:"OrderFollowController"}).state("map_for_order_trace",{url:"/mapForOrderTrace",templateUrl:"templates/map_for_order_trace.client.view.html",controller:"MapForOrderTraceController"}).state("order_operation",{url:"/order_operation",templateUrl:"templates/order_operation.client.view.html",controller:"OrderOperationController"}).state("order_operation.assign",{url:"/order_operation_assign",templateUrl:"templates/order_assign.client.view.html",controller:"OrderAssignController"}).state("order_operation.follow_onway",{url:"/order_operation_follow_onway",templateUrl:"templates/order_follow.client.view.html",controller:"OrderOperationFollowOnWayController"}).state("order_operation.follow_completed",{url:"/order_operation_follow_completed",templateUrl:"templates/order_follow.client.view.html",controller:"OrderOperationFollowCompletedController"}),n.otherwise("/")}]),zhuzhuqs.config(["AngularyticsProvider",function(e){e.setEventHandlers(["Console","GoogleUniversal"])}]),zhuzhuqs.config(["localStorageServiceProvider",function(e){e.setPrefix("zz")}]),zhuzhuqs.config(["$httpProvider",function(e){e.interceptors.push("PublicInterceptor"),e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var n=function(e){var t,r,o,i,a,s,c,l="";for(t in e)if(r=e[t],r instanceof Array)for(c=0;c<r.length;++c)a=r[c],o=t+"["+c+"]",s={},s[o]=a,l+=n(s)+"&";else if(r instanceof Object)for(i in r)a=r[i],o=t+"["+i+"]",s={},s[o]=a,l+=n(s)+"&";else void 0!==r&&null!==r&&(l+=encodeURIComponent(t)+"="+encodeURIComponent(r)+"&");return l.length?l.substr(0,l.length-1):l};e.defaults.transformRequest=[function(e){return angular.isObject(e)&&"[object File]"!==String(e)?n(e):e}]}]),zhuzhuqs.run(["$rootScope","$state","$location","Auth","User","config","GlobalEvent","$window","dateRangePickerConfig",function(e,n,t,r,o,i,a,s,c){c.separator=" ~ ",c.format="YY/MM/DD HH:mm",e.showLoading=!1,e.showMasking=!1,e.$on(a.onShowLoading,function(n,t){e.showLoading=t}),e.$on(a.onShowMasking,function(n,t){e.showMasking=t}),e.$on("$stateChangeStart",function(e,t,a,s,c){var l=document.getElementById("error3").getAttribute("data-value");""!=l?r.setToken(l):""==r.getToken()&&(e.preventDefault(),window.location=i.login),r.isLoggedIn()||(e.preventDefault(),o.getMe(r.getToken()).then(function(e){if(e.err)return window.location=i.login;r.setUser(e);var t=r.getLatestUrl(),o="home",a="";return t&&"^"!=t&&t.state&&(o=t.state,a=t.params),n.go(o,a)},function(e){alert("系统错误"+JSON.stringify(e))}))});var l=angular.element(s);l.on("beforeunload",function(e){r.setLatestUrl(n.current.name,n.params)})}]),zhuzhuqs.config(function(){window.console||(window.console={log:function(){}})}),zhuzhuqs.constant("config",{serverAddress:"http://"+window.location.host,serverWebAddress:"http://"+window.location.host+"/zzqs2",pushServerAddress:document.getElementById("error4").getAttribute("data-value"),login:"http://"+window.location.host+"/signin",qiniuServerAddress:"http://7xiwrb.com1.z0.glb.clouddn.com/@",maxAddressOffset:1e3}),Date.prototype.Format=function(e){var n={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var t in n)new RegExp("("+t+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?n[t]:("00"+n[t]).substr((""+n[t]).length)));return e},Array.prototype.zzGetByAttribute=function(e,n){for(var t=[],r=0;r<this.length;r++)n===this[r][e]&&t.push(this[r]);return t},angular.module("zhuzhuqs").factory("PublicInterceptor",["Auth",function(e){return{request:function(n){return n.data=n.data?n.data:{},n.data.access_token=e.getToken(),n.params=n.params?n.params:{},n.params.access_token=e.getToken(),n.params.no_cache=(new Date).getTime(),n},response:function(e){return e},requestError:function(e){return e},responseError:function(e){return e}}}]),zhuzhuqs.factory("InformService",["config","InformEnum","CommonSocketService","UserConfigSocketService","AbnormalOrderSocketService",function(e,n,t,r,o){var i={};return i.addCallback=function(e,n){i[e]=n},i.addCallback(n.onAddUser,function(e){i.getAbnormalInforms()}),i}]),zhuzhuqs.factory("AbnormalOrderSocketService",["Auth","CommonSocketService","InformEnum",function(e,n,t){function r(e){o&&(n.receive(o,t.web_abnormal_order_single,e[t.onSingleAbnormalOrder]),n.receive(o,t.web_abnormal_order_batch,e[t.onBatchAbnormalOrder]),n.receive(o,t.web_abnormal_order_clear,e[t.onClearAbnormalOrder]))}var o=null;return{init:function(e,n){o=e,r(n)},getAbnormalInforms:function(){var r=e.getUser().company._id,i=e.getGroups(),a=e.getUser()._id;n.send(o,t.web_abnormal_order_batch,{company_id:r,group_ids:i,user_id:a})},clearAbnormalInforms:function(){var r=e.getUser().company._id,i=e.getGroups(),a=e.getUser()._id;n.send(o,t.web_abnormal_order_clear,{company_id:r,group_ids:i,user_id:a})}}}]),zhuzhuqs.factory("CommonSocketService",function(){return{receive:function(e,n,t){},send:function(e,n,t){console.log("socket send ",n,t)}}}),zhuzhuqs.factory("UserConfigSocketService",["$timeout","InformEnum","Auth","CommonSocketService",function(e,n,t,r){function o(){return s||(s=t.getUser().company),s}function i(e){a&&r.receive(a,n.web_add_user,e[n.onAddUser])}var a,s,c=0;return{init:function(e,n){a=e,i(n)},addUser:function(){console.log("updateUserCount ",++c);var i=this;e(function(){var e=o(),s=t.getGroups();a&&e?r.send(a,n.web_add_user,{company_id:e._id,group_ids:s}):i.addUser()},2e3)}}}]),zhuzhuqs.service("AudioPlayer",["$q",function(e){return function(e,n){var t={unknown:"unknown",loaded:"loaded",playing:"playing",stoped:"stoped",error:"error"};this.duration=0,this.currentTime=0,this.status=t.unknown;var r=this,o=null;window.Audio?(o=new Audio,o.addEventListener("error",function(){r.status=t.error,n&&n("error",r.status)}),o.addEventListener("canplaythrough",function(){r.status=t.loaded,o.duration&&(r.duration=Math.ceil(o.duration)),n&&n("loaded",r.status)}),o.addEventListener("ended",function(){o.currentTime=0,r.status=t.stoped,n&&n("ended",r.status)})):(r.status=t.error,n&&n("error",r.status)),this.setVolume=function(e){r.status!==t.error&&r.status!==t.unknown&&(e<0&&(e=0),e>1&&(e=1),o.volume=e)},this.play=function(){r.status!==t.error&&r.status!==t.unknown&&(r.status!==t.playing&&o.play(),r.status=t.playing,n("playing",t.playing))},this.stop=function(){r.status!==t.error&&r.status!==t.unknown&&(r.status!==t.stoped&&(o.pause(),o.currentTime=0),r.status=t.stoped)},this.close=function(){o&&(o.pause(),o=null,r.status=t.unknown)},setTimeout(function(){o&&(o.src=e)},1)}}]),zhuzhuqs.factory("Auth",["localStorageService","$rootScope","GlobalEvent",function(e,n,t){var r=null,o=null,i=[],a="",s=[];return{isAuthorized:function(e){for(var n=!1,t=0;t<r.roles.length;t++)if(r.roles[t]>=e){n=!0;break}return n},isLoggedIn:function(){return!!r},getUser:function(){return r},setUser:function(e){r=e,n.$broadcast(t.onUserReseted)},getCompany:function(){return o},setCompany:function(e){r.company||(r.company=e),o=e},getGroups:function(){return 0===i.length&&r&&r.executeGroups&&(i=r.executeGroups.map(function(e){return e.group._id})),i},getToken:function(){if(""==a){var n=e.get("token");n&&""!=n&&"<%=  test %>"!=n?a=n:(e.set("token",""),a="")}return a},setToken:function(n){a=n,e.set("token",a)},getLatestUrl:function(){return e.get(r.username+"state")||""},setLatestUrl:function(n,t){r&&e.set(r.username+"state",{state:n,params:t})},logout:function(){n.user=null,r=null},onUserUpdatedCallback:function(e,n){for(var t=0;t<s.length;t++)if(s[t].state===n)return;s.push({callback:e,state:n})},userUpdatedCallback:function(){s.forEach(function(e){e.callback(r)})}}}]),zhuzhuqs.factory("BidderService",["config","HttpService",function(e,n){return{getDetailList:function(){return n.getDataFromServer(e.serverAddress+"/bidder/list/all/detail")},inviteBidderByPhone:function(t){return n.postDataToServer(e.serverAddress+"/bidder/invite",t)},removeCompanyBidder:function(t){return n.postDataToServer(e.serverAddress+"/bidder/remove-company-bidder",t)}}}]),zhuzhuqs.factory("BMapService",["$http","$q","config",function(e,n,t){return{create:function(e,n,t,r){var o=new BMap.Map(e);return o.centerAndZoom(n,t),o.addControl(new BMap.MapTypeControl),o.enableScrollWheelZoom(r),console.log(o),o},drawLine:function(e,n,t,r){var o=[],i=[];n.forEach(function(e){if(e.location[0]!=Number.MIN_VALUE&&e.location[1]!=Number.MIN_VALUE){var n=new Date(e.time);t.time<n&&(t.trace=e,t.time=n),0!=e.location[0]&&0!=e.location[1]&&("gps"==e.type&&i.push(new BMap.Point(e.location[0],e.location[1])),o.push(new BMap.Point(e.location[0],e.location[1])))}});var a;return a=r?new BMap.Polyline(i,{strokeColor:"blue",strokeWeight:2,strokeOpacity:.5}):new BMap.Polyline(o,{strokeColor:"blue",strokeWeight:2,strokeOpacity:.5}),e.addOverlay(a),{points:o,gpsCount:i.length,ungpsCount:o.length-i.length}},drawDriverEvent:function(e,n,r){if("confirm"!==n.type){console.log(n,"event===========");var o={},i=new BMap.Size(42,33),a=new BMap.Size(14,33);switch(n.type){case"pickup":o=new BMap.Icon(t.serverWebAddress+"/images/icon/order_follow/map_pickup.png",i,{anchor:a});break;case"delivery":o=new BMap.Icon(t.serverWebAddress+"/images/icon/order_follow/map_delivery.png",i,{anchor:a});break;case"pickupSign":case"deliverySign":o=new BMap.Icon(t.serverWebAddress+"/images/icon/order_follow/map_sign.png",i,{anchor:a});break;case"halfway":o=new BMap.Icon(t.serverWebAddress+"/images/icon/order_follow/map_halfway.png",i,{anchor:a})}if(n.location[0]&&n.location[1]){var s=new BMap.Marker(new BMap.Point(n.location[0],n.location[1]),{icon:o});e.addOverlay(s),console.log(s,"marker=======");var c=new BMap.InfoWindow(r);s.addEventListener("click",function(){this.openInfoWindow(c)})}}},drawCircle:function(e,n){var r=[];if(n&&n.length>0)return n.forEach(function(n){var o=new BMap.Point(n.point[1],n.point[0]),i=new BMap.Circle(o,t.maxAddressOffset,{fillColor:"#ffa81a",strokeColor:"#265f00",strokeWeight:2,fillOpacity:.6,strokeOpacity:1});e.addOverlay(i);var a=new BMap.Marker(o);e.addOverlay(a);var s=("pickup"===n.type?"提货":"交货")+"地址范围("+n.address+")",c=new BMap.Label(s,{offset:new BMap.Size(20,(-10))});c.setStyle({whiteSpace:"normal",maxWidth:"none",width:"160px",opacity:.9}),a.setLabel(c),r.push(o)}),r}}}]),zhuzhuqs.factory("ChartsService",["$http","$q","config",function(e,n,t){return{getChart1Data:function(r){return n(function(n,o){e.get(t.serverAddress+"/charts/chart1-data",{params:r}).success(function(e){n(e)}).error(function(e){o(e)})})},getChart2Data:function(r){return n(function(n,o){e.get(t.serverAddress+"/charts/chart2-data",{params:r}).success(function(e){n(e)}).error(function(e){o(e)})})},getChart3Data:function(r){return n(function(n,o){e.get(t.serverAddress+"/charts/chart3-data",{params:r}).success(function(e){n(e)}).error(function(e){o(e)})})},getChart4Data:function(r){return n(function(n,o){e.post(t.serverAddress+"/charts/chart4-data",r).success(function(e){n(e)}).error(function(e){o(e)})})}}}]),zhuzhuqs.factory("CompanyService",["$http","$q","config",function(e,n,t){return{createCompany:function(r){var o=n.defer();return e.post(t.serverAddress+"/company",r).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},createGroup:function(r,o){var i=n.defer();return e.post(t.serverAddress+"/group",{company_id:r,name:o}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},getViewGroupList:function(){var r=n.defer();return e.get(t.serverAddress+"/group").success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},getExecuteGroupList:function(){var r=n.defer();return e.get(t.serverAddress+"/group/execute").success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},getUsersOfGroup:function(r){var o=n.defer();return e.get(t.serverAddress+"/group/employees",{params:{group_id:r}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},addUserToGroup:function(r,o,i){var a=n.defer();return e.post(t.serverAddress+"/group/invite/employee",{group_id:r,company_id:o,email:i}).success(function(e){a.resolve(e)}).error(function(e){a.reject(e)}),a.promise},addUsersToGroup:function(e,n,t){var r={usernames:e,company_id:n,group_id:t};return this.postDataToServer("/group/invite/multiemployee",r)},getPartners:function(){var r=n.defer();return e.get(t.serverAddress+"/company/partners").success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},getPartnerCompanys:function(){var r=n.defer();return e.get(t.serverAddress+"/company/company").success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},getPartnerDrivers:function(){var r=n.defer();return e.get(t.serverAddress+"/company/driver").success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},getCompanyCustomers:function(r){var o=n.defer();return e.get(t.serverAddress+"/customer_contact/user").success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getCompanyCustomersByFilter:function(r){var o=n.defer();return e.get(t.serverAddress+"/customer_contact/filter",{params:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getContactsByFilter:function(r){var o=n.defer();return e.get(t.serverAddress+"/company/contact/keyword",{params:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},batchInviteCompany:function(e){return this.postDataToServer(t.serverAddress+"/company/invite/batch",{company_infos:e})},inviteCompanyByName:function(r){var o=n.defer();return e.post(t.serverAddress+"/company/invitebycompanyname",{company_name:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},inviteCompanyByEmail:function(r){var o=n.defer();return e.post(t.serverAddress+"/company/invitebyusername",{username:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},inviteDriverByPhone:function(r){var o=n.defer();return e.post(t.serverAddress+"/driver/invite",{username:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},inviteDriverByPhone1:function(r){var o=n.defer();return e.post(t.serverAddress+"/driver/invite1",{username:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getMatchCompanies:function(r){var o=n.defer();return e.post(t.serverAddress+"/company/matchname",{companyNameSegment:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},deleteGroup:function(r){var o=n.defer();return e.post(t.serverAddress+"/group/delete/user_group",{group_id:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},deleteUserFromGroup:function(r,o){var i=n.defer();return e.post(t.serverAddress+"/group/delete/group_user",{group_id:r,group_user_id:o}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},deleteInviteDriver:function(e){return this.postDataToServer(t.serverAddress+"/company/invite_driver/delete",{driver_phone:e})},deleteCorporateDriver:function(e){return this.postDataToServer(t.serverAddress+"/company/corporate_driver/delete",{driver_id:e})},deleteInviteCompanyById:function(e){return this.postDataToServer(t.serverAddress+"/company/invite_company/delete/id",{invite_id:e})},deleteCorporateCompany:function(e){return this.postDataToServer(t.serverAddress+"/company/corporate_company/delete",{partner_id:e})},updateCompanyInfo:function(e){return this.postDataToServer(t.serverAddress+"/company/update",{address:e.address,type:e.type,name:e.name,employees:e.employees,contact_name:e.contact_name,contact_phone:e.contact_phone,business_license:e.business_license})},removeAddressById:function(e){return this.getDataFromServer(t.serverAddress+"/company/address/remove/id",e)},getAddressList:function(e){return this.getDataFromServer(t.serverAddress+"/company/address/list",e)},batchCreateAddress:function(e){return this.postDataToServer(t.serverAddress+"/company/address/create/batch",e)},createAddress:function(e){return this.postDataToServer(t.serverAddress+"/company/address/create/single",e)},updateAddress:function(e){return this.postDataToServer(t.serverAddress+"/company/address/update",e)},captureAddress:function(e){return this.postDataToServer(t.serverAddress+"/company/address/capture",e)},removeVehicleById:function(e){return this.getDataFromServer(t.serverAddress+"/company/vehicle/remove/id",e)},getVehicleList:function(e){return this.getDataFromServer(t.serverAddress+"/company/vehicle/list",e)},batchCreateVehicle:function(e){return this.postDataToServer(t.serverAddress+"/company/vehicle/create/batch",e)},createVehicle:function(e){return this.postDataToServer(t.serverAddress+"/company/vehicle/create/single",e)},updateVehicle:function(e){return this.postDataToServer(t.serverAddress+"/company/vehicle/update",e)},getConfiguration:function(e){return this.getDataFromServer(t.serverAddress+"/company/configuration/read",e)},updateOrderConfiguration:function(e){return this.postDataToServer(t.serverAddress+"/company/configuration/order/update",e)},updatePushConfiguration:function(e){return this.postDataToServer(t.serverAddress+"/company/configuration/push/update",e)},getDataFromServer:function(t,r){var o=n.defer();return e.get(t,{params:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},postDataToServer:function(t,r){var o=n.defer();return e.post(t,r).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},findDriverEvaluations:function(r){return n(function(n,o){e.get(t.serverAddress+"/company/find-driver-evaluations",{params:r}).success(function(e){n(e)}).error(function(e){o(e)})})}}}]),zhuzhuqs.factory("DashboardService",["$http","$q","config","HttpService",function(e,n,t,r){return{sortByOrderCount:function(e,n,o,i){return r.getDataFromServer(t.serverAddress+"/dashboard/sortbyordercount",{days:e,my_role:n,view_role:o,view_role_company_name:i})},getOrderRate:function(e,n,o,i){return r.getDataFromServer(t.serverAddress+"/dashboard/perfectratebycompany",{days:e,my_role:n,view_role:o,view_role_company_name:i})}}}]),zhuzhuqs.factory("ExcelReaderService",function(){var activeXReader={getWorkSheet:function(e,n){var t=document.getElementById("filename");t.select(),t.blur();var r=document.selection.createRange().text,o=r.substring(r.lastIndexOf(".")+1).toLowerCase();if("xls"!==o&&"xlsx"!=o)return n({type:"file_type_error",message:"选择的文件不是Excel文件"});var i=new ActiveXObject("Excel.Application"),a=(i.Workbooks.open(r),i.Worksheets("Sheet1"));return console.log(a.UsedRange.Rows.Count),console.log(a.UsedRange.Columns.Count),n(null,a)},checkHeader:function(e,n,t){if(!e)return t(!1);for(var r=0;r<n.length;r++)if(e.Cells(1,r+1).Value!==n[r].value)return t(!1);return t(!0)},isHeaderNameExist:function(e,n){return!!e&&e.Cells(1,n.index+1).Value===n.value},getSheetData:function(e,n,t){for(var r,o,i=[],a=e.UsedRange.Columns.Count,s=2;s<a;s++){r={},o=!1;for(var c=0;c<n.length;c++)void 0!=e.Cells(s,c+1).Value&&(r[n[c]]=e.Cells(s,c+1).Value,o=!0);o&&i.push(r)}return 0===i.length?t({type:"file_content_empty",message:"表格中没有数据"}):t(null,i)}},otherReader={getWorkSheet:function(e,n){var t=e.files[0],r=t.name.substring(t.name.lastIndexOf(".")+1).toLowerCase();if("xls"!==r&&"xlsx"!==r)return n({type:"file_type_error",message:"选择的文件不是Excel文件"});var o=new FileReader;o.onload=function(e){var t,r=!1;try{var i="";if(o.readAsBinaryString)i=e.target.result;else for(var a=new Uint8Array(e.target.result),s=a.byteLength,c=0;c<s;c++)i+=String.fromCharCode(a[c]);if(t=XLSX.read(i,{type:"binary"}),t.SheetNames.length<=0)return n({type:"file_content_empty",message:"表格中没有数据"})}catch(l){r=!0}return r?n({type:"file_parse_error",message:"Excel文件解析失败"}):n(null,t)},o.readAsBinaryString?o.readAsBinaryString(t):o.readAsArrayBuffer(t)},checkHeader:function(workbook,headers,callback){var excelSheet=workbook.Sheets.Sheet1;if(!excelSheet)return callback(!1);for(var index=0;index<headers.length;index++){var column="excelSheet."+headers[index].key;if(!eval(column))return callback(!1);var columnName=column+".v";if(eval(columnName)!==headers[index].value)return callback(!1)}return callback(!0)},isHeaderNameExist:function(workbook,headerColumn){var excelSheet=workbook.Sheets.Sheet1;if(!excelSheet)return!1;var column="excelSheet."+headerColumn.key;if(eval(column)){var columnName=column+".v";if(eval(columnName)===headerColumn.value)return!0}return!1},getSheetData:function(e,n,t){var r=e.SheetNames[0],o=XLSX.utils.sheet_to_row_object_array(e.Sheets[r]);return!o||o.length<=0?t({type:"file_content_empty",message:"表格中没有数据"}):t(null,o)}};return{getReader:function(){return"undefined"==typeof FileReader?activeXReader:otherReader},splitArray:function(e,n){for(var t=[],r=0;r<e.length;){var o=e.slice(r,r+n);t.push(o),r+=n}return t}}}),zhuzhuqs.factory("HomeService",["Auth","OrderService",function(e,n){function t(e){var n=!0,t=null;return"home"!=e&&a.forEach(function(r){for(var o=0,i=r.handle.length;o<i;o++)for(var a=0,s=r.handle[o],c=s.length;a<c;a++){var l=s[a];n&&l.state===e&&(n=!1,t=l)}}),t}function r(e){for(var n=[],r=e.split("."),i="",a=0;a<r.length;a++)if(0===a){i=r[a];var s=t(i);s&&n.push(o(s))}else a<r.length-1&&(i+="."+r[a],n[a-1].viewSubHandle.forEach(function(e){e.state===i&&n.push(o(e))}));return n}function o(e){var n={};for(var t in e)n[t]="object"==typeof e[t]?o(e[t]):e[t];return n}var i=[],a=[{title:"任务分配",subtitle:"正在等待分配的运单数量",logo:"images/icon/icon_distribution.png",role:"user",handle:[[{label:"运单操作",type:"link",state:"order_operation",url:"/order_operation"}]]},{title:"招标平台",subtitle:"招标平台",logo:"images/icon/icon_business.png",role:"user",handle:[[{label:"创建标书",type:"external_link",server:"tender",port:3006,state:"tender_create/",url:"/tender_create"},{label:"招标信息",type:"external_link",server:"tender",port:3006,state:"tender_follow",url:"/tender_follow"}]]}];return{updatePanelItemsFromLocal:function(e){a.forEach(function(n){for(var t=0,r=n.handle.length;t<r;t++)for(var o=0,i=n.handle[t],a=i.length;o<a;o++){var s=i[o];s.state===e&&s.topTip&&s.topTip>0&&s.topTip--}})},updatePanelItemsFromServer:function(){a.forEach(function(e){for(var n=0,t=e.handle.length;n<t;n++)for(var r=0,o=e.handle[n],i=o.length;r<i;r++){var a=o[r];a.updateTopTip&&a.updateTopTip()}})},getPanelItems:function(){return a},setviewSubHandle:function(e){i=e},getviewSubHandle:function(){var n=[];if(i.length>0)n=i;else{var t=e.getLatestUrl(),o=[];t&&t.state&&(o=r(t.state)?r(t.state):[]);var a=o[o.length-1];a&&a.viewSubHandle&&(n=a.viewSubHandle)}return n},getObjByHandelUrl:t,getCurrentNavList:r}}]),zhuzhuqs.factory("HttpService",["$http","$q",function(e,n){return{getDataFromServer:function(t,r){var o=n.defer();return e.get(t,{params:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},postDataToServer:function(t,r){var o=n.defer();return e.post(t,r).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise}}}]),zhuzhuqs.factory("InsuranceService",["$http","$q","config",function(e,n,t){return{sendReportEmail:function(e){return this.getDataFromServer(t.serverAddress+"/insurance/report_email",e)},getInsuranceOrders:function(e){return this.postDataFromServer(t.serverAddress+"/insurance",e)},ensureInsurance:function(e,n,r,o,i,a,s,c,l,u,d,p){return this.postDataFromServer(t.serverAddress+"/insurance/ensure",{sender_name:n,goods_name:r,count:o,weight:i,volume:a,count_unit:s,weight_unit:c,volume_unit:l,buy_count:u,pickup_address:d,delivery_address:p,order_id:e})},cancelInsurance:function(e){return this.postDataFromServer(t.serverAddress+"/insurance/cancel",{order_id:e})},getUnpayInsurancePrice:function(){return this.getDataFromServer(t.serverAddress+"/insurance/unpay/info")},buyInsuranceFromPayment:function(e,n,r,o){return this.postDataFromServer(t.serverAddress+"/insurance/buy",{order_ids:e,buy_count:n,coverage_total:r,price_total:o})},getUnpayInsuranceOrders:function(){return this.getDataFromServer(t.serverAddress+"/insurance/unpay/orders")},getInsurancePaymentHistory:function(){return this.getDataFromServer(t.serverAddress+"/insurance/buy/history")},getDataFromServer:function(t,r){var o=n.defer();return e.get(t,{params:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},postDataFromServer:function(t,r){var o=n.defer();return e.post(t,r).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise}}}]),zhuzhuqs.factory("OnlineReportConfigService",["$http","$q","config",function(e,n,t){return{getReportConfig:function(){var r=n.defer();e.post(t.serverAddress+"/report/config/getReportConfig",null).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)});var o=r.promise;return o},getOrderExportReportConfig:function(){var r=n.defer();e.post(t.serverAddress+"/report/config/getOrderExportReportConfig",null).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)});var o=r.promise;return o},saveOrUpdate:function(r){var o=n.defer();e.post(t.serverAddress+"/report/config/update",{config:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)});var i=o.promise;return i},saveOrUpdateOrderExportFields:function(r){var o=n.defer();e.post(t.serverAddress+"/report/config/updateExportFields",{config:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)});var i=o.promise;return i}}}]),zhuzhuqs.factory("OrderHelper",["config",function(e){function n(e){var n="";return e.goods&&e.goods.length>0?(e.goods.forEach(function(e){n+=(e.name||"未知")+","}),n=n.substr(0,n.length-1)):n=e.goods_name||"未知",n}function t(e){var n="";return n+=(e.count?e.count:"未填")+"/",n+=(e.weight?e.weight:"未填")+"/",n+=e.volume?e.volume:"未填"}function r(e){var n="";return e.goods&&e.goods.length>0?(e.goods.forEach(function(e){n+=o(e)+","}),n=n.substr(0,n.length-1)):n=t(e),n}function o(e){if(!e)return"未知数量";var n="";return e.count&&(n+=myFixed(e.count)+e.unit),e.count2&&(n+="/",n+=myFixed(e.count2)+e.unit2),e.count3&&(n+="/",n+=myFixed(e.count3)+e.unit3),n=n||"未知数量",0===n.indexOf("/")&&(n=n.substring(1)),n}function i(e){return{key:e.partner._id?e.partner._id:e.company._id,value:e.partner.name?e.partner.name:e.company.name,authed:e.partner.auth_status?"authed"===e.partner.auth_status:"authed"===e.company.auth_status,group_type:"company"}}function a(e,n){return e.nickname||(e.wechat_profile?e.wechat_profile.nickname:"")||n}function s(e,n){return{key:e._id,value:a(e,"匿名")+"("+e.all_count.orderCount+"单)/"+(e.plate_numbers.length>0?e.plate_numbers[0]:"未知车牌")+"/"+e.username,goodEvaluation:e.goodEvaluation,group_type:n}}function c(e,n){var t=s(e,n);return delete t.goodEvaluation,t.value="(微信)"+t.value,t.is_wechat=!0,t}return{getGoodsNameString:n,getCountDetail:r,getSingleCountDetail:o,getOrderCountVolumeWeight:t,getCompanyAssignOption:i,getDriverAssignOption:s,getWechatDriverAssignOption:c}}]),zhuzhuqs.factory("OrderService",["$http","$q","config","HttpService",function(e,n,t,r){return{createOrder:function(r,o){var i=n.defer();return e.post(t.serverAddress+"/order",{order:r,group_id:o}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},updateUnAssignedOrder:function(r,o){var i=n.defer();return e.post(t.serverAddress+"/order/update",{order:r,group_id:o}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},deleteUnAssignedOrder:function(r){var o=n.defer();return e.post(t.serverAddress+"/order/delete",{order_id:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},updateAssignedOrder:function(r,o){var i=n.defer();return e.post(t.serverAddress+"/order/assignedorder/update",{order:r,group_id:o}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e);
}),i.promise},deleteAssignedOrder:function(r){var o=n.defer();return e.post(t.serverAddress+"/order/assignedorder/delete",{order_id:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},batchDeleteOrders:function(r){var o=n.defer();return e.post(t.serverAddress+"/order/batchdelete",{order_ids:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},batchCreate:function(e,n){return r.postDataToServer(t.serverAddress+"/order/batchcreate",{infos:e,group_id:n})},exportOrderPdf:function(e){window.open(t.serverAddress+"/resources/pdf_templates/pdf?order_id="+e)},exportOrder:function(r){var o=n.defer();return e.get(t.serverAddress+"/order/export",{params:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},assignOrder:function(r){var o=n.defer();return e.post(t.serverAddress+"/order/multiassign",r).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},batchAssign:function(r){var o=n.defer();return e.post(t.serverAddress+"/order/batchassign",{assignInfo:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},continueAssignOrder:function(r){var o=n.defer();return e.post(t.serverAddress+"/order/continueassign",r).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getUnsignedOrder:function(r,o,i,a,s){var c=n.defer();return e.post(t.serverAddress+"/order/unassigned",{currentPage:r,limit:o,sortName:i,sortValue:a,searchArray:s}).success(function(e){c.resolve(e)}).error(function(e){c.reject(e)}),c.promise},getAllOrders:function(r,o,i,a,s){var c=n.defer();return e.post(t.serverAddress+"/order/all",{currentPage:r,limit:o,sortName:i,sortValue:a,searchArray:s}).success(function(e){c.resolve(e)}).error(function(e){c.reject(e)}),c.promise},getAbnormalOrders:function(r,o,i,a,s){var c=n.defer();return e.post(t.serverAddress+"/order/abnormal",{currentPage:r,limit:o,sortName:i,sortValue:a,searchArray:s}).success(function(e){c.resolve(e)}).error(function(e){c.reject(e)}),c.promise},getAbnormalOrderCount:function(){var r=n.defer();return e.get(t.serverAddress+"/order/abnormal/count").success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},getOrders:function(r,o,i,a,s,c){var l=n.defer();return e.get(t.serverAddress+"/order",{params:{currentPage:r,limit:o,sortName:i,sortValue:a,searchName:s,searchValue:c}}).success(function(e){l.resolve(e)}).error(function(e){l.reject(e)}),l.promise},getAssignedOrderDetail:function(r,o){var i=n.defer();return e.get(t.serverAddress+"/order/assignedOrderDetail",{params:{order_id:r,viewer:o}}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},getOrderById:function(r){var o=n.defer();return e.get(t.serverAddress+"/order/detail",{params:{order_id:r}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getEventsByOrderId:function(r,o){var i=n.defer();return e.get(t.serverAddress+"/transport_event",{params:{order_id:r,viewer:o}}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},getTracesByOrderId:function(r,o){var i=n.defer();return e.get(t.serverAddress+"/trace",{params:{order_id:r,viewer:o}}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},shareOrders:function(r,o,i){var a=n.defer();return e.post(t.serverAddress+"/order/share",{order_ids:r,recipients:o,isInputEmail:i}).success(function(e){a.resolve(e)}).error(function(e){a.reject(e)}),a.promise},getCooperateCompanys:function(){var r=n.defer();return e.get(t.serverAddress+"/company/partnercompanystaff").success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},getRemainOrderCreateCount:function(){var r=n.defer();return e.get(t.serverAddress+"/order/remainOrderCreateCount").success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},getDriverOrders:function(r){var o=n.defer();return e.get(t.serverAddress+"/map/alldriverorders",{params:{showNumber:r}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getStatusString:function(e){var n="";switch(e){case"unAssigned":n="未分配";break;case"assigning":n="分配中";break;case"unPickupSigned":case"unPickuped":n="未提货";break;case"unDeliverySigned":case"unDeliveried":n="未交货";break;case"pickupSign":n="提货签到";break;case"pickup":n="提货";break;case"deliverySign":n="交货签到";break;case"delivery":n="交货";break;case"halfway":n="中途事件";break;case"completed":n="已完成"}return n},getSharedOrders:function(r,o){var i=n.defer();return e.get(t.serverAddress+"/order/sharedorderlist",{params:{currentPage:r,limit:o}}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},getSharedOrderEventById:function(r){var o=n.defer();return e.get(t.serverAddress+"/transport_event/sharedorderevent",{params:{order_id:r}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getSharedOrderAssignInfo:function(r){var o=n.defer();return e.get(t.serverAddress+"/order/sharedorderassigninfo",{params:{order_id:r}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getSharedOrderTracesByOrderId:function(r){var o=n.defer();return e.get(t.serverAddress+"/trace/sharedOrderTrace",{params:{order_id:r}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},updateOrderAssign:function(r,o){var i=n.defer();return e.post(t.serverAddress+"/order/update/assigninfo",{order_id:r,assign_infos:o}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},handleAbnormalOrder:function(r){var o=n.defer();return e.get(t.serverAddress+"/order/abnormal/handle",{params:{order_id:r}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getOperationOrderCount:function(){return r.getDataFromServer(t.serverAddress+"/order/operation/count")},getSenderPickupAddressList:function(r,o){var i=n.defer();return e.get(t.serverAddress+"/order/pickup_address/get",{params:{sender_name:r,pickup_address:o}}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise}}}]),zhuzhuqs.factory("PhotoSearchService",["$http","$q","config",function(e,n,t){return{getPhotos:function(r){var o=n.defer();return e.get(t.serverAddress+"/photoSearch",{params:{filter:r}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(err)}),o.promise}}}]),zhuzhuqs.factory("SalesmanService",["config","HttpService",function(e,n){return{getDetailList:function(){return n.getDataFromServer(e.serverAddress+"/salesman/list/all/detail")},getBasicList:function(){return n.getDataFromServer(e.serverAddress+"/salesman/list/all/basic")},removeSalesmanCompanyById:function(t){var r={salesman_company_id:t};return n.getDataFromServer(e.serverAddress+"/salesman_company/remove/id",r)},removeSalesmanCompanyByUsername:function(t){var r={username:t};return n.getDataFromServer(e.serverAddress+"/salesman_company/remove/username",r)},create:function(t){return n.postDataToServer(e.serverAddress+"/salesman/create",t)},batchCreate:function(t){return n.postDataToServer(e.serverAddress+"/salesman/batchcreate",t)},update:function(t){return n.postDataToServer(e.serverAddress+"/salesman/update",t)}}}]),zhuzhuqs.factory("User",["$http","$q","config",function(e,n,t){return{getMe:function(){var r=n.defer();return e({method:"POST",url:t.serverAddress+"/user/me",params:{}}).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},updateProfile:function(r){var o=n.defer();return e.post(t.serverAddress+"/user/profile",{profile:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise}}}]),zhuzhuqs.factory("UserProfileService",["$http","$q","config",function(e,n,t){return{getUserProfile:function(){return this.getDataFromServer("/userprofile")},setFollowCustomizeColumns:function(e){return this.postDataToServer("/customizecolumnsfollow",{customize_columns_follow:e})},setAssignCustomizeColumns:function(e){return this.postDataToServer("/customizecolumnsassign",{customize_columns_assign:e})},setMaxPageCount:function(e){return this.getDataFromServer("/userprofile/max_page_count",e)},getDataFromServer:function(t,r){var o=n.defer();return r?e.get(t,{params:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}):e.get(t).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},postDataToServer:function(t,r){var o=n.defer();return e.post(t,r).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise}}}]),zhuzhuqs.constant("InformEnum",{web_socket_connection_success:"/socket/web/connection/success",web_abnormal_order_single:"/socket/web/abnormal_order/single",web_add_user:"/socket/web/user/add",web_abnormal_order_batch:"/socket/web/abnormal_order/batch",web_abnormal_order_clear:"/socket/web/abnormal_order/clear",onAddUser:"onAddUser",onSingleAbnormalOrder:"onSingleAbnormalOrder",onBatchAbnormalOrder:"onBatchAbnormalOrder"}),zhuzhuqs.constant("CompanyError",{only_one_company:"公司名称必须唯一",company_name_exists:"公司名称已存在",name_null:"icon/icon_new.png",internal_system_error:"系统错误",company_not_exist:"公司名不存在",company_name_invalid:"公司名非法",has_been_partner:"已经是合作伙伴",invited_user_not_exist:"对方不存在",company_invite_itself:"不能邀请自己成合作伙伴",invalid_email:"邮箱格式错误，正确格式 xx@xx.com",email_sent_failed:"邮件发送失败",user_not_in_company:"当前用户不存在公司",vehicle_exist:"该车牌车辆已经存在",vehicle_not_exist:"该车牌车辆不存在",address_not_exist:"该地址不存在"}),zhuzhuqs.constant("DriverError",{account_not_exist:"司机账户不存在",account_exist:"司机已存在",account_not_match:"账户不匹配",internal_system_error:"系统错误",invalid_phone:"手机号格式错误 必须是11位数字",invalid_password:"密码错误",email_failed:"邮箱错误",invite_user_not_exist:"邀请的账户不存在",invalid_verify_code:"验证码错误",sms_send_error:"邮件发送失败",sms_send_limit_error:"短信发送已受限制",partner_not_exist:"伙伴不存在",inviting_company_not_exist:"公司不存在",has_been_invited:"不能重复邀请",has_been_partner:"已经是合作司机",salesman_has_existed:"关注人已经存在",invite_sms_error:"邮件发送错误"}),zhuzhuqs.constant("DriverPartnerError",{internal_system_error:"系统错误",driver_has_accepted_partner:"已接受",driver_has_confused_partner:"已拒绝",uninvited_partner:"uninvited_partner",has_been_done:"has_been_done"}),zhuzhuqs.constant("GroupError",{name_null:"用户为空",invalid_company_id:"公司ID错误",group_not_exist:"组不存在",internal_system_error:"系统错误！请联系管理员",group_exist:"您新输入的组名已存在，换个新的吧",user_not_exist:"用户不存在",not_in_company:"用户不在该公司",invalid_email:"邮箱格式错误，例:xx@xx.com",user_in_other_company:"对不起，该同事已被加入到别的公司",user_exist_in_group:"对不起，该同事已存在该组",user_not_exist_in_group:"用户不在该组中",post_data_empty:"上传的数据为空",params_null:"方法的参数为空",forbid_delete_default_group:"默认组不能删除"}),zhuzhuqs.constant("OrderError",{internal_system_error:"系统错误",order_not_exist:"订单不存在",order_number_null_error:"订单号为空",order_number_unique_error:"订单号不唯一",incomplete_pickup_contact_info:"",incomplete_delivery_contact_info:"",group_id_null:"组ID为空",driver_not_exist:"司机不存在",company_not_exist:"公司不存在",order_has_assigned:"订单已分配",order_not_assigning:"order_not_assigning",order_not_visible:"订单不可见",assign_infos_null:"分配信息为空",order_info_null:"订单信息为空",orders_to_share_null:"没有指定分享订单",recipients_to_share_null:"没有指定分享收件人",recipients_to_share_invalid:"分享收件人不合法",must_self_company_order:"只能操作自己公司的订单",params_null:"服务端参数为空",post_data_empty:"上传的数据有空值",assign_info_can_not_modify:"订单分配信息不能修改",user_not_in_company:"当前用户不存在公司"}),zhuzhuqs.constant("TransportError",{internal_system_error:"系统错误，请联系管理员",order_not_exist:"订单不存在",original_order:"original_order",original_order_not_exist:"",order_driver_not_match:"订单跟司机不匹配",can_not_execute_pickupSign:"",can_not_execute_pickup:"",can_not_execute_deliverySign:"",can_not_execute_delivery:"",order_has_been_complete:"",parent_order_not_exist:"",uncompleted:""}),zhuzhuqs.constant("UserError",{account_not_exist:"账户不存在",account_exist:"账户已存在",account_not_match:"账户不匹配",account_not_activate:"账户未激活",internal_system_error:"系统错误，请联系管理员",invalid_email:"邮箱格式错误，正确格式 xx@xx.com",invalid_password:"错误的密码",invalid_access_token:"错误的token",email_failed:"邮箱错误",invite_user_not_exist:"对方账户不存在",user_not_exist:"用户不存在",external_company_user:"external_company_user",internal_group_user:"internal_group_user"}),zhuzhuqs.constant("GlobalEvent",{onShowLoading:"onShowLoading",onShowMasking:"onShowMasking",onChangeMenu:"onChangeMenu",onShowAlert:"onShowAlert",onShowAlertConfirm:"onShowAlertConfirm",onShowAlertConfirmStyle:"onShowAlertConfirmStyle",onShowAlertPrompt:"onShowAlertPrompt",onShowDevelopmentTips:"onShowDevelopmentTips",onShowExportDialog:"onShowExportDialog",onBodyClick:"onBodyClick",onUpdatePanelLabel:"onUpdatePanelLabel",onUserReseted:"onUserReseted"}),angular.module("zhuzhuqs").controller("AlertController",["$rootScope","$scope","GlobalEvent","$element","$attrs","$transclude",function(e,n,t,r,o,i){n.alertConfig={show:!1,type:"alert",title:"消息",content:"",cancel:"好的",callback:null},e.$on(t.onShowAlert,function(e,t,r){n.alertConfig.content=t,n.alertConfig.show=!0,r&&(n.alertConfig.callback=r)}),n.cancel=function(){if(n.alertConfig.show=!1,n.alertConfig.content="",n.alertConfig.callback){var e=n.alertConfig.callback;return e(),void(n.alertConfig.callback=null)}}}]),angular.module("zhuzhuqs").controller("AlertConfirmController",["$rootScope","$scope","GlobalEvent","$element","$attrs","$transclude",function(e,n,t,r,o,i){n.alertConfig={show:!1,title:"消息",content:"",cancel:"取消",sure:"确认",func:null,param:null},e.$on(t.onShowAlertConfirm,function(e,t,r,o,i){i?(n.alertConfig.title=i.title?i.title:"消息",n.alertConfig.sure=i.sureLabel?i.sureLabel:"确认",n.alertConfig.cancel=i.cancelLabel?i.cancelLabel:"取消"):(n.alertConfig.title="消息",n.alertConfig.sure="确认",n.alertConfig.cancel="取消"),n.alertConfig.content=t,n.alertConfig.show=!0,n.alertConfig.func=r,n.alertConfig.param=o}),n.cancel=function(){n.alertConfig.show=!1,n.alertConfig.content=""},n.sure=function(){n.alertConfig.show=!1,n.alertConfig.content="",n.alertConfig.func&&n.alertConfig.func(n.alertConfig.param)}}]),angular.module("zhuzhuqs").controller("AlertConfirmStyleController",["$rootScope","$scope","GlobalEvent","$element","$attrs","$transclude",function(e,n,t,r,o,i){n.alertConfig={show:!1,title:"消息",content:"",content_one:"",content_two:"",content_three:"",cancel:"取消",sure:"确认",func:null,param:null},e.$on(t.onShowAlertConfirmStyle,function(e,t,r,o,i){i?(n.alertConfig.title=i.title?i.title:"消息",n.alertConfig.sure=i.sureLabel?i.sureLabel:"确认",n.alertConfig.cancel=i.cancelLabel?i.cancelLabel:"取消"):(n.alertConfig.title="消息",n.alertConfig.sure="确认",n.alertConfig.cancel="取消"),n.alertConfig.content_one=t.content_one||"",n.alertConfig.content_two=t.content_two||"",n.alertConfig.content_three=t.content_three||"",n.alertConfig.show=!0,n.alertConfig.func=r,n.alertConfig.param=o}),n.cancel=function(){n.alertConfig.show=!1,n.alertConfig.content=""},n.sure=function(){n.alertConfig.show=!1,n.alertConfig.content="",n.alertConfig.func&&n.alertConfig.func(n.alertConfig.param)}}]),angular.module("zhuzhuqs").controller("AlertPromptController",["$rootScope","$scope","GlobalEvent",function(e,n,t){n.alertConfig={show:!1,title:"消息",tipText:"请设置",placeholderText:"请输入",sure:"好的",inputContent:"",callback:null},e.$on(t.onShowAlertPrompt,function(e,t,r){t.tipText&&(n.alertConfig.tipText=t.tipText),t.placeholderText&&(n.alertConfig.placeholderText=t.placeholderText),t.sure&&(n.alertConfig.sure=t.sure),n.alertConfig.show=!0,r&&(n.alertConfig.callback=r)}),n.sure=function(){if(n.alertConfig.show=!1,n.alertConfig.tipText="请设置",n.alertConfig.placeholderText="请输入",n.alertConfig.sure="好的",n.alertConfig.callback){var e=n.alertConfig.callback,t=n.alertConfig.inputContent;e(t)}n.alertConfig.inputContent="",n.alertConfig.callback=null},n.cancel=function(){n.alertConfig.show=!1,n.alertConfig.tipText="请设置",n.alertConfig.placeholderText="请输入",n.alertConfig.sure="好的",n.alertConfig.inputContent="",n.alertConfig.callback=null}}]),angular.module("zhuzhuqs").controller("BussnessController",["$scope","$stateParams","$timeout","config","CompanyService","SalesmanService","BidderService","ExcelReaderService","CompanyError","DriverError","GlobalEvent","Auth",function(e,n,t,r,o,i,a,s,c,l,u,d){function p(){var e={driverId:P.driverId,currentPage:P.pagination.currentPage,limit:P.pagination.limit};o.findDriverEvaluations(e).then(function(e){if(e&&e.status&&"success"==e.status&&e.data){var n=[];P.rows=n,e.data.forEach(function(e){var t={content_text:e.content_text,update_time_format:e.update_time_format};if(e.order&&e.order.order_details&&(t.order_number=e.order.order_details.order_number),e.user&&e.user.company&&(t.company_name=e.user.company.name),e.level)switch(e.level+""){case"1":t.level="好评";break;case"2":t.level="中评";break;case"3":t.level="差评"}n.push({columns:t,rowConfig:{notOptional:!0,isShowUpdateButton:!1,isShowDeleteButton:!1,isShowExportButton:!1}})}),f(e.pagination),P.reLoad&&P.reLoad(),P.show=!0}},function(e){console.log(e)})}function f(e){e&&(P.pagination.currentPage=parseInt(e.currentPage||1),P.pagination.limit=parseInt(e.limit||10),P.pagination.totalCount=parseInt(e.total||0),P.pagination.pageCount=Math.ceil(parseInt(e.total||0)/parseInt(e.limit||10)),P.pagination.render&&P.pagination.render())}function h(e,n){if(!e)return n();for(var t=[],r=[],o=0;o<e.length;o++){var i=e[o];if(!i[L[0]])return n({row:o+2,column:"A",message:L[0]+"不能为空"});if(t.indexOf(i[L[0]])>-1)return n({row:o+2,column:"A",message:L[0]+"不能重复"});if(t.push(i[L[0]]),i[L[1]]){if(!i[L[1]].testMail())return n({row:o+2,column:"B",message:L[1]+"必须为邮箱格式"});if(r.indexOf(i[L[1]])>-1)return n({row:o+2,column:"B",message:L[1]+"不能重复"});r.push(i[L[1]])}}return n()}function m(e){var n=[];if(!e)return n;for(var t,r={"公司名称":"companyName","电子邮箱":"email"},o=0;o<e.length;o++){var i={};t=e[o];for(var a in t)i[r[a]]=t[a];n.push(i)}return n}function g(n){l[n]?e.$emit(u.onShowAlert,l[n]):e.$emit(u.onShowAlert,n+" 未知错误！请联系管理员")}function v(e){!e||e.length<=0||e.forEach(function(e){var n=e.driver.all_count.evaluationCount,t=n.good+n.general+n.bad;return t<10?void(e.driver.goodEvaluation=0):void(e.driver.goodEvaluation=Math.ceil(100*n.good/t))})}function _(){e.$emit(u.onShowLoading,!0),o.getPartnerDrivers().then(function(n){e.$emit(u.onShowLoading,!1),console.log(n),n.err&&g(n.err.type),v(n.driverCompanys),e.partnersInfo.drivers.driverCompanys=n.driverCompanys,e.partnersInfo.drivers.inviteDrivers=n.inviteDrivers,e.rightHeader.updateCount("driver",e.partnersInfo.drivers.driverCompanys.length+e.partnersInfo.drivers.inviteDrivers.length)},function(e){console.log(data),g("error")})}function y(){e.$emit(u.onShowLoading,!0),i.getDetailList().then(function(n){return e.$emit(u.onShowLoading,!1),console.log(n),n.err?g(n.err.type):(n.length>0&&n.sort(function(e,n){return!(!e&&!n)&&e.nickname.localeCompare(n.nickname)}),e.partnersInfo.salesman=n,void e.rightHeader.updateCount("salesman",e.partnersInfo.salesman.length))},function(n){console.log(n),e.$emit(u.onShowLoading,!1),g("error")})}function S(n){e.$emit(u.onShowLoading,!0),i.create({user_info:n}).then(function(n){return e.$emit(u.onShowLoading,!1),console.log(n),n.err?g(n.err.type):(e.$emit(u.onShowAlert,"创建成功"),void y())},function(n){console.log(n),e.$emit(u.onShowLoading,!1),g("error")})}function w(n){e.$emit(u.onShowLoading,!0),i.update({user_info:n}).then(function(n){return e.$emit(u.onShowLoading,!1),console.log(n),n.err?g(n.err.type):(e.$emit(u.onShowAlert,"修改成功"),void y())},function(n){console.log(n),e.$emit(u.onShowLoading,!1),g("error")})}function k(e,n){if(!e)return n();for(var t=[],r=0;r<e.length;r++){var o=e[r];if(!o[z[0]])return n({row:r+2,column:"A",message:z[0]+"不能为空"});if(o.length<2||!o[z[1]])return n({row:r+2,column:"B",message:z[1]+"不能为空"});if(!o[z[0]].testPhone())return n({row:r+2,column:"A",message:z[0]+"必须为手机号码"});if(t.indexOf(o[z[0]])>-1)return n({row:r+2,column:"A",message:z[0]+"不能重复"});t.push(o[z[0]]);for(var i in o)switch(i){case z[2]:if(o[i]&&!o[i].testMail())return n({row:r+2,column:"C",message:z[2]+"必须为邮箱格式"})}}return n()}function C(e){var n=[];if(!e)return n;for(var t,r={"手机号码":"username","姓名":"nickname","电子邮箱":"email"},o=0;o<e.length;o++){var i={};t=e[o];for(var a in t)i[r[a]]=t[a];n.push(i)}return n}function b(n){return e.$emit(u.onShowAlert,n),e.$emit(u.onShowLoading,!1),e.$apply()}function I(n){c[n]?e.$emit(u.onShowAlert,c[n]):e.$emit(u.onShowAlert,n+" 未知错误！请联系管理员")}function x(n){e.$emit(u.onShowLoading,!1),n.err?I(n.err.type):e.newCompanyInfo.isFinished=!0}function D(n){e.$emit(u.onShowLoading,!1),I("error")}function O(){e.$emit(u.onShowLoading,!0),o.getPartnerCompanys().then(function(n){e.$emit(u.onShowLoading,!1),console.log(n),n.err&&I(n.err.type),n.partnerCompany&&(e.partnersInfo.company.partnerCompanies=n.partnerCompany),n.inviteCompany&&(e.partnersInfo.company.inviteCompanies=n.inviteCompany),e.rightHeader.updateCount("company",e.partnersInfo.company.partnerCompanies.length+e.partnersInfo.company.inviteCompanies.length)},function(e){I("error")})}function A(){e.$emit(u.onShowLoading,!0),a.getDetailList().then(function(n){return e.$emit(u.onShowLoading,!1),n.err?g(n.err.type):(e.partnersInfo.bidders=n,void e.rightHeader.updateCount("bidder",e.partnersInfo.bidders.length))},function(n){console.log(n),e.$emit(u.onShowLoading,!1),g("error")})}e.partnersInfo={drivers:{driverCompanys:[],inviteDrivers:[]},company:{partnerCompanies:[],inviteCompanies:[],handleFile:function(){}},salesman:[],bidders:[],curSelect:n.params||"company",deleteInviteDriver:"",deleteCorporateDriver:"",deleteInviteCompany:"",deleteCorporateCompany:"",showDetailPanel:""},e.maskInfo={isShow:!1},e.newInfo={username:"",showDriverDialog:!1,openDialog:function(){},submit:function(){}},e.rightHeader={company:{name:"合作公司",count:0,columns:[{name:"公司名称",length:4},{name:"公司类型",length:2},{name:"公司地址",length:3}]},driver:{name:"合作司机",count:0,columns:[{name:"姓名",length:2},{name:"好评率",length:1},{name:"运单数",length:1},{name:"拒单数",length:1},{name:"电话",length:2},{name:"车牌",length:2},{name:"绑定微信",length:2},{name:"评价",length:1}]},salesman:{name:"关注人",count:0,columns:[{name:"手机号",length:3},{name:"姓名",length:2},{name:"邮箱",length:3},{name:"绑定时间",length:2}]},bidder:{name:"合作中介",count:0,columns:[{name:"手机号",length:3},{name:"姓名",length:2},{name:"昵称",length:2},{name:"中标次数",length:2},{name:"绑定时间",length:2}]},current:{},update:function(e){this.current=this[e]},updateCount:function(e,n){this[e].count=n}},e.singleSalesman={isModify:!1,username:"",nickname:"",email:"",showDialog:!1,usernameError:"必填项",nicknameError:"必填项",isEmailError:!1,isPhoneError:!1,blurUsername:function(){},blurEmail:function(){},submit:function(){},remove:function(){},modify:function(e){this.showDialog=!0,this.isModify=!0,this.usernameError="",this.copy(e)},create:function(){this.showDialog=!0,this.isModify=!1,this.clear()},clear:function(){this.username="",this.nickname="",this.email="",this.usernameError="必填项",this.nicknameError="必填项"},copy:function(e){this.username=e.username,this.nickname=e.nickname,this.email=e.email},handleFile:function(){}};var P={pagination:{currentPage:1,limit:10,totalCount:0,pageCount:0,pageNavigationCount:5,canSeekPage:!0,limitArray:[10,20,30,40,100],pageList:[1],onCurrentPageChanged:function(e){p()}},isShowPagination:!0,isOptional:!1,isFieldSetting:!1,rows:[],fields:[{name:"运单号",value:"order_number",isSort:!1,isSearch:!1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},{name:"公司名称",value:"company_name",isSort:!1,isSearch:!1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},{name:"评价",value:"content_text",isSearch:!1,curSort:"",keyword:""},{name:"等级",value:"level",isSort:!0,isSearch:!1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},{name:"评价时间",value:"update_time_format",isSort:!0,isSearch:!1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]}],driverId:null,show:!1};e.driverEvaluationsConfig=P,O(),_(),y(),A(),e.showDriver=function(e){e.driver.all_count.evaluationCount&&(P.driverId=e.driver._id,p())},e.exportData=function(){var n={company:"/company/export",salesman:"/salesman/export",driver:"/company/export-company-driver",bidder:"/bidder/export-company-bidder"},t=e.partnersInfo.curSelect;if(n[t]){var r=n[t]+"?access_token="+d.getToken();window.open(r)}},e.generatePhoto=function(e){return e?r.qiniuServerAddress+e:""},e.rightHeader.update(e.partnersInfo.curSelect),e.partnersInfo.deleteInviteDriver=function(n){if(!n)return e.$emit(u.onShowAlert,"请指定要删除的合作司机");var t=/\d{11}/;if(!t.test(n))return console.log(n,"driver phone format is not right"),e.$emit(u.onShowAlert,"司机用户名不合法");var r="确定删除合作司机"+n+"吗？";e.$emit(u.onShowAlertConfirm,r,function(n){e.$emit(u.onShowLoading,!0),o.deleteInviteDriver(n).then(function(n){return e.$emit(u.onShowLoading,!1),n.err?console.log(n.err):(_(),void e.$emit(u.onShowAlert,"删除成功"))},function(n){return e.$emit(u.onShowLoading,!1)})},n,{title:"删除"})},e.partnersInfo.deleteCorporateDriver=function(n){if(!n)return e.$emit(u.onShowAlert,"请指定要删除的合作司机");var t="确定删除合作司机"+(n.nickname?n.nickname:n.username)+"吗？";e.$emit(u.onShowAlertConfirm,t,function(n){e.$emit(u.onShowLoading,!0),o.deleteCorporateDriver(n).then(function(n){return e.$emit(u.onShowLoading,!1),n.err?console.log(n.err):(_(),void e.$emit(u.onShowAlert,"删除成功"))},function(n){return e.$emit(u.onShowLoading,!1)})},n._id,{title:"删除"})},e.partnersInfo.deleteInviteCompany=function(n){if(!n||!n._id)return e.$emit(u.onShowAlert,"请指定要删除的合作公司");var t="确定删除合作公司"+(n.name||n.username)+"吗？";e.$emit(u.onShowAlertConfirm,t,function(){e.$emit(u.onShowLoading,!0),o.deleteInviteCompanyById(n._id).then(function(n){return e.$emit(u.onShowLoading,!1),n.err?console.log(n.err):(O(),void e.$emit(u.onShowAlert,"删除成功"))},function(n){return e.$emit(u.onShowLoading,!1)})},null,{title:"删除"})},e.partnersInfo.deleteCorporateCompany=function(n){if(!n)return e.$emit(u.onShowAlert,"请指定要删除的合作公司");var t="确定删除合作公司"+n.name+"吗？";e.$emit(u.onShowAlertConfirm,t,function(n){e.$emit(u.onShowLoading,!0),o.deleteCorporateCompany(n).then(function(n){return e.$emit(u.onShowLoading,!1),n.err?console.log(n.err):(O(),void e.$emit(u.onShowAlert,"删除成功"))},function(n){return e.$emit(u.onShowLoading,!1)})},n._id,{title:"删除"})},e.partnersInfo.showDetailPanel=function(n){if(n=n||"company",e.partnersInfo.curSelect!==n)switch(e.partnersInfo.curSelect=n,e.rightHeader.update(n),n){case"company":O();break;case"driver":_();break;case"salesman":y();break;case"bidder":A()}};var L=["公司名称","电子邮箱"];e.partnersInfo.company.handleFile=function(n){e.$emit(u.onShowLoading,!0),e.$apply();var t=s.getReader();t.getWorkSheet(n,function(n,r){if(document.getElementById("company-filename").outerHTML=document.getElementById("company-filename").outerHTML,document.getElementById("company-filename").value="",n)return b(n.message);var i=[{key:"A1",value:"公司名称"},{key:"B1",value:"电子邮箱"}];t.checkHeader(r,i,function(n){return n?void t.getSheetData(r,L,function(n,t){return n?b(n.message):void h(t,function(n){if(n)return b("第"+n.row+"行第"+n.column+"列"+n.message);for(var r=m(t),i=s.splitArray(r,30),a=r.length,c=0,l=0,d=0;d<i.length;d++)o.batchInviteCompany(i[d]).then(function(n){if(e.$emit(u.onShowLoading,!1),console.log(n),n.err)return e.$emit(u.onShowAlert,"上传失败");if(c+=n.success.length,l+=n.faileds.length,a===c+l){var t="成功上传"+c+"个公司";l>0&&(t+="，剩余"+l+"个上传失败"),e.$emit(u.onShowAlert,t),O()}})})}):b("请选择系统提供的模版填写合作公司数据")})})},e.newInfo.submit=function(){this.username&&(e.$emit(u.onShowLoading,!0),o.inviteDriverByPhone1(e.newInfo.username).then(function(n){return e.$emit(u.onShowLoading,!1),console.log(n),n.err?g(n.err.type):(e.newInfo.openDialog(!1),void _())},function(e){return console.log(e),g("error")}))},e.newInfo.openDialog=function(n){this.username="",this.showDriverDialog=n,e.maskInfo.isShow=n},e.singleSalesman.blurUsername=function(){return this.username?this.username.testPhone()?this.usernameError="":this.usernameError="格式不正确":this.usernameError="必填项"},e.singleSalesman.blurNickname=function(){return this.nickname?this.nicknameError="":this.nicknameError="必填项"},e.singleSalesman.blurEmail=function(){this.isEmailError=this.email&&!this.email.testMail()},e.singleSalesman.submit=function(){if(!this.usernameError&&!this.nicknameError){if(this.email&&!this.email.testMail())return this.isEmailError=!0;var e={username:this.username,nickname:this.nickname||"",email:this.email||""};this.clear(),this.showDialog=!1,this.isModify?w(e):S(e)}},e.singleSalesman.remove=function(n){if(n){var t="确定删除关注人"+n.username+"吗？";e.$emit(u.onShowAlertConfirm,t,function(){e.$emit(u.onShowLoading,!0),i.removeSalesmanCompanyByUsername(n.username).then(function(n){return e.$emit(u.onShowLoading,!1),console.log(n),n.err?g(n.err.type):(e.$emit(u.onShowAlert,"删除成功"),void y())},function(n){console.log(n),e.$emit(u.onShowLoading,!1),g("error")})})}};var z=["手机号码","姓名","电子邮箱"];e.singleSalesman.handleFile=function(n){e.$emit(u.onShowLoading,!0),e.$apply();var t=s.getReader();t.getWorkSheet(n,function(n,r){if(document.getElementById("salesman-filename").outerHTML=document.getElementById("salesman-filename").outerHTML,document.getElementById("salesman-filename").value="",n)return b(n.message);var o=[{key:"A1",value:"手机号码"},{key:"B1",value:"姓名"},{key:"C1",value:"电子邮箱"}];t.checkHeader(r,o,function(n){return n?void t.getSheetData(r,z,function(n,t){return n?b(n.message):void k(t,function(n){if(n)return b("第"+n.row+"行第"+n.column+"列"+n.message);for(var r=C(t),o=s.splitArray(r,30),a=r.length,c=0,l=0,d=0;d<o.length;d++)i.batchCreate({user_infos:o[d]}).then(function(n){if(c+=n.success.length,l+=n.faileds.length,a===c+l){var t="成功上传"+c+"名关注人";l>0&&(t+="，剩余"+l+"名上传失败"),e.$emit(u.onShowLoading,!1),e.$emit(u.onShowAlert,t),y()}})})}):b("请选择系统提供的模版填写关注人数据")})})},e.newCompanyInfo={isShowDialog:!1,inputValue:"",matchCompanys:[],isFinished:!1,isShowDrop:!1,isAllowQuery:!0,timerPromise:"",finishText:"",clickClosePage:"",clickCompanyItem:"",clickConfirm:"",clickFinish:"",emailReg:/^([a-zA-Z0-9_.-])+@([a-zA-Z0-9_-])+((.[a-zA-Z0-9_-]{2,}){1,2})$/,openDialog:function(){}},e.newCompanyInfo.openDialog=function(){this.isShowDialog=!0,e.maskInfo.isShow=!0},e.newCompanyInfo.clickClosePage=function(){this.isShowDialog=!1,this.inputValue="",this.matchCompanys=[],this.isFinished=!1,this.isShowDialog=!1,this.isAllowQuery=!0,this.timerPromise="",this.finishText="",e.maskInfo.isShow=!1},e.newCompanyInfo.clickFinish=function(){e.newCompanyInfo.clickClosePage(),O()},e.newCompanyInfo.clickCompanyItem=function(n){e.newCompanyInfo.matchCompanys.forEach(function(e){e.isSelected=!1}),n.isSelected=!0,e.newCompanyInfo.inputValue=n.name,e.newCompanyInfo.isShowDrop=!1,t(function(){e.newCompanyInfo.timerPromise&&(t.cancel(e.newCompanyInfo.timerPromise),e.newCompanyInfo.isAllowQuery=!0)},200)},e.newCompanyInfo.clickConfirm=function(){if(e.newCompanyInfo.inputValue){var n=!1;if(e.newCompanyInfo.matchCompanys.length>0){if(e.newCompanyInfo.matchCompanys.every(function(t,r,o){return t.name!==e.newCompanyInfo.inputValue||(n=!0,!1)}),!n)return void e.$emit(u.onShowAlert,"公司名不存在或邮箱不合法")}else if(!e.newCompanyInfo.emailReg.test(e.newCompanyInfo.inputValue))return void e.$emit(u.onShowAlert,"公司名不存在或邮箱不合法");n?e.newCompanyInfo.finishText="恭喜您，您已经成功添加了"+e.newCompanyInfo.inputValue+"，该公司将出现在您的合作公司列表中。":e.newCompanyInfo.finishText="恭喜您，您已经成功邀请了"+e.newCompanyInfo.inputValue+"，该公司注册后将出现在您的合作公司列表中。",e.$emit(u.onShowLoading,!0),n?o.inviteCompanyByName(e.newCompanyInfo.inputValue).then(function(e){x(e)},function(e){D(e)}):o.inviteCompanyByEmail(e.newCompanyInfo.inputValue).then(function(e){x(e)},function(e){D(e)})}},e.$watch(function(){return e.newCompanyInfo.inputValue},function(){e.newCompanyInfo.isAllowQuery&&(e.newCompanyInfo.isAllowQuery=!1,e.newCompanyInfo.timerPromise=t(function(){e.newCompanyInfo.inputValue?e.newCompanyInfo.emailReg.test(e.newCompanyInfo.inputValue)?e.newCompanyInfo.isShowDrop=!1:(o.getMatchCompanies(e.newCompanyInfo.inputValue).then(function(n){n?n.err?console.log(n.err):e.newCompanyInfo.matchCompanys=n:console.log("get match companies empty")},function(e){console.log("get match companies error: "+e)}),e.newCompanyInfo.isShowDrop=!0):e.newCompanyInfo.isShowDrop=!1,e.newCompanyInfo.isAllowQuery=!0;
},500))}),e.newBidderInfo={username:"",real_name:"",showBidderDialog:!1,username_readonly:!1,modify:function(n){this.username=n.username,this.real_name=n.real_name,this.showBidderDialog=!0,this.username_readonly=!0,e.maskInfo.isShow=!0},remove:function(n){if(n){var t="确定删除合作中介吗"+n.username+"吗？";e.$emit(u.onShowAlertConfirm,t,function(){e.$emit(u.onShowLoading,!0),a.removeCompanyBidder({username:n.username}).then(function(n){return e.$emit(u.onShowLoading,!1),n.err?g(n.err.type):(e.$emit(u.onShowAlert,"删除成功"),void A())},function(n){console.log(n),e.$emit(u.onShowLoading,!1),g("error")})})}},openDialog:function(n){this.username="",this.showBidderDialog=n,this.username_readonly=!1,e.maskInfo.isShow=n},submit:function(){if(!this.username)return e.$emit(u.onShowAlert,"请输入手机号码");if(!this.username.testPhone())return e.$emit(u.onShowAlert,"请输入正确的手机号码");if(!this.real_name)return e.$emit(u.onShowAlert,"请输入中介姓名");var n=this;e.$emit(u.onShowLoading,!0),a.inviteBidderByPhone({username:this.username,real_name:this.real_name}).then(function(t){return e.$emit(u.onShowLoading,!1),t.err?e.$emit(u.onShowAlert,t.err.zh_message||"操作出错"):(A(),n.openDialog(!1),void(t.update_success?e.$emit(u.onShowAlert,"修改成功"):t.add_success&&e.$emit(u.onShowAlert,"添加成功")))},function(e){return console.log(e),g("error")})}}}]),angular.module("zhuzhuqs").controller("HeaderController",["$location","$rootScope","$scope","$state","GlobalEvent","HomeService","Auth","config",function(e,n,t,r,o,i,a,s){function c(){window.location=s.login}t.headerNav={currentnav:null,subnav:null,subList:[]},t.searchHandle=function(e){alert("暂未开放")},t.curUser=a.getUser()||{},t.curCompany=a.getCompany()||{},a.onUserUpdatedCallback(function(){t.curUser=a.getUser()||{},t.curCompany=a.getCompany()||{}},"HeaderController"),n.$on(o.onChangeMenu,function(e,n){}),t.signout=function(){t.$emit(o.onShowAlertConfirm,"确认要退出吗？",c)},t.btnClickHandle=function(e){r.go(e)},n.$on("$stateChangeSuccess",function(r,o,a,s,c){t.headerNav.subnav=null,n.viewSubHandle=[],t.headerNav.subList=[],t.headerNav.subList=i.getCurrentNavList(o.name);var l=t.headerNav.subList[t.headerNav.subList.length-1];l&&"/"!==l.url?(t.headerNav.currentnav=l,a&&a.title&&(t.headerNav.currentnav.label=a.title)):t.headerNav.currentnav=null,t.headerNav.currentnav&&t.headerNav.currentnav.viewSubHandle&&t.headerNav.currentnav.viewSubHandle.length>0&&t.headerNav.currentnav.viewSubHandle.forEach(function(n){n.url===e.path()&&(t.headerNav.subnav=n)})})}]),angular.module("zhuzhuqs").controller("HomeController",["$rootScope","$scope","$state","HomeService","GlobalEvent","Auth",function(e,n,t,r,o,i){function a(e){if("external_link"===e.type)return window.location.href="/tender/entrance_page?state="+e.state+"&access_token="+i.getToken()}var s=r.getPanelItems(),c=i.getUser();return c?(s.forEach(function(e){var n=!1;c.roles.forEach(function(t){"admin"!=t&&t!=e.role||(n=!0)}),e.visible=n}),n.items=s,void(n.onMenu=function(e){if(r.setviewSubHandle(e.viewSubHandle?e.viewSubHandle:[]),e.params)t.go(e.state,{params:e.params});else{if("external_link"===e.type)return void a(e);if("home"==e.state)return void n.$emit(o.onShowDevelopmentTips,e.label);if("export"==e.state)return void n.$emit(o.onShowExportDialog,e.label);t.go(e.state)}})):void console.log("user is empty, need signin")}]),angular.module("zhuzhuqs").controller("IndexController",["$rootScope","$scope","$state","GlobalEvent","InformService","InformEnum","HomeService","Auth","CompanyService","SalesmanService",function(e,n,t,r,o,i,a,s,c,l){n.pageShow={dialogConfig:{title:"消息",content:'<div class="dialog-img"><img src="images/global/tips.png"/></div><div class="dialog-bottom">给力开发中...敬请期待!</div>',okLabel:"确定",show:!1}},e.$on(r.onShowDevelopmentTips,function(e,t){n.pageShow.dialogConfig.title=t,n.pageShow.dialogConfig.show=!0}),n.$on(r.onUpdatePanelLabel,function(e,n){a.updatePanelItemsFromLocal(n)}),n.$on(r.onUserReseted,function(e,n){s.userUpdatedCallback(),a.updatePanelItemsFromServer()}),n.clickBody=function(){e.$broadcast(r.onBodyClick)},n.informConfig={timeShow:{today:new Date,getDateFormat:function(e){return e=new Date(e),e.getYear()!==this.today.getYear()?"yyyy-MM-dd":e.getMonth()!==this.today.getMonth()?"MM-dd":e.getDate()!==this.today.getDate()?"MM-dd":"HH:mm"}},pushInfo:[],pushInfoWindow:{text:"",isShow:!1},showPushWindow:function(){if(this.pushInfo.length>0){var e=this.pushInfo[this.pushInfo.length-1];this.pushInfoWindow.text=e.title+e.text,this.pushInfoWindow.isShow=!0}},hidePushWindow:function(e){this.pushInfoWindow.text="",this.pushInfoWindow.isShow=!1,e&&stopBubble(e)},goAbnormalPage:function(){this.pushInfo.length>0&&o.clearAbnormalInforms(),this.clearPushInfo(),t.go("abnormal_orders",{},{reload:!0})},clearPushInfo:function(){this.pushInfo=[],this.hidePushWindow()},addPushInfo:function(e){this.pushInfo.push(e),this.showPushWindow()},initPushInfo:function(e){this.pushInfo=e}},o.addCallback(i.onSingleAbnormalOrder,function(e){a.updatePanelItemsFromServer(),n.$apply(function(){n.informConfig.addPushInfo(e)})}),o.addCallback(i.onBatchAbnormalOrder,function(e){if(e&&0!==e.length){var t=e.map(function(e){return e.context});n.$apply(function(){n.informConfig.initPushInfo(t)})}}),n.initNotificationList=[]}]),angular.module("zhuzhuqs").controller("MapForOrderTraceController",["$scope","BMapService","OrderService","GlobalEvent","config",function(e,n,t,r,o){function i(e){var n=[];return e.drivers&&e.drivers.length>0&&e.allDriverOrders&&e.drivers.forEach(function(t){if(e.allDriverOrders[t._id]&&e.allDriverOrders[t._id].length>0){var r={_id:t._id,address:"",driver:t,driver_id:t._id,location:t.current_location,orders:e.allDriverOrders[t._id]};e.allDriverOrders[t._id][0].pickup_events&&e.allDriverOrders[t._id][0].pickup_events.length>0?r.events=e.allDriverOrders[t._id][0].pickup_events[0]:r.events=null,n.push(r)}else console.log("can not find driver order")}),n}function a(){e.$emit(r.onShowLoading,!0),t.getDriverOrders(e.mapInit.showDriverNumber).then(function(n){if(e.$emit(r.onShowLoading,!1),console.log(n),n.err)s(n.err.type);else{n=i(n);var t=[];c(),l(),n.forEach(function(n){var r=new BMap.Point(n.location[0],n.location[1]);if(r){t.push(r);var o=new BMap.Marker(r,{icon:e.mapInit.myIcon});v.addOverlay(o),o.addEventListener("click",function(e){u(n)})}}),v.setViewport(t)}},function(e){console.log(e)})}function s(n){e.$emit(r.onShowAlert,n+" 未知错误！请联系管理员")}function c(){v.clearOverlays()}function l(){e.mapInit.gpsCount=0,e.mapInit.ungpsCount=0}function u(n){var t="";if(!n.location||n.location.length<=0){t="未知";var r=d(n,t),o=new BMap.InfoWindow(r,e.mapInit.windowOpts);v.openInfoWindow(o,i)}else{var i=new BMap.Point(n.location[0],n.location[1]),a=new BMap.Geocoder;a.getLocation(i,function(r){var o=r.addressComponents;t=o.province+", "+o.city+", "+o.district+", "+o.street+", "+o.streetNumber;var a=d(n,t),s=new BMap.InfoWindow(a,e.mapInit.windowOpts);v.openInfoWindow(s,i)})}}function d(e,n){var t=p(e.driver)+f(e,n)+h(e.events);return t}function p(e){var n='<div class=" driver-info">';return n+='<div class="content"><div class="avatar">',n+=e.photo?'<img ng-src="'+g(e.photo)+'" /></div>':"</div>",n+='<div class="info"><div class="top"><span>'+(e.nickname?e.nickname:"匿名司机")+"</span><span>("+(e.plate_numbers.length>0?e.plate_numbers[0]:"未知车牌")+')</span></div><div class="bottom">'+e.username+"</div></div>",n+="</div></div>"}function f(e,n){var t='<div class="event-tip">';t+='<div class="content">';var r=e.orders;if(1==r.length){var o=r[0];t+='<div class="item">',t+='<div class="left">',t+="运单号：</div>",t+='<div class="right">',t+=o.order_details.order_number+"</div></div>",t+='<div class="item">',t+='<div class="left">',t+="货物名称：</div>",t+='<div class="right">',t+=(o.order_details.goods_name?o.order_details.goods_name:"未知")+"</div></div>",t+='<div class="item">',t+='<div class="left">',t+="件重体：</div>",t+='<div class="right">',t+=o.order_details.weight||o.order_details.count||o.order_details.volume?(o.order_details.count?o.order_details.count+o.order_details.count_unit:"")+(o.order_details.weight?"|"+o.order_details.weight+o.order_details.weight_unit:"")+(o.order_details.volume?"|"+o.order_details.volume+o.order_details.volume_unit:"")+"</div></div>":"未知</div></div>",t+='<div class="item">',t+='<div class="left">',t+="货损状况：</div>",t+='<div class="right">',t+=(o.damaged?"有货损":"无货损")+"</div></div>"}else t+='<div class="item">',t+='<div class="left">',t+="运单号：</div>",t+='<div class="right">',t+=m(e.orders)+"共"+e.orders.length+"张运单</div></div>";return t+='<div class="item">',t+='<div class="left">',t+="当前位置：</div>",t+='<div class="right">',t+=n+"</div></div>",t+="</div></div>"}function h(n){if(!n)return"";if(e.mapInit.displayPhotos=[],e.mapInit.currentPhotos=[],n.goods_photos&&n.goods_photos.length>0){e.mapInit.displayPhotos.push(n.goods_photos[0]);var t={order:"",title:"",warning:"",url:g(n.goods_photos[0]),remark:""};e.mapInit.currentPhotos.push(t)}if(n.credential_photos&&n.credential_photos.length>0){e.mapInit.displayPhotos.push(n.credential_photos[0]);var t={order:"",title:"",warning:"",url:g(n.credential_photos[0]),remark:""};e.mapInit.currentPhotos.push(t)}var r="";if(e.mapInit.displayPhotos.length>0){r+='<div id="'+n._id+'" class="photos">';for(var o=0;o<e.mapInit.displayPhotos.length;o++){var i=e.mapInit.displayPhotos[o];r+=0===o?'<div class="photo" onclick="angular.element(this).scope().showPhotos(\''+i+'\');"><img src="'+g(i)+'" onerror="this.src=\'images/icon/order_follow/error.jpg\'"/></div>':'<div class="photo-right" onclick="angular.element(this).scope().showPhotos(\''+i+'\');"><img src="'+g(i)+'" onerror="this.src=\'images/icon/order_follow/error.jpg\'"/></div>'}r+="</div>"}return r}function m(e){var n=e[0].order_details.order_number;if(e.length>1){for(var t=e.length>5?5:e.length,r=1;r<t;r++)n+=","+e[r].order_details.order_number;n+="..."}return n}function g(e){return o.qiniuServerAddress+e}var v=new BMap.Map("mapForOrderTrace");v.centerAndZoom(new BMap.Point(116.404,39.915),11),v.addControl(new BMap.MapTypeControl),v.enableScrollWheelZoom(!0);var _=new BMap.ScaleControl({anchor:BMAP_ANCHOR_TOP_LEFT}),y=new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_LEFT,type:BMAP_NAVIGATION_CONTROL_SMALL});v.addControl(_),v.addControl(y),e.mapInit={showDriverNumber:50,gpsCount:0,ungpsCount:0,icon:"/images/icon/map/driver.png",iconSize:new BMap.Size(42,33),iconAnchorSize:new BMap.Size(14,33),myIcon:"",windowOpts:{width:290,enableMessage:!0},showPhotoScan:!1,displayPhotos:[],currentPhotos:[],imgIndex:0},e.mapInit.myIcon=new BMap.Icon(o.serverWebAddress+e.mapInit.icon,e.mapInit.iconSize),e.filterDriverNumber=function(){a()},e.showPhotos=function(n){e.mapInit.imgIndex=0,e.mapInit.showPhotoScan=!0,e.$apply()},a()}]),angular.module("zhuzhuqs").controller("OnlineReportConfigController",["$scope","$stateParams","$timeout","OnlineReportConfigService","CompanyError","GlobalEvent",function(e,n,t,r,o,i){e.time={queryLogTimeRange:{startDate:moment().add(-1,"day").format("YYYY-MM-DD HH"),endDate:moment().format("YYYY-MM-DD HH")},dateOptions:{locale:{fromLabel:"起始",toLabel:"结束",cancelLabel:"取消",applyLabel:"确定",customRangeLabel:"区间",daysOfWeek:["日","一","二","三","四","五","六"],firstDay:1,monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]},singleDatePicker:!0,timePicker:!0,showDropdowns:!0,timePicker12Hour:!1,timePickerIncrement:60,separator:"",format:"YYYY-MM-DD HH:mm"}},e.reportConfig={emails:"",start_send_time:e.time.queryLogTimeRange.startDate,interval:7,submit_name:"保存设置"},e.reportOrderConfig={fields:["公司","发货方","收货方","运单号","创建时间","分配时间","提货进场时间","交货进场时间","中途事件","参考单号","品名","运费","状态","司机姓名","司机手机","司机车牌","承运商","件数","件数单位","重量","重量单位","体积","体积单位","实际提货时间","实际交货时间","计划提货时间","计划交货时间","提货联系人","提货联系手机","提货联系固话","提货地址","交货联系人","交货联系手机","交货联系固话","交货地址","关注人","备注","提货进场拍照","提货拍照","交货进场拍照","交货拍照","中途事件拍照","实收货物","实收数量","货缺","货损"]},e.currentReportType="default",e.rightHeader={config:{name:"在线报表配置",count:0,columns:[{name:"在线报表配置",length:4}]}},e.submitOrderExportConfig=function(){var n=[];return jQuery(".body.order input[name=order_fields]").each(function(){var e=this;e.checked&&n.push(this.value)}),!n||n.length<1?void e.$emit(i.onShowAlert,"请选择导出项"):void r.saveOrUpdateOrderExportFields({fields:n.join(",")}).then(function(n){return e.$emit(i.onShowLoading,!1),console.log(n),n.err?void e.$emit(i.onShowAlert,n.err.message):void e.$emit(i.onShowAlert,"保存成功")},function(e){})},e.submitConfig=function(){return e.reportConfig.emails?(console.log(e.reportConfig.start_send_time),e.reportConfig.start_send_time=$(".start_send_time").val(),console.log(e.reportConfig.start_send_time),e.$emit(i.onShowLoading,!0),void r.saveOrUpdate(e.reportConfig).then(function(n){return e.$emit(i.onShowLoading,!1),console.log(n),n.err?void e.$emit(i.onShowAlert,n.err.message):void e.$emit(i.onShowAlert,"保存成功")},function(e){})):void e.$emit(i.onShowAlert,"请输入目标邮箱！")};var a=function(){r.getReportConfig().then(function(n){console.log(n),n&&""!=n&&(e.reportConfig.emails=n.emails,e.reportConfig.start_send_time=n.start_send_time,e.reportConfig.interval=n.interval,e.time.queryLogTimeRange.startDate=n.start_send_time,e.time.queryLogTimeRange.endDate=e.time.queryLogTimeRange.startDate)}),r.getOrderExportReportConfig().then(function(e){if(e&&e.fields){var n=e.fields.split(",");console.log(n);for(var t=0,r=n.length;t<r;t++){var o=n[t];jQuery(".body.order input[name=order_fields][value="+o+"]").attr("checked","checked")}}})};a()}]),angular.module("zhuzhuqs").controller("OrderAssignController",["$rootScope","$scope","$state","OrderService","CompanyService","OrderError","GlobalEvent","CompanyError","UserProfileService","OrderHelper",function(e,n,t,r,o,i,a,s,c,l){function u(e){c.getUserProfile().then(function(t){if(!t)return console.log("get user profile failed"),e();if(t.err)return console.log(t.err),e();if(!t.user_profile)return console.log("customer do not has user profile content"),e();if(!t.user_profile.customize_columns_assign||t.user_profile.customize_columns_assign.length<=0)console.log("customer did not create customer profile until now");else{var r,o;for(o=0;o<n.orders.config.selectOptions.length;o++)r=n.orders.config.selectOptions[o],r.isSelected=!1;t.user_profile.customize_columns_assign.forEach(function(e){for(o=0;o<n.orders.config.selectOptions.length;o++)if(r=n.orders.config.selectOptions[o],r.key===e){r.isSelected=!0;break}})}return t.user_profile.max_page_count_assign&&(n.orders.config.pagination.limit=parseInt(t.user_profile.max_page_count_assign)||n.orders.config.pagination.limit,n.orders.config.pagination.currentLimit=n.orders.config.pagination.limit),e()},function(n){return console.log(n),e()})}function d(){!n.orders.config.selectOptions||n.orders.config.selectOptions.length<=0||(n.orders.config.fields=[],n.orders.config.selectOptions.forEach(function(e){e.isSelected&&n.orders.config.fields.push(e.value)}),n.orders.config.fields.length>n.orders.config.fields_length&&(n.orders.config.fields=n.orders.config.fields.slice(0,n.orders.config.fields_length)))}function p(e){var t={};return n.orders.config.fields.forEach(function(n){switch(n.value){case"order_number":t.order_number=e.order_number;break;case"ref_number":t.ref_number=e.refer_order_number?e.refer_order_number:"未填";break;case"original_order_number":t.original_order_number=e.original_order_number?e.original_order_number:"未填";break;case"goods_name":t.goods_name=l.getGoodsNameString(e);break;case"count_weight_volume":t.count_weight_volume=l.getCountDetail(e);break;case"pickup_start_time":t.pickup_start_time=e.pickup_start_time?new Date(e.pickup_start_time).Format("yy/MM/dd hh:mm"):"未填";break;case"delivery_start_time":t.delivery_start_time=e.delivery_start_time?new Date(e.delivery_start_time).Format("yy/MM/dd hh:mm"):"未填";break;case"sender_name":t.sender_name=e.sender_name?e.sender_name:"未填";break;case"receiver_name":t.receiver_name=e.receiver_name?e.receiver_name:"未填";break;case"description":t.description=e.description?e.description:"未填";break;case"status":t.status=g(e.status,e.delete_status);break;case"assign_time":t.assign_time=e.assign_time?new Date(e.assign_time).Format("yyyy-MM-dd hh:mm:ss"):"无"}}),t}function f(){d(),n.orders.currentOrderList&&n.orders.currentOrderList.length>0&&M(n.orders.currentOrderList)}function h(){for(var e,t=[],r=0;r<n.orders.config.selectOptions.length;r++)e=n.orders.config.selectOptions[r],e.isSelected&&t.push(e.key);t.length>0&&c.setAssignCustomizeColumns(t).then(function(e){return e?e.err?void console.log(e.err):void 0:void console.log("set customize columns failed")},function(e){console.log(e)})}function m(e,n){c.setMaxPageCount({column_name:e,max_page_count:n}).then(function(e){return!e||e.err?console.log("set assign page max count failed"):void console.log("set assign page max count success")},function(e){return console.log("set assign page max count failed")})}function g(e,n){if(n)return"已撤销";var t=v(e);return t?t:"已完成"}function v(e){var n="";switch(e){case"unAssigned":n="未分配";break;case"assigning":n="分配中";break;case"unPickupSigned":case"unPickuped":n="未提货";break;case"unDeliverySigned":case"unDeliveried":n="未交货";break;case"pickupSign":n="提货签到";break;case"pickup":n="提货";break;case"deliverySign":n="交货签到";break;case"delivery":n="交货";break;case"halfway":n="中途事件";break;case"completed":n="已完成"}return n}function _(e){e||(e={key:"",value:""}),n.patchAssignInfo.partnerId=e.key,n.patchAssignInfo.partnerName=e.value,n.patchAssignInfo.partnerType=e.group_type,n.patchAssignInfo.is_wechat=e.is_wechat||!1}function y(e,n){var t=[],r=[],o=[];r.push({key:null,value:"合作公司"});for(var i=0;i<e.length;i++){var a=e[i];r.push(l.getCompanyAssignOption(a))}t.push({key:null,value:"合作司机"}),r.push({key:null,value:"合作司机"}),o.push({key:null,value:"仓库管理员"});for(var i=0;i<n.length;i++)n[i].driver&&n[i].driver.is_signup&&(t.push(l.getDriverAssignOption(n[i].driver,"driver")),r.push(l.getDriverAssignOption(n[i].driver,"driver")),o.push(l.getDriverAssignOption(n[i].driver,"warehouse")));return{executeDriverData:t,executeSelectData:r,executeWarehouseSelectData:o}}function S(e){var o={type:n.patchAssignInfo.partnerType,partner_name:n.patchAssignInfo.partnerName,is_wechat:n.patchAssignInfo.is_wechat,order_ids:[],road_order_name:e};"company"===o.type?o.company_id=n.patchAssignInfo.partnerId:o.driver_id=n.patchAssignInfo.partnerId;for(var i=0;i<n.patchAssignInfo.selectedOrders.length;i++)o.order_ids.push(n.patchAssignInfo.selectedOrders[i]._id);n.$emit(a.onShowLoading,!0),r.batchAssign(o).then(function(e){n.$emit(a.onShowLoading,!1),console.log(e),e.err?console.log(e.err):(n.$emit(a.onShowAlert,"分配成功"),t.go("order_assign",{},{reload:!0}))},function(e){console.log(e)})}function w(e){for(var t=e._id,r=e.new_order_number,o=e.extendData.assignInfos,i=!0,s=0;s<o.length;s++){var c=o[s];if(0==O(c)){i=!1;break}c.pickupTimeRange="",c.deliveryTimeRange="",c.pickup_start_time&&c.pickup_start_time.toISOString&&(c.pickup_start_time=c.pickup_start_time.toISOString()),c.pickup_end_time&&c.pickup_end_time.toISOString&&(c.pickup_end_time=c.pickup_end_time.toISOString()),c.delivery_start_time&&c.delivery_start_time.toISOString&&(c.delivery_start_time=c.delivery_start_time.toISOString()),c.delivery_end_time&&c.delivery_end_time.toISOString&&(c.delivery_end_time=c.delivery_end_time.toISOString()),delete c.$$hashKey,delete c.currentChoice,delete c.options}return i?void("assigning"==e.extendData.assign_status?B(t,o):R(t,r,o)):void n.$emit(a.onShowAlert,"分配信息有误，请分配给司机或供应商或者仓库管理员")}function k(e){console.log("onRowClick"),console.log(e)}function C(e){if(n.patchAssignInfo.count=e.length,n.patchAssignInfo.selectedOrders=e,e&&e.length>0){n.orders.isShowBatchAssign=!0,n.patchAssignInfo.enableEdit=!0,n.orders.isShowBatchDelete=!0;for(var t=0;t<e.length;t++){var r=e[t];if(r.rowConfig.unEdited){n.orders.isShowBatchDelete=!1;break}}}else n.orders.isShowBatchAssign=!1,n.patchAssignInfo.enableEdit=!1,n.orders.isShowBatchDelete=!1;console.log(e)}function b(e){console.log("on row info edit");var n={order_id:e._id,order_number:e.columns.order_number,refer_order_number:e.extendData.detail.refer_order_number,original_order_number:e.extendData.detail.original_order_number,goods_name:"未填"===e.columns.goods_name?"":e.columns.goods_name,count:e.extendData.detail.count,weight:e.extendData.detail.weight,volume:e.extendData.detail.volume,count_unit:e.extendData.detail.count_unit,weight_unit:e.extendData.detail.weight_unit,volume_unit:e.extendData.detail.volume_unit,freight_charge:e.extendData.detail.freight_charge,customer_name:e.extendData.detail.customer_name,pickup_start_time:e.extendData.detail.pickup_start_time,delivery_start_time:e.extendData.detail.delivery_start_time,pickup_end_time:e.extendData.detail.pickup_end_time,delivery_end_time:e.extendData.detail.delivery_end_time,description:e.extendData.detail.description,group_id:e.extendData.detail.execute_group,pickup_contact_name:e.extendData.detail.pickup_contact_name,pickup_contact_phone:e.extendData.detail.pickup_contact_phone,pickup_contact_mobile_phone:e.extendData.detail.pickup_contact_mobile_phone,pickup_contact_address:e.extendData.detail.pickup_contact_address,pickup_contact_email:"",delivery_contact_name:e.extendData.detail.delivery_contact_name,delivery_contact_phone:e.extendData.detail.delivery_contact_phone,delivery_contact_mobile_phone:e.extendData.detail.delivery_contact_mobile_phone,delivery_contact_address:e.extendData.detail.delivery_contact_address,delivery_contact_email:"",sender_name:e.extendData.detail.sender_name,receiver_name:e.extendData.detail.receiver_name,receiver_company:e.extendData.detail.receiver_company,sender_company:e.extendData.detail.sender_company};console.log(n),t.go("order_create",{order:JSON.stringify(n),modify_type:"normal",title:"修改运单"})}function I(e){console.log("on row delete"),n.$emit(a.onShowAlertConfirm,"确认要删除吗？",function(e){r.deleteUnAssignedOrder(e._id).then(function(e){console.log(e),t.go("order_assign",{},{reload:!0})},function(e){console.log(e)})},e),console.log(e)}function x(e){n.orders.config.pagination.searchName=e.value,n.orders.config.pagination.searchValue=e.keyword,T(function(){n.$emit(a.onShowLoading,!1)})}function D(e){n.orders.config.pagination.sortName=e.value,n.orders.config.pagination.sortValue=e.curSort.value,T(function(){n.$emit(a.onShowLoading,!1)})}function O(e){return!!e&&("driver"===e.type||"warehouse"===e.type?!!e.driver_id||!(!e.currentText||!U.test(e.currentText))&&(e.driver_username=e.currentText,!0):(!e.company_id&&e.currentText&&U.test(e.currentText)&&(e.type="driver",e.driver_username=e.currentText),!0))}function A(){n.$emit(a.onShowLoading,!0),L(function(e){$(function(t){var r=y(e,t);n.patchAssignInfo.driverOptions=r.executeDriverData,n.patchAssignInfo.selectOptions=r.executeSelectData,n.patchAssignInfo.warehouseOptions=r.executeWarehouseSelectData,n.patchAssignInfo.options=n.patchAssignInfo.selectOptions,n.patchAssignInfo.partnerType="driver",n.patchAssignInfo.defaultContent="搜索合作公司或司机 ",n.changePartnerType(),T(function(){n.$emit(a.onShowLoading,!1)})})})}function P(e,n){var t=e.partner._id?e.partner:e.company;return!t.auth_status||"authed"!==t.auth_status}function L(e){o.getPartnerCompanys().then(function(t){if(t.err?H(t.err.type):(t.partnerCompany.sort(P),n.orderInfo.partnerCompanys=t.partnerCompany,n.orders.config.extendData.partnerCompanies=t.partnerCompany),e)return e(t.partnerCompany)},function(e){})}function z(e){!e||e.length<=0||e.forEach(function(e){var n=e.driver.all_count.evaluationCount,t=n.good+n.general+n.bad;t<10?e.driver.goodEvaluation=0:e.driver.goodEvaluation=Math.ceil(100*n.good/t),e.driver.goodEvaluation>=80?e.driver.evaluationLevel=3:e.driver.goodEvaluation>=60&&e.driver.goodEvaluation<80?e.driver.evaluationLevel=2:e.driver.evaluationLevel=1})}function E(e,n){return!(e.driver.evaluationLevel>n.driver.evaluationLevel)&&(e.driver.evaluationLevel!==n.driver.evaluationLevel||!(e.driver.all_count.orderCount>n.driver.all_count.orderCount))}function $(e){o.getPartnerDrivers().then(function(t){if(console.log(t),t.err?H(t.err.type):(z(t.driverCompanys),t.driverCompanys.sort(E),n.orderInfo.partnerDrivers=t.driverCompanys,n.orders.config.extendData.partnerDrivers=t.driverCompanys),e)return e(t.driverCompanys)},function(e){})}function T(e){n.$emit(a.onShowLoading,!0);var t=q();r.getUnsignedOrder(n.orders.config.pagination.currentPage,n.orders.config.pagination.limit,n.orders.config.pagination.sortName,n.orders.config.pagination.sortValue,t).then(function(t){return n.$emit(a.onShowLoading,!1),console.log(t),t.err?void W(t.err.type):(n.orders.currentOrderList=t.orders,M(t.orders),n.orders.config.pagination.limit=parseInt(t.limit),n.orders.config.pagination.totalCount=t.totalCount,n.orders.config.pagination.currentPage=parseInt(t.currentPage),n.orders.config.pagination.pageCount=Math.ceil(t.totalCount/t.limit),n.orders.config.pagination.render(),n.orders.config.extendData.rangeTimePanel=n.zzRangeDatePicker,e?e():void 0)},function(e){})}function M(e){if(n.orders.config.rows.splice(0,n.orders.config.rows.length),0!==e.length){for(var t=0;t<e.length;t++){var r=e[t];n.orders.config.rows.push({_id:r._id,columns:p(r),extendData:{status:r.status,assign_status:r.assign_status,assignInfos:r.assigned_infos,detail:{parent_order:r.parent_order,order_number:r.order_number,refer_order_number:r.refer_order_number,original_order_number:r.original_order_number,goods_name:r.goods_name,pickup_contact_name:r.pickup_contacts.name,pickup_contact_phone:r.pickup_contacts.phone,pickup_contact_mobile_phone:r.pickup_contacts.mobile_phone,pickup_contact_address:r.pickup_contacts.address,delivery_contact_name:r.delivery_contacts.name,delivery_contact_phone:r.delivery_contacts.phone,delivery_contact_mobile_phone:r.delivery_contacts.mobile_phone,delivery_contact_address:r.delivery_contacts.address,pickup_start_time:r.pickup_start_time,pickup_end_time:r.pickup_end_time,delivery_start_time:r.delivery_start_time,delivery_end_time:r.delivery_end_time,customer_name:r.customer_name,create_user:r.create_user,create_group:r.create_group,execute_group:r.execute_group,description:r.description,count:r.count,weight:r.weight,volume:r.volume,count_unit:r.count_unit,weight_unit:r.weight_unit,volume_unit:r.volume_unit,freight_charge:r.freight_charge,details:r.details,receiver_name:r.receiver_name,sender_name:r.sender_name,receiver_company:r.receiver_company,sender_company:r.sender_company}},rowConfig:{notOptional:"unAssigned"!==r.status,unEdited:!0,expand:!0,expandText:"assigning"===r.assign_status?"继续分配":"分配"}})}n.orders.config.load()}}function R(e,t,o){n.$emit(a.onShowLoading,!0),r.assignOrder({order_id:e,assign_infos:o,new_order_number:t}).then(function(e){return n.$emit(a.onShowLoading,!1),console.log(e),e.err?void W(e.err.type):(n.$emit(a.onShowAlert,"分配成功"),void n.searchModule.searchHandle())},function(e){console.log(e)})}function B(e,t){n.$emit(a.onShowLoading,!0),r.continueAssignOrder({order_id:e,assign_infos:t}).then(function(e){return n.$emit(a.onShowLoading,!1),console.log(e),e.err?void W(e.err.type):(n.$emit(a.onShowAlert," 分配成功"),void n.searchModule.searchHandle())},function(e){console.log(e)})}function H(e){s[e]?n.$emit(a.onShowAlert,s[e]):n.$emit(a.onShowAlert,e+" 未知错误！请联系管理员")}function W(e){i[e]?n.$emit(a.onShowAlert,i[e]):n.$emit(a.onShowAlert,e+" 未知错误！请联系管理员")}function q(){if(n.searchModule){var e=[];return n.searchModule.createTimeRange&&(e.push({key:"createTimeStart",value:moment(n.searchModule.createTimeRange.startDate).toISOString()}),e.push({key:"createTimeEnd",value:moment(n.searchModule.createTimeRange.endDate).toISOString()})),n.searchModule.deliveryTimeRange&&(e.push({key:"planDeliveryTimeStart",value:moment(n.searchModule.deliveryTimeRange.startDate).toISOString()}),e.push({key:"planDeliveryTimeEnd",value:moment(n.searchModule.deliveryTimeRange.endDate).toISOString()})),n.searchModule.receiver&&e.push({key:"receiver",value:n.searchModule.receiver}),n.searchModule.goods_name&&e.push({key:"goods_name",value:n.searchModule.goods_name}),n.searchModule.damaged&&"不限"!==n.searchModule.damaged&&e.push({key:"damaged",value:"有"===n.searchModule.damaged}),n.searchModule.pickUpTimeRange&&(e.push({key:"planPickupTimeStart",value:moment(n.searchModule.pickUpTimeRange.startDate).toISOString()}),e.push({key:"planPickupTimeEnd",value:moment(n.searchModule.pickUpTimeRange.endDate).toISOString()})),n.searchModule.sender&&e.push({key:"sender",value:n.searchModule.sender}),n.searchModule.description&&e.push({key:"description",value:n.searchModule.description}),n.searchModule.order_number&&e.push({key:"order_number",value:n.searchModule.order_number}),e}}n.orders={config:{selectOptions:[{key:"运单号",value:{name:"运单号",value:"order_number",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!0},{key:"参考单号",value:{name:"参考单号",value:"ref_number",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!0},{key:"订单号",value:{name:"订单号",value:"original_order_number",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!1},{key:"货物名称",value:{name:"货物名称",value:"goods_name",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!0},{key:"件重体",value:{name:"件/重/体",value:"count_weight_volume",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:{},keyword:""},isSelected:!0},{key:"提货时间",value:{name:"提货时间",value:"pickup_start_time",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:{},keyword:""},isSelected:!0},{key:"交货时间",value:{name:"交货时间",value:"delivery_start_time",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:{},keyword:""},isSelected:!0},{key:"发货方",value:{name:"发货方",value:"sender_name",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"收货方",value:{name:"收货方",value:"receiver_name",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"备注",value:{name:"备注",value:"description",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"状态",value:{name:"状态",value:"status",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!0},{key:"分配时间",value:{name:"分配时间",value:"assign_time",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1}],rowExpand:{enable:!0,expandText:"分配",cancelText:"取消",selfCloseButton:!0},selectionOption:{columnWidth:1},handleOption:{columnWidth:2},fields:[],fields_length:7,isShowPagination:!0,pagination:{currentPage:1,currentLimit:10,limit:10,totalCount:0,pageCount:0,pageNavigationCount:5,canSeekPage:!0,limitArray:[10,20,30,40,100],pageList:[1],sortName:"",sortValue:"",searchName:"",searchValue:"",onCurrentPageChanged:function(e){n.orders.config.pagination.currentLimit!==n.orders.config.pagination.limit&&(n.orders.config.pagination.currentLimit=n.orders.config.pagination.limit,m("max_page_count_assign",n.orders.config.pagination.limit)),T(e(n.orders.config.pagination))}},rows:[],events:{selectedHandler:[C],rowClickHandler:[k],rowDeleteHandler:[I],rowInfoEditHandler:[b],headerSortChangedHandler:[D],headerKeywordsChangedHandler:[x],updateDisplayFields:[f],saveDisplayFields:[h]},extendData:{partnerCompanies:[],partnerDrivers:[],rangeTimePanel:null,onRowSubmit:function(e){w(e)}}},isShowBatchAssign:!1,isShowBatchDelete:!1,currentOrderList:[]},n.patchAssignInfo={count:0,partnerType:"",partnerId:"",partnerName:"",is_wechat:!1,enableEdit:!1,selectedOrders:[],isWarehouse:!1,isRoadOrder:!1,driverOptions:[],selectOptions:[],warehouseOptions:[],defaultContent:"搜索合作公司或司机",options:[],onSelected:_},n.changePartnerType=function(){n.patchAssignInfo.enableEdit&&(n.patchAssignInfo.isRoadOrder||(n.patchAssignInfo.isWarehouse=!n.patchAssignInfo.isWarehouse,
n.patchAssignInfo.isWarehouse?(n.patchAssignInfo.options=n.patchAssignInfo.warehouseOptions,n.patchAssignInfo.partnerType="warehouse",n.patchAssignInfo.defaultContent="搜索仓库管理员"):(n.patchAssignInfo.options=n.patchAssignInfo.selectOptions,n.patchAssignInfo.partnerType="driver",n.patchAssignInfo.defaultContent="搜索合作公司或司机")))},n.changeRoadOrder=function(){n.patchAssignInfo.enableEdit&&(n.patchAssignInfo.isWarehouse||(n.patchAssignInfo.isRoadOrder=!n.patchAssignInfo.isRoadOrder,n.patchAssignInfo.isRoadOrder?(n.patchAssignInfo.options=n.patchAssignInfo.driverOptions,n.patchAssignInfo.partnerType="driver",n.patchAssignInfo.defaultContent="搜索合作司机"):(n.patchAssignInfo.options=n.patchAssignInfo.selectOptions,n.patchAssignInfo.partnerType="driver",n.patchAssignInfo.defaultContent="搜索合作公司或司机")))},n.orderBatchDelete=function(){n.orders.isShowBatchDelete&&(n.patchAssignInfo.selectedOrders.length<=0||n.$emit(a.onShowAlertConfirm,"确认要删除这"+n.patchAssignInfo.selectedOrders.length+"项运单吗？",function(e){n.$emit(a.onShowLoading,!0);for(var o=[],i=0;i<n.patchAssignInfo.selectedOrders.length;i++){var s=n.patchAssignInfo.selectedOrders[i];o.push(s._id)}r.batchDeleteOrders(o).then(function(e){if(n.$emit(a.onShowLoading,!1),console.log(e),!e)return W("");if(e.err)return W(e.err.type);var r="删除成功";e.failedOrders&&e.failedOrders.length>0&&(r="操作完成，失败"+e.failedOrders.length+"个"),n.$emit(a.onShowAlert,r,function(){t.go("order_assign",{},{reload:!0})})},function(e){n.$emit(a.onShowLoading,!1),console.log(e)})},null))},n.orderPatchAssign=function(){n.patchAssignInfo.selectedOrders.length<=0||n.patchAssignInfo.partnerId&&""!==n.patchAssignInfo.partnerId&&n.patchAssignInfo.partnerType&&""!==n.patchAssignInfo.partnerType&&(n.patchAssignInfo.isRoadOrder?n.$emit(a.onShowAlertPrompt,{tipText:"设置路单号：",placeholderText:"输入您要设置的路单号（选填）",sure:"开始分配"},function(e){S(e)}):S())};var U=/\d{11}/;n.orderInfo={curOrder:{},curPath:[],showAssignDialog:!1,partnerCompanys:[],partnerDrivers:[],selectedPartner:null,PickUpMinTime:"",deliveryMinTime:"",dateOptions:{locale:{fromLabel:"起始",toLabel:"结束",cancelLabel:"取消",applyLabel:"确定",customRangeLabel:"区间",daysOfWeek:["日","一","二","三","四","五","六"],firstDay:1,monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]},timePicker:!0,timePickerIncrement:1,timePicker12Hour:!1,separator:"~",format:"YYYY-MM-DD HH:mm:ss",opens:"right"}},n.clickPartner=function(){console.log(n.orderInfo.selectedPartner);var e=null;if(n.orderInfo.selectedPartner&&(e=JSON.parse(n.orderInfo.selectedPartner)),e){var t=n.orderInfo.curPath;e.driver?(t.driver_id=e.driver._id,t.partner_name=e.driver.username,t.type="driver"):(t.company_id=e.company._id?e.company._id:e.partner._id,t.partner_name=e.company._id?e.company.name:e.partner.name,t.type="company")}},n.searchModule={isShowHighSearch:!1,showHighSearchHandle:"",hideHighSearchHandle:"",receiver:"",goods_name:"",sender:"",description:"",order_number:"",searchHandle:"",createTimeRange:"",pickUpTimeRange:"",deliveryTimeRange:"",cleanDeliveryTime:"",cleanPickupTime:"",dateOptions:{locale:{fromLabel:"起始时间",toLabel:"结束时间",cancelLabel:"取消",applyLabel:"确定",customRangeLabel:"区间",daysOfWeek:["日","一","二","三","四","五","六"],firstDay:1,monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]},timePicker:!0,timePicker12Hour:!1,timePickerIncrement:1,separator:" ~ ",format:"YY/MM/DD HH:mm"}},n.searchModule.showHighSearchHandle=function(){n.searchModule.isShowHighSearch=!0},n.searchModule.hideHighSearchHandle=function(){n.searchModule.isShowHighSearch=!1},n.searchModule.searchHandle=function(){n.orders.config.pagination.currentPage=1,T(function(){n.$emit(a.onShowLoading,!1)})},u(function(){d(),A()})}]),angular.module("zhuzhuqs").controller("OrderBatchCreateController",["$scope","$state","OrderService","CompanyService","ExcelReaderService","config","GlobalEvent","UserProfileService",function(e,n,t,r,o,i,a,s){function c(){e.data.result.totalCount=0,e.data.result.successCount=0,e.data.result.invalidReceiverCount=0,e.data.result.invalidSenderCount=0,e.data.result.successAssignCount=0,e.data.result.success=!0}function l(){s.getUserProfile().then(function(n){if(console.log(n),n.err)return console.log(n.err);if(n.user_profile){if(e.data.pickup_entrance_force=n.user_profile.pickup_entrance_force,e.data.pickup_photo_force=n.user_profile.pickup_photo_force,e.data.delivery_entrance_force=n.user_profile.delivery_entrance_force,e.data.delivery_photo_force=n.user_profile.delivery_photo_force,n.user_profile.order_execute_group&&e.data.executeGroups.length>0)for(var t=0;t<e.data.executeGroups.length;t++)if(e.data.executeGroups[t]._id.toString()===n.user_profile.order_execute_group){e.clickGroup(e.data.executeGroups[t]);break}}else e.data.pickup_entrance_force=!1,e.data.pickup_photo_force=!1,e.data.delivery_entrance_force=!1,e.data.delivery_photo_force=!0},function(e){console.log(e)}),r.getConfiguration().then(function(n){return console.log(n),n&&n.err?console.log("get company configuration error"):void(n&&n.push_option&&(e.data.abnormal_push.isOpen=n.push_option.abnormal_push,e.data.pickup_push.isOpen=n.push_option.pickup_push,e.data.create_push.isOpen=n.push_option.create_push,e.data.delivery_sign_push.isOpen=n.push_option.delivery_sign_push,e.data.delivery_push.isOpen=n.push_option.delivery_push,e.data.pickup_deferred_duration=n.push_option.pickup_deferred_duration,e.data.delivery_early_duration=n.push_option.delivery_early_duration))},function(e){console.log(e)})}function u(n){r.getExecuteGroupList().then(function(t){return t.err?e.$emit(a.onShowAlert,"获取公司组失败！"):(e.data.executeGroups=t,e.data.executeGroups.length>0&&e.clickGroup(e.data.executeGroups[0])),n()},function(t){return e.$emit(a.onShowAlert,"获取公司组失败！"),n()})}function d(n){!n||n.length<=0||n.forEach(function(n){n.createInfo.pickup_entrance_force=e.data.pickup_entrance_force,n.createInfo.pickup_photo_force=e.data.pickup_photo_force,n.createInfo.delivery_entrance_force=e.data.delivery_entrance_force,n.createInfo.delivery_photo_force=e.data.delivery_photo_force,n.createInfo.pickup_push=e.data.pickup_push.isOpen,n.createInfo.abnormal_push=e.data.abnormal_push.isOpen,n.createInfo.create_push=e.data.create_push.isOpen,n.createInfo.delivery_sign_push=e.data.delivery_sign_push.isOpen,n.createInfo.delivery_push=e.data.delivery_push.isOpen,n.createInfo.pickup_deferred_duration=e.data.pickup_deferred_duration,n.createInfo.delivery_early_duration=e.data.delivery_early_duration})}function p(){n.go("order_assign")}function f(e,n){var t={};return n.forEach(function(n){t[n]=e[n]}),t}function h(e,n){var t={};return n.forEach(function(n){t[n]=e[n]}),t}function m(e){var n=g(e,!0),t={};n.forEach(function(e){t[e.createInfo.order_number]||(t[e.createInfo.order_number]={createInfo:e.createInfo,assignInfos:[]}),t[e.createInfo.order_number].assignInfos=t[e.createInfo.order_number].assignInfos.concat(e.assignInfos)});var r=[];for(var o in t)1!==t[o].assignInfos.length||t[o].assignInfos[0].driver_username||(t[o].assignInfos=[]),r.push(t[o]);return r}function g(e,n){if(!e||0===e.length)return[];var t=["customer_name","sender_name","receiver_name","order_number","refer_order_number","freight_charge","pickup_start_time","pickup_end_time","pickup_contact_name","pickup_contact_address","pickup_contact_mobile_phone","pickup_contact_phone","delivery_start_time","delivery_end_time","delivery_contact_name","delivery_contact_address","delivery_contact_mobile_phone","delivery_contact_phone","goods_name","count","count_unit","weight","weight_unit","volume","volume_unit","description","goods","salesmen","original_order_number"],r=["driver_username","pickup_start_time","pickup_end_time","pickup_contact_name","pickup_contact_address","pickup_contact_mobile_phone","pickup_contact_phone","delivery_start_time","delivery_end_time","delivery_contact_name","delivery_contact_address","delivery_contact_mobile_phone","delivery_contact_phone"],o=[];return e.forEach(function(e){var i={createInfo:f(e,t),assignInfos:[]},a=h(e,r);(a.driver_username||n)&&i.assignInfos.push(a),o.push(i)}),o}function v(e){return!e||!isNaN(parseFloat(e))}function _(e){return!e||!isNaN(Date.parse(e))}function y(e){for(var n=[],t=1;t<4;t++)e["goods"+t]&&n.push({name:e["goods"+t],count:e["count"+t]||"",unit:e["unit"+t]||"箱"});0===n.length&&n.push({name:"",count:"",unit:"箱"}),e.goods=n,e.goods_name=n[0].name,e.count=n[0].count,e.count_unit=n[0].unit,e.weight="",e.weight_unit="吨",e.volume="",e.volume_unit="立方"}function S(e){for(var n=[],t=1;t<4;t++)e["salesman"+t]&&n.push(e["salesman"+t]);n.length>0&&(n=n.zzDistinct()),n.length>0&&(e.salesmen=n)}function w(){n.go("order_configuration")}function k(e,n){if(!e)return n();for(var t,r,o=0;o<e.length;o++){var i=e[o];if(!i[L[3]])return n({row:o+2,column:E[4],message:L[3]+"不能为空"});for(var a in i)switch(a){case L[7]:case L[12]:if(!_(i[a]))return t=L.indexOf(a),n({row:o+2,column:E[t+1],message:L[t]+"必须为时间格式"});break;case L[5]:case L[10]:case L[15]:case z[18]:case z[19]:case z[20]:if(i[a]&&!i[a].toString().testPhone()&&0!==o)return t=L.indexOf(a),t===-1?(t=z.indexOf(a),r=z[t]):r=L[t],n({row:o+2,column:E[t+1],message:r+"必须为11位手机号格式"});break;case L[6]:case L[18]:case L[20]:case L[22]:case z[22]:case z[25]:case z[28]:if(!v(i[a]))return t=L.indexOf(a),t===-1?(t=z.indexOf(a),r=z[t]):r=L[t],n({row:o+2,column:E[t+1],message:r+"必须为数字格式"})}}return n()}function C(e){if(!e)return[];for(var n={"客户":"customer_name","发货方":"sender_name","收货方":"receiver_name","运单号":"order_number","参考单号":"refer_order_number","承运司机":"driver_username","运费":"freight_charge","提货时间":"pickup_start_time","提货联系人":"pickup_contact_name","提货地址":"pickup_contact_address","提货联系手机":"pickup_contact_mobile_phone","提货联系固话":"pickup_contact_phone","收货时间":"delivery_start_time","收货联系人":"delivery_contact_name","收货地址":"delivery_contact_address","收货联系手机":"delivery_contact_mobile_phone","收货联系固话":"delivery_contact_phone","品名":"goods_name","件数":"count","件数单位":"count_unit","重量":"weight","重量单位":"weight_unit","体积":"volume","体积单位":"volume_unit","备注":"description","关注人1":"salesman1","关注人2":"salesman2","关注人3":"salesman3","品名1":"goods1","数量1":"count1","单位1":"unit1","品名2":"goods2","数量2":"count2","单位2":"unit2","品名3":"goods3","数量3":"count3","单位3":"unit3","订单号":"original_order_number"},t=[],r=0;r<e.length;r++){var o=e[r];if(!(o["客户"]&&o["客户"].indexOf("本行请保留")>-1)){var i={};for(var a in o)i[n[a]]=o[a];i.pickup_end_time=i.pickup_start_time,i.delivery_end_time=i.delivery_start_time,2===P&&(S(i),y(i)),t.push(i)}}return t}function b(e,n){if(!e)return n();for(var t=0;t<e.length;t++){var r=e[t];if(!r["运单号"])return n({row:t+2,column:E[1],message:"运单号不能为空"});var o;for(var i in r)switch(i){case M[2]:case M[4]:case M[6]:if(!v(r[i]))return o=T.indexOf(i),o===-1&&(o=M.indexOf(i)),n({row:t+2,column:E[o+1],message:i+"必须为数字格式"});break;case T[4]:if(!v(r[i]))return o=$.detail.isVersion2?M.indexOf(i):T.indexOf(i),n({row:t+2,column:E[o+1],message:i+"必须为数字格式"})}}return n()}function I(e){if(!e)return{};for(var n={"品名":"name","数量":"count","单位":"unit","数量2":"count2","单位2":"unit2","数量3":"count3","单位3":"unit3","单价":"price"},t={},r=0;r<e.length;r++){var o=e[r];if(o["品名"]){t[o["运单号"]]||(t[o["运单号"]]=[]);var i={};for(var a in o)"运单号"!==a&&(i[n[a]]=o[a]);i.unit=i.unit||"箱",i.unit2=i.unit2||"吨",i.unit3=i.unit3||"立方",t[o["运单号"]].push(i),$.detail.rowCount++}}return t}function x(e,n){if(!e)return n();for(var t=0;t<e.length;t++){var r=e[t];if(!r["运单号"])return n({row:t+2,column:E[1],message:"运单号不能为空"});if(r["关注人手机号"]&&!r["关注人手机号"].testPhone())return n({row:t+2,column:E[2],message:"数量必须为11位手机号"})}return n()}function D(e){if(!e)return{};for(var n={},t=0;t<e.length;t++){var r=e[t];r["关注人手机号"]&&(n[r["运单号"]]||(n[r["运单号"]]=[]),n[r["运单号"]].push(r["关注人手机号"]),$.salesman.rowCount++)}return n}function O(n){e.data.isUploading=!1,n&&e.$emit(a.onShowAlert,n)}var A=10,P=0;e.data={executeGroups:[],currentGroup:{},isUploading:!1,file:{resultType:"normal",message:"等待上传Excel文件",current_filename:""},formatOrders:[],result:{success:!0,totalCount:0,successCount:0,invalidReceiverCount:0,invalidSenderCount:0,successAssignCount:0},pickup_entrance_force:!1,pickup_photo_force:!1,delivery_entrance_force:!1,delivery_photo_force:!0,isOrderMultiAssign:!1,abnormal_push:{isOpen:!1},pickup_push:{isOpen:!1},create_push:{isOpen:!1},delivery_sign_push:{isOpen:!1},delivery_push:{isOpen:!1},pickup_deferred_duration:0,delivery_early_duration:0},u(l);var L=["客户","发货方","收货方","运单号","参考单号","承运司机","运费","提货时间","提货联系人","提货地址","提货联系手机","提货联系固话","收货时间","收货联系人","收货地址","收货联系手机","收货联系固话","品名","件数","件数单位","重量","重量单位","体积","体积单位","备注"],z=["客户","发货方","收货方","运单号","参考单号","承运司机","运费","提货时间","提货联系人","提货地址","提货联系手机","提货联系固话","收货时间","收货联系人","收货地址","收货联系手机","收货联系固话","备注","关注人1","关注人2","关注人3","品名1","数量1","单位1","品名2","数量2","单位2","品名3","数量3","单位3","订单号"],E={1:"A",2:"B",3:"C",4:"D",5:"E",6:"F",7:"G",8:"H",9:"I",10:"J",11:"K",12:"L",13:"M",14:"N",15:"O",16:"P",17:"Q",18:"R",19:"S",20:"T",21:"U",22:"V",23:"W",24:"X",25:"Y",26:"Z",27:"AA",28:"AB",29:"AC",30:"AD",31:"AE",32:"AF",33:"AG",34:"AH",35:"AI",36:"AJ"};e.pickupEntranceHandle=function(){w()},e.pickupPhotoHandle=function(){w()},e.deliveryEntranceHandle=function(){w()},e.deliveryPhotoHandle=function(){w()},e.multiAssignHandle=function(){e.data.isOrderMultiAssign=!e.data.isOrderMultiAssign},e.clickGroup=function(n){e.data.currentGroup=n},e.progressBar={max:0,dynamic:0,show:function(e){this.max=e,this.dynamic=0},hide:function(){this.max=0,this.dynamic=0},change:function(e){this.dynamic=e}};var $={main:{changeCount:0,buttonText:"从本地上传",resultType:"",message:"",data:[],handleFile:function(){},combineOther:function(){}},detail:{changeCount:0,buttonText:"从本地上传",resultType:"",message:"",rowCount:0,data:{},isVersion2:!1,handleFile:function(){},matchOrder:function(){}},salesman:{changeCount:0,buttonText:"从本地上传",resultType:"",message:"",rowCount:0,data:{},handleFile:function(){},matchOrder:function(){}},init:function(){this.main.changeCount=0,this.main.buttonText="从本地上传",this.main.data=[],this.main.resultType="",this.main.message="上传运单列表",this.detail.changeCount=0,this.detail.buttonText="从本地上传",this.detail.data={},this.detail.resultType="",this.detail.message="添加货物明细表",this.detail.rowCount=0,this.detail.disabled=!0,this.detail.isVersion2=!1,this.salesman.changeCount=0,this.salesman.buttonText="从本地上传",this.salesman.data={},this.salesman.resultType="",this.salesman.message="添加关注人列表",this.salesman.rowCount=0,this.salesman.disabled=!0},reload:function(){this.main.data=[],this.main.resultType="",this.main.message="上传运单列表",this.detail.data={},this.detail.resultType="",this.detail.message="添加货物明细表",this.detail.rowCount=0,this.detail.disabled=!0,this.salesman.data={},this.salesman.resultType="",this.salesman.message="添加关注人列表",this.salesman.rowCount=0,this.salesman.disabled=!0},showResult:function(n,t,r){this[n].resultType=t,this[n].message=r,e.$apply()},getMatchInfo:function(e,n,t){return"成功读取"+e+"条信息，匹配"+n+"条"},changeFile:function(e){this[e].changeCount++,this[e].buttonText="重新上传","main"===e&&(this.detail.changeCount=0,this.detail.buttonText="从本地上传",this.salesman.changeCount=0,this.salesman.buttonText="从本地上传")}};$.init(),e.importOrder=$,$.main.handleFile=function(n){$.changeFile("main"),$.reload(),$.showResult("main","","正在校验Excel文件..."),c(),$.main.data=[];var t=o.getReader();t.getWorkSheet(n,function(n,r){if(e.data.file.current_filename=document.getElementById("main-file-name").value,document.getElementById("main-file-name").outerHTML=document.getElementById("main-file-name").outerHTML,document.getElementById("main-file-name").value="",n)return $.showResult("main","error",n.message);var o=[{key:"A1",value:"客户"},{key:"B1",value:"发货方"},{key:"C1",value:"收货方"},{key:"D1",value:"运单号"},{key:"E1",value:"参考单号"},{key:"F1",value:"承运司机"},{key:"G1",value:"运费"},{key:"H1",value:"提货时间"},{key:"I1",value:"提货联系人"},{key:"J1",value:"提货地址"},{key:"K1",value:"提货联系手机"},{key:"L1",value:"提货联系固话"},{key:"M1",value:"收货时间"},{key:"N1",value:"收货联系人"},{key:"O1",value:"收货地址"},{key:"P1",value:"收货联系手机"},{key:"Q1",value:"收货联系固话"}];t.checkHeader(r,o,function(e){if(!e)return $.showResult("main","error","请选择系统提供的模版填写运单数据");var n=t.isHeaderNameExist(r,{key:"S1",value:"关注人1",index:18}),o=t.isHeaderNameExist(r,{key:"R1",value:"品名",index:17});if(!o&&!n)return $.showResult("main","error","请选择系统提供的模版填写运单数据");var i=n?z:L;P=n?2:1,t.getSheetData(r,i,function(e,n){return e?$.showResult("main","error",e.message):void k(n,function(e){return e?$.showResult("main","error","第"+e.row+"行第"+e.column+"列"+e.message):($.main.data=C(n),$.showResult("main","success","成功读取"+$.main.data.length+"条运单信息"),$.detail.matchOrder(),void $.salesman.matchOrder())})})})})},$.main.combineOther=function(){if(0!==this.data.length){var e=$.detail.data,n=$.salesman.data;(getObjectLength(e)||getObjectLength(n))&&this.data.forEach(function(t){e[t.order_number]&&e[t.order_number].length>0&&(t.goods=e[t.order_number]),n[t.order_number]&&n[t.order_number].length>0&&(t.salesmen=n[t.order_number])})}};var T=["运单号","品名","数量","单位","单价","总额"],M=["运单号","品名","数量","单位","数量2","单位2","数量3","单位3","单价","总额"];$.detail.handleFile=function(e){$.changeFile("detail"),$.showResult("detail","","正在校验Excel文件..."),$.detail.data=[],$.detail.rowCount=0;var n=o.getReader();n.getWorkSheet(e,function(e,t){if(document.getElementById("detail-file-name").outerHTML=document.getElementById("detail-file-name").outerHTML,document.getElementById("detail-file-name").value="",e)return $.showResult("detail","error",e.message);var r=[{key:"A1",value:"运单号"},{key:"B1",value:"品名"},{key:"C1",value:"数量"},{key:"D1",value:"单位"}];n.checkHeader(t,r,function(e){if(!e)return $.showResult("detail","error","请选择系统提供的模版填写货物明细数据");var r=n.isHeaderNameExist(t,{key:"I1",value:"单价",index:8}),o=n.isHeaderNameExist(t,{key:"E1",value:"单价",index:4});return o||r?($.detail.isVersion2=r,void n.getSheetData(t,r?M:T,function(e,n){return e?$.showResult("detail","error",e.message):void b(n,function(e){return e?$.showResult("detail","error","第"+e.row+"行第"+e.column+"列"+e.message):($.detail.data=I(n),$.showResult("detail","success","成功读取"+$.detail.rowCount+"条信息"),void $.detail.matchOrder())})})):$.showResult("detail","error","请选择系统提供的模版填写货物明细数据")})})},$.detail.matchOrder=function(){var e=$.main.data;if(0!==e.length&&this.rowCount){var n=this.data,t={totalCount:0,add:function(e){this.totalCount+=e}},r=0;e.forEach(function(e){n[e.order_number]&&n[e.order_number].length>0&&(r++,t[e.order_number]||(t[e.order_number]=n[e.order_number].length,t.add(n[e.order_number].length)))}),this.rowCount&&$.showResult("detail","success",$.getMatchInfo(this.rowCount,t.totalCount,r))}},$.salesman.handleFile=function(e){$.changeFile("salesman"),$.showResult("salesman","","正在校验Excel文件..."),$.salesman.data=[],$.salesman.rowCount=0;var n=o.getReader();n.getWorkSheet(e,function(e,t){if(document.getElementById("salesman-file-name").outerHTML=document.getElementById("salesman-file-name").outerHTML,document.getElementById("salesman-file-name").value="",e)return $.showResult("salesman","error",e.message);var r=[{key:"A1",value:"运单号"},{key:"B1",value:"关注人手机号"}];n.checkHeader(t,r,function(e){if(!e)return $.showResult("salesman","error","请选择系统提供的模版填写运单关注人数据");var r=["运单号","关注人手机号"];n.getSheetData(t,r,function(e,n){return e?$.showResult("salesman","error",e.message):void x(n,function(e){return e?$.showResult("salesman","error","第"+e.row+"行第"+e.column+"列"+e.message):($.salesman.data=D(n),$.showResult("salesman","success","成功读取"+$.salesman.rowCount+"条信息"),void $.salesman.matchOrder())})})})})},$.salesman.matchOrder=function(){var e=$.main.data;if(0!==e.length&&this.rowCount){var n=this.data,t={totalCount:0,add:function(e){this.totalCount+=e}},r=0;e.forEach(function(e){n[e.order_number]&&n[e.order_number].length>0&&(r++,t[e.order_number]||(t[e.order_number]=n[e.order_number].length,t.add(n[e.order_number].length)))}),this.rowCount&&$.showResult("salesman","success",$.getMatchInfo(this.rowCount,t.totalCount,r))}},e.uploadOrders=function(){if(!e.data.isUploading)return e.data.isUploading=!0,e.data.file.current_filename?0===$.main.data.length?O("没有任何运单信息，请检查文件数据!"):($.main.combineOther(),e.data.currentGroup?void t.getRemainOrderCreateCount().then(function(r){if(r.err)return O("获取订单数量失败");var i;if(i=e.data.isOrderMultiAssign?m($.main.data):g($.main.data),i.length>r.remain)return O("今日还能上传"+r.remain+"张订单, 当前订单数量为"+i.length+"张");d(i);var s=o.splitArray(i,A),c=new Date,l=0;e.progressBar.show(i.length),s.zzEachSeries(function(n,r){t.batchCreate(n,e.data.currentGroup._id).then(function(n){return!n||n.err?r(n.err):(l+=A,e.progressBar.change(l),e.data.result.totalCount+=n.totalCount,e.data.result.successCount+=n.successCount,e.data.result.invalidReceiverCount+=n.invalidReceiverCount,e.data.result.invalidSenderCount+=n.invalidSenderCount,e.data.result.successAssignCount+=n.successAssignCount,r())},function(e){return r(e)})},function(t){if(e.progressBar.hide(),t)return console.log(t),O("上传订单遇到错误");if(e.data.result.totalCount!==i.length)return console.log("total count: ",i.length,"actual upload count: ",e.data.result.totalCount),O("上传订单遇到错误");console.log("-------------batch create time-------------",(new Date).getTime()-c.getTime());var r=e.data.result.totalCount-e.data.result.successCount,o=e.data.result.successAssignCount,s=e.data.result.invalidSenderCount>0?e.data.result.invalidSenderCount+"单的发货方":"",l=e.data.result.invalidReceiverCount>0?e.data.result.invalidReceiverCount+"单的收货方":"",u=s?s+"/"+l:l,d={content_one:(e.data.result.successCount>0?"成功上传"+e.data.result.successCount+"单":"")+(r>0?"，失败"+r+"单":""),content_two:"成功自动分配"+o+"段",content_three:u?u+"未注册柱柱签收":""};e.$emit(a.onShowAlertConfirmStyle,d,p,null,{sureLabel:"去分配",cancelLabel:"继续上传"}),O(),n.go("order_batch_create",{},{reload:!0})})},function(e){O("获取订单数量失败")}):O("请选择操作组")):O("请选择要上传的Excel文件")}}]),angular.module("zhuzhuqs").controller("OrderConfigurationController",["$scope","$stateParams","$timeout","config","CompanyService","BMapService","ExcelReaderService","CompanyError","GlobalEvent",function(e,n,t,r,o,i,a,s,c){function l(e){d=e,e||(e={}),p.options[0].load(e.pickup_option||{}),p.options[1].load(e.delivery_option||{}),p.options[2].load(e.push_option||{})}function u(){e.$emit(c.onShowLoading,!0),o.getConfiguration().then(function(n){return e.$emit(c.onShowLoading,!1),console.log(n),n&&n.err?console.log("get company configuration error"):void l(n)},function(n){e.$emit(c.onShowLoading,!1),console.log(n)})}var d;e.partnersInfo={address:[],curSelect:"orderConfig"},e.partnersInfo.showDetailPanel=function(n){n=n||"orderConfig",e.partnersInfo.curSelect!==n&&(e.partnersInfo.curSelect=n,e.rightHeader.update(n))},e.rightHeader={all:[{name:"推送配置",en:"pushConfig"},{name:"运单配置",en:"orderConfig"}],current:{},update:function(e){for(var n=0;n<this.all.length;n++)if(this.all[n].en===e){this.current=this.all[n];break}}},e.rightHeader.update(e.partnersInfo.curSelect);var p={options:[{title:"提货操作",entrance:{isOpen:!1,title:"强制进场",description:"司机在提货前必须执行进场操作"},entrance_photo:{isOpen:!1,title:"强制进场拍照",description:"司机在进场时必须拍摄照片，您可以自定义进场拍照的步骤",isPlate:!1},entrance_photo_array:[],take_photo:{isOpen:!1,title:"强制提货拍照",description:"司机在提货时必须拍摄照片，您可以自定义提货拍照的步骤",isPlate:!1},take_photo_array:[],confirm_detail:{isOpen:!1,title:"强制货物明细确认",description:"司机在提货时，必须进行货物明细确认"}},{title:"交货操作",entrance:{isOpen:!1,title:"强制进场",description:"司机在交货前必须执行进场操作"},entrance_photo:{isOpen:!1,title:"强制进场拍照",description:"司机在进场时必须拍摄照片，您可以自定义进场拍照的步骤",isPlate:!1},entrance_photo_array:[],take_photo:{isOpen:!1,title:"强制交货拍照",description:"司机在交货时必须拍摄照片，您可以自定义交货拍照的步骤",isPlate:!1},take_photo_array:[],confirm_detail:{isOpen:!1,title:"强制货物明细确认",description:"司机在交货时，必须进行货物明细确认并上报"}},{title:"推送操作",abnormal_push:{isOpen:!1},create_push:{isOpen:!1},delivery_sign_push:{isOpen:!1},pickup_push:{isOpen:!1},delivery_push:{isOpen:!1},pickup_deferred_duration_switch:!1,delivery_early_duration_switch:!1,pickup_deferred_duration:0,delivery_early_duration:0,load:function(e){e&&(this.abnormal_push.isOpen=e.abnormal_push!==!1,this.create_push.isOpen=e.create_push===!0,this.delivery_sign_push.isOpen=e.delivery_sign_push===!0,this.pickup_push.isOpen=e.pickup_push===!0,this.delivery_push.isOpen=!!e.delivery_push,this.pickup_deferred_duration_switch=!!e.pickup_deferred_duration,this.delivery_early_duration_switch=!!e.delivery_early_duration,this.pickup_deferred_duration=(e.pickup_deferred_duration||12).toString(),this.delivery_early_duration=(e.delivery_early_duration||12).toString())},check:function(){var e={success:!0,message:""};return e},getData:function(){var e={};return e.abnormal_push=this.abnormal_push.isOpen,e.create_push=this.create_push.isOpen,e.delivery_sign_push=this.delivery_sign_push.isOpen,e.pickup_push=this.pickup_push.isOpen,e.delivery_push=this.delivery_push.isOpen,this.pickup_deferred_duration_switch?e.pickup_deferred_duration=this.pickup_deferred_duration:e.pickup_deferred_duration=0,this.delivery_early_duration_switch?e.delivery_early_duration=this.delivery_early_duration:e.delivery_early_duration=0,e}}],submitOrderConfig:function(){},submitPushConfig:function(){}};e.orderConfig=p,p.submitOrderConfig=function(){var n=p.options[0].getData(),t=p.options[1].getData();return n.err?e.$emit(c.onShowAlert,n.err):t.err?e.$emit(c.onShowAlert,t.err):n.isModify||t.isModify?(e.$emit(c.onShowLoading,!0),void o.updateOrderConfiguration({pickup_option:n.config,delivery_option:t.config}).then(function(n){return e.$emit(c.onShowLoading,!1),console.log(n),!n||n.err?console.log("update company order configuration failed"):(l(n),e.$emit(c.onShowAlert,"保存成功"))},function(n){e.$emit(c.onShowLoading,!1),console.log(n)})):e.$emit(c.onShowAlert,"没有任何更改")},p.submitPushConfig=function(){var n=this.options[2],t=n.check();return t.success?(e.$emit(c.onShowLoading,!0),void o.updatePushConfiguration({push_option:n.getData()}).then(function(n){return e.$emit(c.onShowLoading,!1),console.log(n),!n||n.err?console.log("update company push configuration failed"):(l(n),e.$emit(c.onShowAlert,"保存成功"))},function(n){e.$emit(c.onShowLoading,!1),console.log(n)})):e.$emit(c.onShowAlert,t.message)},u()}]),angular.module("zhuzhuqs").controller("OrderCreateController",["$scope","$stateParams","$state","$timeout","CompanyService","OrderService","SalesmanService","OrderError","GroupError","GlobalEvent","UserProfileService",function(e,n,t,r,o,i,a,s,c,l,u){function d(n){e.orderInfo={order_id:n.order_id,order_number:n.order_number,refer_order_number:n.refer_order_number,original_order_number:n.original_order_number,goods_name:n.goods_name,count:n.count||"",weight:n.weight||"",volume:n.volume||"",count_unit:n.count_unit,weight_unit:n.weight_unit,volume_unit:n.volume_unit,freight_charge:n.freight_charge||"",sender_name:n.sender_name,sender_company_id:"",receiver_name:n.receiver_name,receiver_company_id:"",salesmen:[],goods:[],customer_name:n.customer_name,pickup_start_time:n.pickup_start_time,delivery_start_time:n.delivery_start_time,pickup_end_time:n.pickup_end_time,delivery_end_time:n.delivery_end_time,description:n.description,group_id:n.group_id,pickup_entrance_force:n.pickup_entrance_force,pickup_photo_force:n.pickup_photo_force,delivery_entrance_force:n.delivery_entrance_force,delivery_photo_force:n.delivery_photo_force,pickup_deferred_duration:n.pickup_deferred_duration,delivery_early_duration:n.delivery_early_duration,pickup_contact_name:n.pickup_contact_name,pickup_contact_phone:n.pickup_contact_phone||"",pickup_contact_mobile_phone:n.pickup_contact_mobile_phone||"",pickup_contact_address:n.pickup_contact_address,pickup_contact_email:"",delivery_contact_name:n.delivery_contact_name,delivery_contact_phone:n.delivery_contact_phone||"",delivery_contact_mobile_phone:n.delivery_contact_mobile_phone||"",delivery_contact_address:n.delivery_contact_address,delivery_contact_email:""},n.goods&&(e.orderInfo.goods=n.goods),n.salesmen&&(e.orderInfo.salesmen=n.salesmen),n.receiver_company&&(n.receiver_company.company_id&&(e.orderInfo.receiver_company_id=n.receiver_company.company_id),n.receiver_company.company_name&&(e.receiverInfo.currentChoice={},e.receiverInfo.currentChoice.key=n.receiver_company.company_id,e.receiverInfo.currentChoice.value=n.receiver_company.company_name,e.receiverInfo.currentText=n.receiver_company.company_name)),!e.receiverInfo.currentText&&n.receiver_name&&(e.receiverInfo.currentText=n.receiver_name),n.sender_company&&(n.sender_company.company_id&&(e.orderInfo.sender_company_id=n.sender_company.company_id),n.sender_company.company_name&&(e.senderInfo.currentChoice={},e.senderInfo.currentChoice.key=n.sender_company.company_id,e.senderInfo.currentChoice.value=n.sender_company.company_name,e.senderInfo.currentText=n.sender_company.company_name)),!e.senderInfo.currentText&&n.sender_name&&(e.senderInfo.currentText=n.sender_name),n.pickup_start_time||n.pickup_end_time?e.pageShow.pickUpTimeRange={startDate:n.pickup_start_time?n.pickup_start_time:null,endDate:n.pickup_end_time?n.pickup_end_time:null}:e.pageShow.pickUpTimeRange="",n.delivery_start_time||n.delivery_end_time?e.pageShow.deliveryTimeRange={startDate:n.delivery_start_time?n.delivery_start_time:null,endDate:n.delivery_end_time?n.delivery_end_time:null}:e.pageShow.deliveryTimeRange="",e.pushConfig.order_transport_type=n.order_transport_type,e.pushConfig.abnormal_push.isOpen=n.abnormal_push,e.pushConfig.pickup_push.isOpen=n.pickup_push,e.pushConfig.create_push.isOpen=n.create_push,e.pushConfig.delivery_sign_push.isOpen=n.delivery_sign_push,e.pushConfig.delivery_push.isOpen=n.delivery_push}function p(){e.order.submit_name="创建这张订单",e.orderInfo={order_number:"",refer_order_number:"",original_order_number:"",goods_name:"",count:"",weight:"",volume:"",count_unit:"箱",weight_unit:"吨",volume_unit:"立方",freight_charge:"",salesmen:[],goods:[],customer_name:"",pickup_start_time:"",delivery_start_time:"",pickup_end_time:"",delivery_end_time:"",description:"",group_id:"",sender_name:"",sender_company_id:"",receiver_name:"",receiver_company_id:"",pickup_entrance_force:!1,pickup_photo_force:!1,delivery_entrance_force:!1,delivery_photo_force:!0,pickup_deferred_duration:0,delivery_early_duration:0,pickup_contact_name:"",pickup_contact_phone:"",pickup_contact_mobile_phone:"",pickup_contact_address:"",pickup_contact_email:"",delivery_contact_name:"",delivery_contact_phone:"",delivery_contact_mobile_phone:"",delivery_contact_address:"",delivery_contact_email:""}}function f(){e.$emit(l.onShowLoading,!0),b?"normal"===I?i.updateUnAssignedOrder(e.orderInfo,e.newInfo.currentGroup._id).then(function(n){return e.$emit(l.onShowLoading,!1),console.log(n),n.err?void _(n.err.type):(e.$emit(l.onShowAlert,"订单修改成功"),void t.go("order_assign"))},function(e){}):i.updateAssignedOrder(e.orderInfo,e.newInfo.currentGroup._id).then(function(n){return e.$emit(l.onShowLoading,!1),console.log(n),n.err?void _(n.err.type):(e.$emit(l.onShowAlert,"订单修改成功"),void t.go("order_follow"))},function(e){}):i.createOrder(e.orderInfo,e.newInfo.currentGroup._id).then(function(n){return e.$emit(l.onShowLoading,!1),console.log(n),n.err?void _(n.err.type):(t.go("order_create",{},{reload:!0}),void e.$emit(l.onShowAlertConfirm,"订单创建成功",h,null,{sureLabel:"去分配",cancelLabel:"继续创建"}))},function(e){})}function h(){t.go("order_assign")}function m(n){o.getExecuteGroupList().then(function(t){if(console.log(t),t.err)y(t.err.type);else if(e.executeGroups=t,e.executeGroups.length>0)if(b){for(var r=0;r<e.executeGroups.length;r++)if(e.executeGroups[r]._id===x.group_id){e.clickGroup(e.executeGroups[r]);break}}else e.clickGroup(e.executeGroups[0]);return n()},function(e){return console.log("getGroupList error:"+e),n()})}function g(){u.getUserProfile().then(function(n){if(console.log(n),n.err)return _(n.err.type);if(n.user_profile){if(e.orderInfo.pickup_entrance_force=n.user_profile.pickup_entrance_force,e.orderInfo.pickup_photo_force=n.user_profile.pickup_photo_force,e.orderInfo.delivery_entrance_force=n.user_profile.delivery_entrance_force,e.orderInfo.delivery_photo_force=n.user_profile.delivery_photo_force,n.user_profile.order_execute_group&&!b&&e.executeGroups.length>0)for(var t=0;t<e.executeGroups.length;t++)if(e.executeGroups[t]._id.toString()===n.user_profile.order_execute_group){
e.clickGroup(e.executeGroups[t]);break}}else e.orderInfo.pickup_entrance_force=!1,e.orderInfo.pickup_photo_force=!1,e.orderInfo.delivery_entrance_force=!1,e.orderInfo.delivery_photo_force=!0},function(e){console.log(e)}),o.getConfiguration().then(function(n){return console.log(n),n&&n.err?console.log("get company configuration error"):void(!b&&n&&n.push_option&&(e.pushConfig.abnormal_push.isOpen=n.push_option.abnormal_push,e.pushConfig.pickup_push.isOpen=n.push_option.pickup_push,e.pushConfig.create_push.isOpen=n.push_option.create_push,e.pushConfig.delivery_sign_push.isOpen=n.push_option.delivery_sign_push,e.pushConfig.delivery_push.isOpen=n.push_option.delivery_push,e.orderInfo.pickup_deferred_duration=n.push_option.pickup_deferred_duration,e.orderInfo.delivery_early_duration=n.push_option.delivery_early_duration))},function(e){console.log(e)})}function v(){t.go("order_configuration")}function _(n){s[n]?e.$emit(l.onShowAlert,s[n]):e.$emit(l.onShowAlert,n+" 未知错误！请联系管理员")}function y(n){c[n]?e.$emit(l.onShowAlert,c[n]):e.$emit(l.onShowAlert,n+" 未知错误！请联系管理员")}function S(n){n?(e.orderInfo.sender_company_id=n.key,e.orderInfo.sender_name=n.value):(e.orderInfo.sender_company_id="",e.orderInfo.sender_name="")}function w(n){n?(e.orderInfo.receiver_company_id=n.key,e.orderInfo.receiver_name=n.value):(e.orderInfo.receiver_company_id="",e.orderInfo.receiver_name="")}function k(n){n.key&&(e.salesInfo.hasSelected[n.key]&&delete e.salesInfo.hasSelected[n.key],e.salesInfo.unableOption(n.key,!1),e.salesInfo.updateAddStatus(),delete n.key)}function C(n,t){t=t||this,t.currentChoice?(k(t),t.key=t.currentChoice.key,e.salesInfo.hasSelected[t.currentChoice.key]=t.currentChoice.value,e.salesInfo.unableOption(t.currentChoice.key,!0),e.salesInfo.updateAddStatus()):(k(t),t.currentText&&t.currentText.testPhone()&&(t.key=t.currentText,e.salesInfo.hasSelected[t.currentText]=t.currentText,e.salesInfo.updateAddStatus()))}console.log(t),console.log(n),e.orderInfo={},e.order={submit_name:""},e.executeGroups=[],e.newInfo={showWarnning:!1,currentGroup:{}},e.pageShow={pickUpTimeRange:"",deliveryTimeRange:"",pickUpMinTime:moment().format("YY/MM/DD HH:mm"),deliveryMinTime:moment().format("YY/MM/DD HH:mm"),count_unit:["箱","托","桶","包","个","瓶","只","TK","其他"],weight_unit:["吨","公斤"],volume_unit:["立方","升","尺","20尺","40尺"],dateOptions:{locale:{fromLabel:"起始时间",toLabel:"结束时间",cancelLabel:"取消",applyLabel:"确定",customRangeLabel:"区间",daysOfWeek:["日","一","二","三","四","五","六"],firstDay:1,monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]},timePicker:!0,timePicker12Hour:!1,timePickerIncrement:1,separator:" ~ ",singleDatePicker:!0,autoApply:!0,format:"YY/MM/DD HH:mm"}},e.senderInfo={enableEdit:!0,defaultContent:"搜索发货方",currentText:"",currentChoice:"",options:[],onSelected:S},e.receiverInfo={enableEdit:!0,defaultContent:"搜索收货方",currentText:"",currentChoice:"",options:[],onSelected:w},e.pushConfig={order_transport_type:"ltl",abnormal_push:{isOpen:!1},pickup_push:{isOpen:!1},create_push:{isOpen:!1},delivery_sign_push:{isOpen:!1},delivery_push:{isOpen:!1}};var b=""!==n.order,I=n.modify_type||"normal";if(console.log("stateParams.order:=========="),console.log(n.order),b){e.order.submit_name="修改这张订单";try{var x=JSON.parse(n.order);console.log(x),console.log("orderInfo:=========="),d(x)}catch(D){e.$emit(l.onShowAlert,"修改参数解析错误！")}}else e.order.submit_name="创建这张订单",p();e.clickPage=function(){e.customerInfo.showPanel=!1,e.pickupContactInfo.showPanel=!1,e.deliveryContactInfo.showPanel=!1},e.clickCustomer=function(n){e.orderInfo.customer_name=n},e.customerInfo={customers:[],isGetting:!1,showPanel:!1},e.getCustomersByKeyword=function(){e.customerInfo.isGetting||(e.customerInfo.isGetting=!0,e.customerInfo.showPanel=!0,r(function(){o.getCompanyCustomersByFilter({customer_name:e.orderInfo.customer_name}).then(function(n){console.log(n),e.customerInfo.customers=n,e.customerInfo.isGetting=!1},function(n){console.log(n),e.customerInfo.customers=[],e.customerInfo.isGetting=!1})},500))},e.pickupContactInfo={contacts:[],isGetting:!1,showPanel:!1},e.deliveryContactInfo={contacts:[],isGetting:!1,showPanel:!1},e.clickContactItem=function(n,t){t?e.orderInfo.pickup_contact_address=n.brief||n.detail:e.orderInfo.delivery_contact_address=n.brief||n.detail},e.getContractsByKeyword=function(n){if(!e.pickupContactInfo.isGetting&&!e.deliveryContactInfo.isGetting){var t;if(n){if(!e.orderInfo.pickup_contact_address)return void(e.pickupContactInfo.contacts=[]);e.pickupContactInfo.isGetting=!0,e.pickupContactInfo.showPanel=!0,t={address:e.orderInfo.pickup_contact_address}}else{if(!e.orderInfo.delivery_contact_address)return void(e.pickupContactInfo.contacts=[]);e.deliveryContactInfo.isGetting=!0,e.deliveryContactInfo.showPanel=!0,t={address:e.orderInfo.delivery_contact_address}}r(function(){n&&e.senderInfo.currentText?i.getSenderPickupAddressList(e.senderInfo.currentText,t.address).then(function(n){n.err?(console.log(n.err),e.pickupContactInfo.contacts=[]):(n=n.map(function(e){return{detail:e}}),e.pickupContactInfo.contacts=n),e.pickupContactInfo.isGetting=!1,e.deliveryContactInfo.isGetting=!1},function(n){console.log(n),e.pickupContactInfo.contacts=[],e.pickupContactInfo.isGetting=!1,e.deliveryContactInfo.isGetting=!1}):o.getContactsByFilter(t).then(function(n){console.log(n),e.pickupContactInfo.contacts=n,e.pickupContactInfo.isGetting=!1,e.deliveryContactInfo.isGetting=!1},function(n){console.log(n),e.pickupContactInfo.contacts=[],e.pickupContactInfo.isGetting=!1,e.deliveryContactInfo.isGetting=!1})},1e3)}},e.clickGroup=function(n){e.newInfo.currentGroup=n},e.submitOrder=function(n){var t=n.$valid;if(e.validates||(e.validates={}),e.orderInfo.receiver_name||e.receiverInfo.currentText||(t=!1),e.orderInfo.sender_name||e.senderInfo.currentText||(t=!1),e.pageShow.pickUpTimeRange||(t=!1,e.new_order["pageShow.pickUpTimeRange"].$setValidity("required",!1)),e.pageShow.deliveryTimeRange||(t=!1,e.new_order["pageShow.deliveryTimeRange"].$setValidity("required",!1)),!t)return void(e.submitted=!0);if(!e.orderInfo.receiver_name&&e.receiverInfo.currentText&&(e.orderInfo.receiver_name=e.receiverInfo.currentText),!e.orderInfo.sender_name&&e.senderInfo.currentText&&(e.orderInfo.sender_name=e.senderInfo.currentText),e.orderInfo.salesmen=[],getObjectLength(e.salesInfo.hasSelected)>0)for(var r in e.salesInfo.hasSelected)for(var o=0,i=e.salesInfo.options.length;o<i;o++)if(e.salesInfo.hasSelected[r]===e.salesInfo.options[o].value){e.orderInfo.salesmen.push(e.salesInfo.options[o].username);break}return e.orderInfo.goods=e.goodsInfo.getValidGoods(),e.orderInfo.goods_name=e.orderInfo.goods[0].name,e.orderInfo.count=e.orderInfo.goods[0].count,e.orderInfo.count_unit=e.orderInfo.goods[0].unit,e.orderInfo.volume="",e.orderInfo.volume_unit="立方",e.orderInfo.weight="",e.orderInfo.weight_unit="吨",e.orderInfo.pickup_contact_address&&e.orderInfo.delivery_contact_address&&e.orderInfo.pickup_contact_address===e.orderInfo.delivery_contact_address?void e.$emit(l.onShowAlert,"提货地址和交货地址不能相同！"):e.orderInfo.delivery_contact_mobile_phone&&11!=e.orderInfo.delivery_contact_mobile_phone.length?void e.$emit(l.onShowAlert,"交货手机号码必须11位！"):e.orderInfo.pickup_contact_mobile_phone&&11!=e.orderInfo.pickup_contact_mobile_phone.length?void e.$emit(l.onShowAlert,"提货手机号码必须11位！"):(e.pageShow.pickUpTimeRange.startDate&&(e.orderInfo.pickup_start_time=moment(e.pageShow.pickUpTimeRange.startDate).toISOString()),e.pageShow.pickUpTimeRange.endDate&&(e.orderInfo.pickup_end_time=moment(e.pageShow.pickUpTimeRange.endDate).toISOString()),e.pageShow.deliveryTimeRange.startDate&&(e.orderInfo.delivery_start_time=moment(e.pageShow.deliveryTimeRange.startDate).toISOString()),e.pageShow.deliveryTimeRange.endDate&&(e.orderInfo.delivery_end_time=moment(e.pageShow.deliveryTimeRange.endDate).toISOString()),e.orderInfo.order_transport_type=e.pushConfig.order_transport_type,e.orderInfo.abnormal_push=e.pushConfig.abnormal_push.isOpen,e.orderInfo.pickup_push=e.pushConfig.pickup_push.isOpen,e.orderInfo.create_push=e.pushConfig.create_push.isOpen,e.orderInfo.delivery_sign_push=e.pushConfig.delivery_sign_push.isOpen,e.orderInfo.delivery_push=e.pushConfig.delivery_push.isOpen,void f())},m(g),e.pickupEntranceHandle=function(){v()},e.pickupPhotoHandle=function(){v()},e.deliveryEntranceHandle=function(){v()},e.deliveryPhotoHandle=function(){v()},e.goodsInfo={goods:[],unitOptions:[{name:"件数",value:["箱","托","桶","包","个","瓶","只","TK","其他"]},{name:"重量",value:["吨","公斤"]},{name:"体积",value:["立方","升","尺","20尺","40尺"]}],itemTemplate:{name:"",count:1,unit:"箱",count2:"",unit2:"吨",count3:"",unit3:"立方",price:"",canDelete:!0,isShowOption:!1,isShowOption2:!1,isShowOption3:!1,increaseCount1:function(){this.count=this.increase(this.count)},decreaseCount1:function(){this.count=this.decrease(this.count)},increaseCount2:function(){this.count2=this.increase(this.count2)},decreaseCount2:function(){this.count2=this.decrease(this.count2)},increaseCount3:function(){this.count3=this.increase(this.count3)},decreaseCount3:function(){this.count3=this.decrease(this.count3)},increase:function(e){return e=parseFloat(e)||0,e++,e},decrease:function(e){return e=parseFloat(e)||0,e--,e<0&&(e=0),e},changeText:function(){e.goodsInfo.updateAddStatus()},clickUnit:function(n,t){e.goodsInfo.goods.forEach(function(e){e.isShowOption=!1,e.isShowOption2=!1,e.isShowOption3=!1}),this[n]=!0,stopBubble(t)},clickUnit1:function(e){this.clickUnit("isShowOption",e)},clickUnit2:function(e){this.clickUnit("isShowOption2",e)},clickUnit3:function(e){this.clickUnit("isShowOption3",e)}},canAdd:!1,init:function(){this.goods=[],this.canAdd=!1},updateAddStatus:function(){this.canAdd=0===this.goods.filter(function(e){return!e.name}).length},addGoodsItem:function(e){e=e||deepCopy(this.itemTemplate),this.goods.push(e)},addPageGoodsItem:function(){this.canAdd&&(this.addGoodsItem(),this.updateAddStatus())},removeGoodsItem:function(e){this.goods.splice(e,1),this.updateAddStatus()},getValidGoods:function(){var e=this.goods.filter(function(e){return e.name&&e.name.length>0});return 0===e.length?e.push({name:"",count:"",unit:"箱",count2:"",unit2:"吨",count3:"",unit3:"立方",price:""}):e=e.map(function(e){return{name:e.name,count:e.count,unit:e.unit,count2:e.count2||"",unit2:e.unit2||"吨",count3:e.count3||"",unit3:e.unit3||"立方",price:e.price||""}}),e}},e.salesInfo={boxInfo:[],hasSelected:{},selectInfo:{canDelete:!0,enableEdit:!0,defaultContent:"搜索关注人",currentText:"",currentChoice:"",options:[],onSelected:C},options:[],canAdd:!1,init:function(){this.boxInfo=[],this.hasSelected={},this.options=[],this.canAdd=!1},addBox:function(e,n){n=n||deepCopy(this.selectInfo);var t=this.boxInfo.push(n);this.boxInfo[t-1].options=this.options,this.boxInfo[t-1].canDelete=e,this.updateAddStatus()},addPageBox:function(){this.canAdd&&this.addBox(!0)},removeBox:function(e){if(e<this.boxInfo.length){var n=this.boxInfo.splice(e,1)[0];k(n),this.updateAddStatus()}},unableOption:function(e,n){if(e)for(var t=0;t<this.options.length;t++)if(this.options[t].key===e){this.options[t].unable=n;break}},updateAddStatus:function(){this.canAdd=this.boxInfo.length===getObjectLength(this.hasSelected)}},function(){e.$emit(l.onShowLoading,!0),o.getPartnerCompanys().then(function(n){return e.$emit(l.onShowLoading,!1),n.err?void _(n.err.type):void(n.partnerCompany&&n.partnerCompany.length>0&&n.partnerCompany.forEach(function(n){n.company._id?(e.receiverInfo.options.push({key:n.company._id,value:n.company.name}),e.senderInfo.options.push({key:n.company._id,value:n.company.name})):n.partner._id&&(e.receiverInfo.options.push({key:n.partner._id,value:n.partner.name}),e.senderInfo.options.push({key:n.partner._id,value:n.partner.name}))}))},function(n){console.log(n),e.$emit(l.onShowLoading,!1)}),e.$emit(l.onShowLoading,!0),a.getBasicList().then(function(n){if(e.$emit(l.onShowLoading,!1),n.err)return _(n.err.type);if(e.salesInfo.init(),n&&n.forEach(function(n){e.salesInfo.options.push({key:n._id,value:n.nickname?n.username+"("+n.nickname+")":n.username,username:n.username,unable:!1})}),e.salesInfo.options.length>0&&e.orderInfo.salesmen.length>0){for(var t=0,r=0;r<e.salesInfo.options.length;r++){if(e.orderInfo.salesmen.indexOf(e.salesInfo.options[r].username)>-1){var o=deepCopy(e.salesInfo.selectInfo);o.currentText=e.salesInfo.options[r].value,o.currentChoice=e.salesInfo.options[r],e.salesInfo.addBox(!0,o),C(null,o),t++}if(e.orderInfo.salesmen.length===t)break}e.salesInfo.boxInfo.length>0&&(e.salesInfo.boxInfo[0].canDelete=!1)}e.salesInfo.boxInfo.length<=0&&e.salesInfo.addBox(!1)},function(n){console.log(n),e.$emit(l.onShowLoading,!1),_("error")}),e.goodsInfo.init(),e.orderInfo.goods.length>0&&e.orderInfo.goods.forEach(function(n){var t=deepCopy(e.goodsInfo.itemTemplate);t.name=n.name||"",t.count=n.count||"",t.unit=n.unit||"箱",t.count2=n.count2||"",t.unit2=n.unit2||"吨",t.count3=n.count3||"",t.unit3=n.unit3||"立方",t.price=n.price||"",e.goodsInfo.addGoodsItem(t)}),0===e.goodsInfo.goods.length&&e.goodsInfo.addGoodsItem(),e.goodsInfo.goods[0].canDelete=!1,e.goodsInfo.updateAddStatus()}(),e.$on(l.onBodyClick,function(){e.goodsInfo.goods.length>0&&e.goodsInfo.goods.forEach(function(e){e.isShowOption=!1,e.isShowOption2=!1,e.isShowOption3=!1})})}]),angular.module("zhuzhuqs").controller("OrderExportController",["$scope","$rootScope","OrderService","GlobalEvent","CompanyService","OnlineReportConfigService","Auth",function(e,n,t,r,o,i,a){e.exportInfo={isShow:!1,isOnTime:"",damaged:"",order_transport_type:"",timeOptions:[{val:1,label:"一天以内"},{val:3,label:"三天以内"},{val:7,label:"一周以内"},{val:30,label:"一月以内"}],companyPartnerOptions:[],customerOptions:[],time:1,partner:"",customer:"",showTimePanel:!1,fields:["发货方","收货方","运单号","创建时间","分配时间","提货进场时间","交货进场时间","中途事件","参考单号","品名","运费","状态","司机姓名","司机手机","司机车牌","承运商","件数","件数单位","重量","重量单位","体积","体积单位","实际提货时间","实际交货时间","计划提货时间","计划交货时间","提货联系人","提货联系手机","提货联系固话","提货地址","交货联系人","交货联系手机","交货联系固话","交货地址","关注人","备注","提货进场拍照","提货拍照","交货进场拍照","交货拍照","中途事件拍照","实收货物","实收数量","货缺","货损","类型","问题运单推送","创建运单通知","发货通知","到货通知","送达通知"]},e.time={queryLogTimeRange:{startDate:new Date(moment().add(-1,"day")),endDate:new Date(moment())},queryLogMaxTime:moment(),dateOptions:{locale:{fromLabel:"起始",toLabel:"结束",cancelLabel:"取消",applyLabel:"确定",customRangeLabel:"区间",daysOfWeek:["日","一","二","三","四","五","六"],firstDay:1,monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]},timePicker:!0,timePicker12Hour:!1,timePickerIncrement:1,separator:"~",format:"YYYY-MM-DD HH:mm:ss"}},n.$on(r.onShowExportDialog,function(n,t){i.getOrderExportReportConfig().then(function(n){var t;n&&n.fields&&(t=n.fields.split(",")),t&&0!=t.length||(t=e.exportInfo.fields);for(var r=0,o=t.length;r<o;r++){var i=t[r];jQuery(".order-columns-config input[name=order_fields][value="+i+"]").attr("checked","checked")}}),e.showDialog()}),e.selectOnTime=function(n){e.exportInfo.isOnTime=n},e.selectDamage=function(n){e.exportInfo.damaged=n},e.showDialog=function(){e.exportInfo.isShow=!0,e.getPartner(),e.getCustomer()},e.hideDialog=function(){e.exportInfo.isShow=!1},e.getPartner=function(){o.getPartnerCompanys().then(function(n){e.exportInfo.companyPartnerOptions=n.partnerCompany,console.log(n)},function(e){console.log(e)})},e.getCustomer=function(){o.getCompanyCustomers().then(function(n){e.exportInfo.customerOptions=n,console.log(n)},function(e){console.log(e)})},e.exportOrders=function(){var n=jQuery(".order-columns-config input[name=order_fields]:checkbox:checked").map(function(){return $(this).val()}).get();if(!n||n.length<1)return void e.$emit(r.onShowAlert,"请选择导出项");var t={startDate:moment(e.time.queryLogTimeRange.startDate).toISOString(),endDate:moment(e.time.queryLogTimeRange.endDate).toISOString(),damaged:e.exportInfo.damaged,isOnTime:e.exportInfo.isOnTime,partner_id:e.exportInfo.partner,customer_name:e.exportInfo.customer,order_transport_type:e.exportInfo.order_transport_type,fields:n.join(",")};e.hideDialog();var o="";for(var i in t){var s=t[i];if(s instanceof Array)for(var c in s)o+=i+"="+s[c]+"&";else o+=i+"="+t[i]+"&"}var l="/order/export?"+o+"access_token="+a.getToken();window.open(l)}}]),angular.module("zhuzhuqs").controller("OrderFollowController",["$state","$scope","OrderService","BMapService","GlobalEvent","config","AudioPlayer","OrderError","UserProfileService","Auth","OrderHelper",function(e,n,t,r,o,i,a,s,c,l,u){var d={selectOptions:[{key:"运单号",value:{name:"运单号",value:"order_number",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!0},{key:"参考单号",value:{name:"参考单号",value:"ref_number",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!0},{key:"订单号",value:{name:"订单号",value:"original_order_number",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!1},{key:"货物名称",value:{name:"货物名称",value:"goods_name",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!0},{key:"承运商",value:{name:"承运商",value:"execute_company",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!0},{key:"司机",value:{name:"司机",value:"execute_driver",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!0},{key:"发货方",value:{name:"发货方",value:"sender_name",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!0},{key:"收货方",value:{name:"收货方",value:"receiver_name",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!0},{key:"货损信息",value:{name:"货损信息",value:"damage",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"备注",value:{name:"备注",value:"description",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"状态",value:{name:"状态",value:"status",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!1},{key:"分配时间",value:{name:"分配时间",value:"assign_time",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"进场时间",value:{name:"进场时间",value:"entrance_time",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"中途事件",value:{name:"中途事件",value:"halfway",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!1},{key:"司机确认",value:{name:"司机确认",value:"confirm",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!1}],getOrderList:function(e,n,r,o,i){return t.getAllOrders(e,n,r,o,i)}};new OrderFollow(e,n,t,r,o,i,a,s,c,l,u,d)}]),angular.module("zhuzhuqs").controller("OrderModifyAssignController",["$scope","$state","$stateParams","GlobalEvent","OrderService","CompanyService","OrderError",function(e,n,t,r,o,i,a){function s(){e.$emit(r.onShowLoading,!0),l(function(n){p(function(t){var o=g(n,t);e.selectData=o,e.rangeTimePanel=e.zzRangeDatePicker,f(b,o.executeSelectData,o.executeWarehouseSelectData,function(n){return n?C(n):void e.$emit(r.onShowLoading,!1)})})})}function c(e,n){var t=e.partner._id?e.partner:e.company;return!t.auth_status||"authed"!==t.auth_status}function l(e){i.getPartnerCompanys().then(function(n){return n.err?C(n.err.type):(n.partnerCompany.sort(c),e?e(n.partnerCompany):void 0)},function(e){})}function u(e){!e||e.length<=0||e.forEach(function(e){var n=e.driver.all_count.evaluationCount,t=n.good+n.general+n.bad;t<10?e.driver.goodEvaluation=0:e.driver.goodEvaluation=Math.ceil(100*n.good/t),e.driver.goodEvaluation>=80?e.driver.evaluationLevel=3:e.driver.goodEvaluation>=60&&e.driver.goodEvaluation<80?e.driver.evaluationLevel=2:e.driver.evaluationLevel=1})}function d(e,n){return!(e.driver.evaluationLevel>n.driver.evaluationLevel)&&(e.driver.evaluationLevel!==n.driver.evaluationLevel||!(e.driver.all_count.orderCount>n.driver.all_count.orderCount))}function p(e){i.getPartnerDrivers().then(function(n){return console.log(n),n.err?C(n.err.type):(u(n.driverCompanys),n.driverCompanys.sort(d),e?e(n.driverCompanys):void 0)},function(e){})}function f(n,t,r,i){o.getOrderById(n).then(function(n){e.order=n;for(var o=0;o<n.assigned_infos.length;o++)e.assign_infos.push(v(n.assigned_infos[o]));h(e.assign_infos,t,r),i&&i()},function(e){return console.log(e),i(e)})}function h(e,n,t){if(!(e.length<=0))for(var r=0;r<=e.length;r++)m(e[r],n,t)}function m(e,n,t){e&&(e.onSelected=w,e.pickupTimeRange={startDate:e.pickup_start_time?new Date(e.pickup_start_time):null,endDate:e.pickup_end_time?new Date(e.pickup_end_time):null},e.deliveryTimeRange={startDate:e.delivery_start_time?new Date(e.delivery_start_time):null,endDate:e.delivery_end_time?new Date(e.delivery_end_time):null},e.defaultContent="搜索合作公司或司机","driver"===e.type?(e.options=n,e.currentChoice=k(e.driver_id,e.options)):"warehouse"===e.type?(e.options=t,e.currentChoice=k(e.driver_id,e.options),e.defaultContent="搜索仓库管理员"):(e.options=n,e.currentChoice=k(e.company_id,e.options)))}function g(e,n){var t=[],r=[];t.push({key:null,value:"合作公司"});for(var o=0;o<e.length;o++){var i=e[o];t.push({key:i.partner._id?i.partner._id:i.company._id,value:i.partner.name?i.partner.name:i.company.name,authed:i.partner.auth_status?"authed"===i.partner.auth_status:"authed"===i.company.auth_status,group_type:"company"})}t.push({key:null,value:"合作司机"}),r.push({key:null,value:"仓库管理员"});for(var o=0;o<n.length;o++)t.push({key:n[o].driver._id,value:(""===n[o].driver.nickname?"匿名":n[o].driver.nickname)+"("+n[o].driver.all_count.orderCount+"单)/"+(n[o].driver.plate_numbers.length>0?n[o].driver.plate_numbers[0]:"未知车牌")+"/"+n[o].driver.username,goodEvaluation:n[o].driver.goodEvaluation,group_type:"driver"}),r.push({key:n[o].driver._id,value:(""===n[o].driver.nickname?"匿名":n[o].driver.nickname)+"/"+n[o].driver.username,group_type:"warehouse"});return{executeSelectData:t,executeWarehouseSelectData:r}}function v(e){if("object"!=typeof e)return e;if(null==e)return e;var n=new Object;for(var t in e)n[t]=v(e[t]);return n}function _(){for(var n=!1,t=0;t<e.assign_infos.length;t++){var r=e.assign_infos[t],o=e.order.assigned_infos[t];y(r,o)&&(n=!0)}return{newAssignInfos:e.assign_infos,isChanged:n}}function y(e,n){return e.pickup_contact_name!==n.pickup_contact_name&&(e.basicInfoChanged=!0),e.pickup_contact_phone!==n.pickup_contact_phone&&(e.basicInfoChanged=!0),e.pickup_contact_mobile_phone!==n.pickup_contact_mobile_phone&&(e.basicInfoChanged=!0),e.pickup_contact_address!==n.pickup_contact_address&&(e.basicInfoChanged=!0),e.pickup_contact_email!==n.pickup_contact_email&&(e.basicInfoChanged=!0),e.delivery_contact_name!==n.delivery_contact_name&&(e.basicInfoChanged=!0),e.delivery_contact_phone!==n.delivery_contact_phone&&(e.basicInfoChanged=!0),e.delivery_contact_mobile_phone!==n.delivery_contact_mobile_phone&&(e.basicInfoChanged=!0),e.delivery_contact_address!==n.delivery_contact_address&&(e.basicInfoChanged=!0),e.delivery_contact_email!==n.delivery_contact_email&&(e.basicInfoChanged=!0),(e.pickup_start_time||n.pickup_start_time)&&(e.pickup_start_time&&n.pickup_start_time?new Date(e.pickup_start_time).toString()!==new Date(n.pickup_start_time).toString()&&(e.basicInfoChanged=!0):e.basicInfoChanged=!0),(e.pickup_end_time||n.pickup_end_time)&&(e.pickup_end_time&&n.pickup_end_time?new Date(e.pickup_end_time).toString()!==new Date(n.pickup_end_time).toString()&&(e.basicInfoChanged=!0):e.basicInfoChanged=!0),(e.delivery_start_time||n.delivery_start_time)&&(e.delivery_start_time&&n.delivery_start_time?new Date(e.delivery_start_time).toString()!==new Date(n.delivery_start_time).toString()&&(e.basicInfoChanged=!0):e.basicInfoChanged=!0),(e.delivery_end_time||n.delivery_end_time)&&(e.delivery_end_time&&n.delivery_end_time?new Date(e.delivery_end_time).toString()!==new Date(n.delivery_end_time).toString()&&(e.basicInfoChanged=!0):e.basicInfoChanged=!0),e.driver_id!==n.driver_id?e.executorChanged=!0:e.company_id!==n.company_id&&(e.executorChanged=!0),!(!e.basicInfoChanged&&!e.executorChanged)}function S(n){a[n]?e.$emit(r.onShowAlert,a[n]):e.$emit(r.onShowAlert,"未知错误！请联系管理员")}function w(e){return e?void("driver"===e.group_type||"warehouse"===e.group_type?(this.driver_id=e.key,this.partner_name=e.value,this.type=e.group_type):"company"===e.group_type&&(this.company_id=e.key,this.partner_name=e.value,this.type=e.group_type)):(this.company_id="",this.driver_id="",void(this.partner_name=""))}function k(e,n){for(var t=null,r=0;r<n.length;r++)n[r].key===e&&(t=n[r]);return t}function C(e){console.log(e)}var b=t.id;b&&(e.order={},e.assign_infos=[],e.selectData={},e.rangeTimePanel={},s(),e.contactEdit={isOpen:!1,current:{assignInfo:null,pickupName:"",deliveryName:"",pickupMobilePhone:"",deliveryMobilePhone:"",pickupPhone:"",deliveryPhone:""}},e.changeType=function(n){n.currentText="",n.currentChoice=null,"driver"===n.type||"company"===n.type?(n.type="warehouse",n.defaultContent="搜索仓库管理员",n.options=e.selectData.executeWarehouseSelectData):(n.type="driver",n.defaultContent="搜索合作公司或司机",n.options=e.selectData.executeSelectData)},e.editAssignDetailInfo=function(n){e.contactEdit.isOpen=!0,e.contactEdit.current.assignInfo=n,e.contactEdit.current.pickupName=n.pickup_contact_name,e.contactEdit.current.deliveryName=n.delivery_contact_name,e.contactEdit.current.pickupMobilePhone=n.pickup_contact_mobile_phone,e.contactEdit.current.deliveryMobilePhone=n.delivery_contact_mobile_phone,e.contactEdit.current.pickupPhone=n.pickup_contact_phone,e.contactEdit.current.deliveryPhone=n.delivery_contact_phone},e.closeAssignDetailInfo=function(){e.contactEdit.isOpen=!1},e.saveAssignDetailInfo=function(){e.contactEdit.current.assignInfo.pickup_contact_name=e.contactEdit.current.pickupName,e.contactEdit.current.assignInfo.pickup_contact_mobile_phone=e.contactEdit.current.pickupMobilePhone,e.contactEdit.current.assignInfo.pickup_contact_phone=e.contactEdit.current.pickupPhone,e.contactEdit.current.assignInfo.delivery_contact_name=e.contactEdit.current.deliveryName,e.contactEdit.current.assignInfo.delivery_contact_mobile_phone=e.contactEdit.current.deliveryMobilePhone,e.contactEdit.current.assignInfo.delivery_contact_phone=e.contactEdit.current.deliveryPhone,e.contactEdit.isOpen=!1},e.cancelAndBack=function(){n.go("order_follow",{},{reload:!0})},e.openPickupRangeDatePicker=function(n){if(e.rangeTimePanel){if(e.rangeTimePanel.isShow())e.rangeTimePanel.hide();else{var t,r;event.target?(t=event.target.offsetLeft,r=event.target.offsetTop):(t=event.srcElement.offsetLeft,r=event.srcElement.offsetTop),e.rangeTimePanel.setLocation({left:t,top:r}),e.rangeTimePanel.show()}e.rangeTimePanel.bindDateRangeChangedEvent(function(t){n.pickupTimeRange=t,n.pickup_start_time=moment(t.startDate).toISOString(),n.pickup_end_time=moment(t.endDate).toISOString(),console.log("changed"),console.log(n.pickup_start_time),console.log(n.pickup_end_time),e.rangeTimePanel.hide()})}},e.openDeliveryRangeDatePicker=function(n){if(e.rangeTimePanel){if(e.rangeTimePanel.isShow())e.rangeTimePanel.hide();else{var t,r;event.target?(t=event.target.offsetLeft,r=event.target.offsetTop):(t=event.srcElement.offsetLeft,r=event.srcElement.offsetTop),e.rangeTimePanel.setLocation({left:t,top:r}),e.rangeTimePanel.show()}e.rangeTimePanel.bindDateRangeChangedEvent(function(t){n.deliveryTimeRange=t,n.delivery_start_time=moment(t.startDate).toISOString(),n.delivery_end_time=moment(t.endDate).toISOString(),e.rangeTimePanel.hide()})}},e.submitOrderAssignInfos=function(){var t=_();return console.log(t),t.isChanged?(e.$emit(r.onShowLoading,!0),t.newAssignInfos.forEach(function(e){delete e.$$hashKey,delete e.currentChoice,delete e.options}),void o.updateOrderAssign(e.order._id.toString(),t.newAssignInfos).then(function(t){return e.$emit(r.onShowLoading,!1),t.err?void S(t.err.type):(e.$emit(r.onShowAlert,"修改成功"),void n.go("order_follow",{},{reload:!0}))},function(n){return e.$emit(r.onShowLoading,!1),S(n.type)})):void n.go("order_follow",{},{reload:!0})},e.dateTransport=function(e){return new Date(e)})}]),angular.module("zhuzhuqs").controller("OrderOperationController",["$scope","$stateParams","$state","$timeout","CompanyService","OrderService","SalesmanService","OrderError","GroupError","GlobalEvent","UserProfileService",function(e,n,t,r,o,i,a,s,c,l,u){function d(n){i.getOperationOrderCount().then(function(t){return console.log(t),!t||t.err?n():(t.assignCount>=0&&(e.orderCount.assign=t.assignCount,e.orderCount.onway=t.onwayCount),n())},function(e){return n()})}function p(){f=r(function(){d(function(){p()})},1e4)}e.isCurrentLabel=function(e){return window.location.hash.indexOf(e)>-1},e.changeLabel=function(e){t.go(e)},e.orderCount={assign:0,onway:0};var f=null;d(function(){}),p(),e.$on("$destroy",function(){f&&r.cancel(f)})}]),angular.module("zhuzhuqs").controller("OrderOperationFollowCompletedController",["$state","$scope","OrderService","BMapService","GlobalEvent","config","AudioPlayer","OrderError","UserProfileService","Auth","OrderHelper",function(e,n,t,r,o,i,a,s,c,l,u){var d=["completed"],p={selectOptions:[{key:"运单号",value:{name:"运单号",value:"order_number",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!0},{key:"参考单号",value:{name:"参考单号",value:"ref_number",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!0},{key:"订单号",value:{name:"订单号",value:"original_order_number",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!1},{key:"货物名称",value:{name:"货物名称",value:"goods_name",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!0},{key:"承运商",value:{name:"承运商",value:"execute_company",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!0},{key:"司机",value:{name:"司机",value:"execute_driver",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!0},{key:"发货方",value:{name:"发货方",value:"sender_name",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!0},{key:"收货方",value:{name:"收货方",value:"receiver_name",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!0},{key:"货损信息",value:{name:"货损信息",value:"damage",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"备注",value:{name:"备注",value:"description",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"状态",value:{name:"状态",value:"status",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!1},{key:"分配时间",value:{name:"分配时间",value:"assign_time",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"进场时间",value:{name:"进场时间",value:"entrance_time",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"中途事件",value:{name:"中途事件",value:"halfway",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!1},{key:"司机确认",value:{name:"司机确认",value:"confirm",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!1}],getOrderList:function(e,n,r,o,i){i.push({key:"order_status",value:d});for(var a=0;a<i.length;a++)if("order_status"===i[a].key){i[a].value=d;break}return t.getAllOrders(e,n,r,o,i)}};new OrderFollow(e,n,t,r,o,i,a,s,c,l,u,p)}]),angular.module("zhuzhuqs").controller("OrderOperationFollowOnWayController",["$state","$scope","OrderService","BMapService","GlobalEvent","config","AudioPlayer","OrderError","UserProfileService","Auth","OrderHelper",function(e,n,t,r,o,i,a,s,c,l,u){var d=["assigning","unPickupSigned","unPickuped","unDeliverySigned","unDeliveried"],p={selectOptions:[{key:"运单号",value:{name:"运单号",value:"order_number",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!0},{key:"参考单号",value:{name:"参考单号",value:"ref_number",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{
text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!0},{key:"订单号",value:{name:"订单号",value:"original_order_number",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}],curSort:"",keyword:""},isSelected:!1},{key:"货物名称",value:{name:"货物名称",value:"goods_name",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!0},{key:"承运商",value:{name:"承运商",value:"execute_company",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!0},{key:"司机",value:{name:"司机",value:"execute_driver",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!0},{key:"发货方",value:{name:"发货方",value:"sender_name",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!0},{key:"收货方",value:{name:"收货方",value:"receiver_name",isSort:!1,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!0},{key:"货损信息",value:{name:"货损信息",value:"damage",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"备注",value:{name:"备注",value:"description",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"状态",value:{name:"状态",value:"status",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!1},{key:"分配时间",value:{name:"分配时间",value:"assign_time",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"进场时间",value:{name:"进场时间",value:"entrance_time",isSort:!0,isSearch:!1,columnWidth:1,sortList:[{text:"升序",value:"1"},{text:"降序",value:"-1"}]},isSelected:!1},{key:"中途事件",value:{name:"中途事件",value:"halfway",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!1},{key:"司机确认",value:{name:"司机确认",value:"confirm",isSort:!1,isSearch:!1,columnWidth:1},isSelected:!1}],getOrderList:function(e,n,r,o,i){i.push({key:"order_status",value:d});for(var a=0;a<i.length;a++)if("order_status"===i[a].key){i[a].value=d;break}return t.getAllOrders(e,n,r,o,i)}};new OrderFollow(e,n,t,r,o,i,a,s,c,l,u,p)}]),function(){var e=angular.module("ae-datetimepicker",[]);e.directive("datetimepicker",["$timeout",function(e){return{restrict:"EA",require:"ngModel",scope:{options:"=?",onChange:"&?",onClick:"&?"},link:function(n,t,r,o){var i=t.parent().hasClass("input-group")?t.parent():t;n.$watch("options",function(e){var n=i.data("DateTimePicker");$.map(e,function(e,t){n[t](e)})}),o.$render=function(){o.$viewValue?i.data("DateTimePicker").date(o.$viewValue):i.data("DateTimePicker").date(null)},i.on("dp.change",function(t){e(function(){"undefined"!==t.date&&(n.$apply(function(){o.$setViewValue(t.date)}),"function"==typeof n.onChange&&n.onChange())})}),i.on("click",function(){e(function(){"function"==typeof n.onClick&&n.onClick()})}),i.datetimepicker(n.options),e(function(){o.$viewValue&&(moment.isMoment(o.$viewValue)||o.$setViewValue(moment(n.date)),i.data("DateTimePicker").date(o.$viewValue))})}}}])}(),angular.module("zhuzhuqs").directive("zzButton",function(){return{restrict:"A",scope:{},link:function(e,n,t){t.defaultButton&&"true"!=t.defaultButton||(n.bind("click",function(){n.css("color","red")}),n.bind("mouseover",function(){n.css("cursor","pointer"),n.css("color","blue")}),n.bind("mouseout",function(){n.css("color","yellow")}))}}}),zhuzhuqs.directive("zzValidation",["$parse",function(e){var n=/^\d{11}$/,t=/\D/g,r=/[^\d{1}\.\d{1}|\d{1}]/g,o="";return{require:"?ngModel",restrict:"A",link:function(e,i,a,s){if(s){o="",e.$watch(a.ngModel,function(){var e="";switch(a.zzValidationType){case"mobile":e=new RegExp(n),l(e);break;case"telephone":u();break;case"mail":d();break;case"integer":e=new RegExp(t),c(e);break;case"number":e=r,c(e)}s.$setViewValue(o),s.$render()}),i.bind("change",function(){var e="";switch(a.zzValidationType){case"telephone":e=new RegExp(/\d{3}-\d{7,8}|\d{4}-\{7,8}/),e.test(s.$viewValue)?s.$setValidity("unique",!0):s.$setValidity("unique",!1);break;case"mail":e=new RegExp(/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/),e.test(s.$viewValue)?s.$setValidity("unique",!0):s.$setValidity("unique",!1)}});var c=function(e){o=s.$viewValue.replace(e,""),"number"==a.zzValidationType&&(0==o.indexOf(".")?o="":o.indexOf(".")<o.lastIndexOf(".")&&(o=o.substr(0,o.length-1)))},l=function(e){o=s.$viewValue.replace(t,""),e.test(s.$viewValue)||(o=o.substr(0,11))},u=function(){o=s.$viewValue.replace(/[^-\d]/g,""),0==o.indexOf("-")?o="":o.indexOf("-")<o.lastIndexOf("-")&&(o=o.substr(0,o.length-1))},d=function(){o=s.$viewValue.replace(/[^\w\d\.|\-|_|\@]/g,"")}}}}}]),angular.module("zhuzhuqs").directive("zzLoading",function(){return{restrict:"A",template:'<div class="zz-loading-layer" ng-if="showLoading"><div class="zz-loading-info"> <img ng-src="images/global/load.gif"/> </div> </div>',replace:!0}}),angular.module("zhuzhuqs").directive("zzMasking",function(){return{restrict:"A",template:'<div class="zz-masking-layer" ng-if="showMasking"></div>',replace:!0}}),angular.module("ng-echarts",[]).directive("ngEcharts",[function(){return{link:function(e,n,t,r){function o(){var t=e.config&&e.config.theme?e.config.theme:"default",r=echarts.init(n[0],t);e.config&&e.config.dataLoaded===!1&&r.showLoading(),e.config&&e.config.dataLoaded&&(r.setOption(e.option),r.resize(),r.hideLoading()),e.config&&e.config.event&&angular.isArray(e.config.event)&&angular.forEach(e.config.event,function(e,n){for(var t in e)r.on(t,e[t])})}e.$watch(function(){return e.config},function(e){e&&o()},!0),e.$watch(function(){return e.option},function(e){e&&o()},!0)},scope:{option:"=ecOption",config:"=ecConfig"},restrict:"EA"}}]),zhuzhuqs.directive("selfPagination",[function(){return{restrict:"EA",template:'<div class="page-list"><ul class="pagination" ng-show="conf.totalItems > 0"><li ng-class="{disabled: conf.currentPage == 1}" ng-click="prevPage()"><span>&laquo;</span></li><li ng-repeat="item in pageList track by $index" ng-class="{active: item == conf.currentPage, separate: item == \'...\'}" ng-click="changeCurrentPage(item)"><span>{{ item }}</span></li><li ng-class="{disabled: conf.currentPage == conf.numberOfPages}" ng-click="nextPage()"><span>&raquo;</span></li></ul><div class="page-total" ng-show="conf.totalItems > 0">第<input type="text" ng-model="jumpPageNum"  ng-keyup="jumpToPage($event)"/>页 每页<select ng-model="conf.itemsPerPage" ng-options="option for option in conf.perPageOptions " ng-change="changeItemsPerPage()"></select>共<strong>{{ conf.totalItems }}</strong>条</div><div class="no-items" ng-show="conf.totalItems <= 0">暂无数据</div></div>',replace:!0,scope:{conf:"="},link:function(e,n,t){function r(){e.conf.currentPage=parseInt(e.conf.currentPage)?parseInt(e.conf.currentPage):1,e.conf.totalItems=parseInt(e.conf.totalItems),e.conf.rememberPerPage?(parseInt(localStorage[e.conf.rememberPerPage])||(localStorage[e.conf.rememberPerPage]=parseInt(e.conf.itemsPerPage)?parseInt(e.conf.itemsPerPage):15),e.conf.itemsPerPage=parseInt(localStorage[e.conf.rememberPerPage])):e.conf.itemsPerPage=parseInt(e.conf.itemsPerPage)?parseInt(e.conf.itemsPerPage):15,e.conf.numberOfPages=Math.ceil(e.conf.totalItems/e.conf.itemsPerPage),e.conf.currentPage<1&&(e.conf.currentPage=1),e.conf.currentPage>e.conf.numberOfPages&&(e.conf.currentPage=e.conf.numberOfPages),e.jumpPageNum=e.conf.currentPage;for(var n,t=e.conf.perPageOptions.length,r=0;r<t;r++)e.conf.perPageOptions[r]==e.conf.itemsPerPage&&(n=!0);if(n||e.conf.perPageOptions.push(e.conf.itemsPerPage),e.conf.perPageOptions.sort(function(e,n){return e-n}),e.pageList=[],e.conf.numberOfPages<=e.conf.pagesLength)for(r=1;r<=e.conf.numberOfPages;r++)e.pageList.push(r);else{var o=(e.conf.pagesLength-1)/2;if(e.conf.currentPage<=o){for(r=1;r<=o+1;r++)e.pageList.push(r);e.pageList.push("..."),e.pageList.push(e.conf.numberOfPages)}else if(e.conf.currentPage>e.conf.numberOfPages-o){for(e.pageList.push(1),e.pageList.push("..."),r=o+1;r>=1;r--)e.pageList.push(e.conf.numberOfPages-r);e.pageList.push(e.conf.numberOfPages)}else{for(e.pageList.push(1),e.pageList.push("..."),r=Math.ceil(o/2);r>=1;r--)e.pageList.push(e.conf.currentPage-r);for(e.pageList.push(e.conf.currentPage),r=1;r<=o/2;r++)e.pageList.push(e.conf.currentPage+r);e.pageList.push("..."),e.pageList.push(e.conf.numberOfPages)}}e.$parent.conf=e.conf}e.changeCurrentPage=function(n){"..."!=n&&e.conf.currentPage!=n&&(e.conf.currentPage=n,e.conf.onChange&&e.conf.onChange())},e.conf.pagesLength=parseInt(e.conf.pagesLength)?parseInt(e.conf.pagesLength):9,e.conf.pagesLength%2===0&&(e.conf.pagesLength=e.conf.pagesLength-1),e.conf.perPageOptions||(e.conf.perPageOptions=[10,15,20,30,50]),e.prevPage=function(){e.conf.currentPage>1&&(e.conf.currentPage-=1),e.conf.onChange&&e.conf.onChange()},e.nextPage=function(){e.conf.currentPage<e.conf.numberOfPages&&(e.conf.currentPage+=1),e.conf.onChange&&e.conf.onChange()},e.jumpToPage=function(){e.jumpPageNum=e.jumpPageNum.replace(/[^0-9]/g,""),""!==e.jumpPageNum&&(e.conf.currentPage=e.jumpPageNum),e.conf.onChange&&e.conf.onChange()},e.changeItemsPerPage=function(){e.conf.rememberPerPage&&localStorage.removeItem(e.conf.rememberPerPage)},e.$watch(function(){var n=e.conf.currentPage+" "+e.conf.totalItems+" ";return n},r)}}}]),zhuzhuqs.directive("zzplacehold",function(){return{restrict:"A",require:"ngModel",link:function(e,n,t,r){var o,i=function(){n.val(t.zzplacehold)},a=function(){n.val("")};e.$watch(t.ngModel,function(e){o=e||""}),n.bind("focus",function(){""==o&&a()}),n.bind("blur",function(){""==n.val()&&i()}),r.$formatters.unshift(function(e){return e?e:(i(),o="",t.zzplacehold)})}}}),zhuzhuqs.directive("zzAlertDialog",function(){return{restrict:"A",template:'<div class="mask" ng-show="alertConfig.show"><div class="zz-alert"><div class="zz-alert-title"> <span>{{alertConfig.title}}</span></div><div class="zz-alert-content"> <span>{{alertConfig.content}}</span></div><div class="zz-alert-handle"><div class="zz-btn-primary zz-alert-btn" ng-click="cancel()">{{alertConfig.cancel}}</div> </div></div></div>',replace:!0,scope:{},controller:"AlertController"}}),zhuzhuqs.directive("zzAlertConfirmDialog",function(){return{restrict:"A",template:'<div class="mask" ng-show="alertConfig.show"><div class="zz-alert"><div class="zz-alert-title"> <span>{{alertConfig.title}}</span></div><div class="zz-alert-content"> <span>{{alertConfig.content}}</span></div><div class="row zz-alert-confirm-handle"><div class="col-xs-6"><div class="zz-btn-primary zz-alert-btn" ng-click="sure()">{{alertConfig.sure}}</div></div><div class="col-xs-6"><div class="zz-btn-primary zz-alert-btn" ng-click="cancel()">{{alertConfig.cancel}}</div> </div> </div> </div></div>',replace:!0,scope:{},controller:"AlertConfirmController"}}),zhuzhuqs.directive("zzAlertConfirmStyleDialog",function(){return{restrict:"A",template:'<div class="mask" ng-show="alertConfig.show"><div class="zz-alert confirm-style"><div class="zz-alert-title"><span>{{alertConfig.title}}</span></div><div class="zz-alert-content"><p class="floor-one" ng-show="alertConfig.content_one !== \'\'"><span class="point">●</span><span class="text">{{alertConfig.content_one}}</span></p><p class="floor-two" ng-show="alertConfig.content_two !== \'\'"><span class="point">●</span><span class="text">{{alertConfig.content_two}}</span></p><p class="floor-three" ng-show="alertConfig.content_three !== \'\'"><span class="point">●</span><span class="text">{{alertConfig.content_three}}</span></p></div><div class="row zz-alert-confirm-handle"><div class="col-xs-6"><div class="zz-btn-primary zz-alert-btn" ng-click="sure()">{{alertConfig.sure}}</div></div><div class="col-xs-6"><div class="zz-btn-primary zz-alert-btn" ng-click="cancel()">{{alertConfig.cancel}}</div> </div> </div> </div></div>',replace:!0,scope:{},controller:"AlertConfirmStyleController"}}),zhuzhuqs.directive("zzAlertPromptDialog",function(){return{restrict:"A",template:'<div class="mask" ng-show="alertConfig.show"><div class="zz-alert"><div class="zz-alert-title"><span>{{alertConfig.title}}</span> <span class="cancel" ng-click="cancel()"></span></div><div class="zz-alert-prompt-tip"><span>{{alertConfig.tipText}}</span></div><div class="zz-alert-prompt-input"><input class="text" ng-class="{\'not-empty\': alertConfig.inputContent !==\'\'}" placeholder="{{alertConfig.placeholderText}}" ng-model="alertConfig.inputContent" /></div><div class="zz-alert-prompt-handle"><div class="zz-btn-primary zz-alert-btn" ng-click="sure()">{{alertConfig.sure}}</div></div></div></div>',replace:!0,scope:{},controller:"AlertPromptController"}}),zhuzhuqs.directive("zzCustomizeDialog",function(){return{restrict:"EA",template:'<div class="mask" ng-show="pageConfig.show"><div class="zz-custom-dialog"><div class="zz-dialog-title"> <span>{{pageConfig.title}}</span><div class="zz-dialog-close" ng-click="closed()"><img ng-src="images/icon/ic_close_24px.svg"/></div></div><div class="zz-dialog-content"></div><div class="zz-dialog-handle"><div class="zz-dialog-btn-new zz-dialog-btn" ng-click="closed()">{{pageConfig.okLabel}}</div> </div></div></div>',replace:!0,scope:{pageConfig:"="},link:function(e,n,t){e.pageConfig||(e.pageConfig={title:"自定义消息框",content:"自定义内容",okLabel:"确定",show:!1});var r=n.find(".zz-dialog-content");r.append(e.pageConfig.content),e.closed=function(){e.pageConfig.show=!1}}}}),zhuzhuqs.directive("zzExportDialog",function(){return{restrict:"A",templateUrl:"directive/zz_export_dialog/order_export_dialog.client.directive.html",replace:!1,scope:{},controller:"OrderExportController"}}),zhuzhuqs.directive("zzOrderAssign",["OrderHelper",function(e){return{restrict:"EA",templateUrl:"directive/zz_order_assign/zz_order_assign.html",replace:!0,link:function(n,t,r,o){function i(){var t=n.extendData.partnerCompanies,r=n.extendData.partnerDrivers,o=[],i=[];o.push({key:null,value:"合作公司"});for(var a=0;a<t.length;a++){var s=t[a];o.push(e.getCompanyAssignOption(s))}o.push({key:null,value:"合作司机"}),i.push({key:null,value:"仓库管理员"});for(var a=0;a<r.length;a++)r[a].driver&&r[a].driver.is_signup&&(o.push(e.getDriverAssignOption(r[a].driver,"driver")),i.push(e.getDriverAssignOption(r[a].driver,"warehouse")));o.push({key:null,value:"微信司机"}),i.push({key:null,value:"微信仓库管理员"});for(var a=0;a<r.length;a++)r[a].driver&&r[a].driver.wechat_profile&&r[a].driver.wechat_profile.openid&&(o.push(e.getWechatDriverAssignOption(r[a].driver,"driver")),i.push(e.getWechatDriverAssignOption(r[a].driver,"warehouse")));return{executeSelectData:o,executeWarehouseSelectData:i}}function a(e,n){e&&(e.onSelected=u,e.pickup_start_time&&(e.pickupTimeRange={startDate:e.pickup_start_time?new Date(e.pickup_start_time):null,endDate:e.pickup_end_time?new Date(e.pickup_end_time):null}),e.delivery_start_time&&(e.deliveryTimeRange={startDate:e.delivery_start_time?new Date(e.delivery_start_time):null,endDate:e.delivery_end_time?new Date(e.delivery_end_time):null}),e.is_assigned===!0||"true"===e.is_assigned?e.enableEdit=!1:e.enableEdit=!0,"driver"===e.type?(e.options=n.executeSelectData,e.currentChoice=s(e.driver_id,e.is_wechat,e.options),!e.currentChoice&&e.driver_username&&(e.currentText=e.driver_username)):"warehouse"===e.type?(e.options=n.executeWarehouseSelectData,e.currentChoice=s(e.driver_id,e.is_wechat,e.options),!e.currentChoice&&e.driver_username&&(e.currentText=e.driver_username)):(e.options=n.executeSelectData,e.currentChoice=s(e.company_id,e.is_wechat,e.options)),e.currentText||(e.currentText=e.currentChoice?e.currentChoice.value:""))}function s(e,n,t){for(var r=null,o=0;o<t.length;o++)if(t[o].key===e){if(!n){r=t[o];break}if(t[o].is_wechat==n){r=t[o];break}}return r}function c(){return{pickup_contact_name:n.order.extendData.detail.pickup_contact_name,pickup_contact_phone:n.order.extendData.detail.pickup_contact_phone,pickup_contact_mobile_phone:n.order.extendData.detail.pickup_contact_mobile_phone,pickup_contact_address:n.order.extendData.detail.pickup_contact_address,pickup_contact_email:"",delivery_contact_name:n.order.extendData.detail.delivery_contact_name,delivery_contact_phone:n.order.extendData.detail.delivery_contact_phone,delivery_contact_mobile_phone:n.order.extendData.detail.delivery_contact_mobile_phone,delivery_contact_address:n.order.extendData.detail.delivery_contact_address,delivery_contact_email:"",company_id:"",is_assigned:!1,pickup_start_time:n.order.extendData.detail.pickup_start_time,pickup_end_time:n.order.extendData.detail.pickup_end_time,delivery_start_time:n.order.extendData.detail.delivery_start_time,delivery_end_time:n.order.extendData.detail.delivery_end_time,driver_id:"",type:"company",pickupTimeRange:{startDate:n.order.extendData.detail.pickup_start_time?new Date(n.order.extendData.detail.pickup_start_time):null,endDate:n.order.extendData.detail.pickup_end_time?new Date(n.order.extendData.detail.pickup_end_time):null},deliveryTimeRange:{startDate:n.order.extendData.detail.delivery_start_time?new Date(n.order.extendData.detail.delivery_start_time):null,endDate:n.order.extendData.detail.delivery_end_time?new Date(n.order.extendData.detail.delivery_end_time):null},currentText:null,currentChoice:null,defaultContent:"搜索合作公司或司机",options:n.selectData.executeSelectData,onSelected:u,enableEdit:!0}}function l(){return{pickup_contact_name:"",pickup_contact_phone:"",pickup_contact_mobile_phone:"",pickup_contact_address:"",pickup_contact_email:"",delivery_contact_name:"",delivery_contact_phone:"",delivery_contact_mobile_phone:"",delivery_contact_address:"",delivery_contact_email:"",company_id:"",pickup_start_time:"",pickup_end_time:"",delivery_start_time:"",delivery_end_time:"",driver_id:"",partner_name:"",type:"company",pickupTimeRange:null,deliveryTimeRange:null,currentText:null,currentChoice:null,defaultContent:"搜索合作公司或司机",options:n.selectData.executeSelectData,onSelected:u,enableEdit:!0}}function u(e){return e?void("driver"===e.group_type||"warehouse"===e.group_type?(this.driver_id=e.key,this.partner_name=e.value,this.type=e.group_type,this.is_wechat=e.is_wechat||!1):"company"===e.group_type&&(this.company_id=e.key,this.partner_name=e.value,this.type=e.group_type)):(this.company_id="",this.driver_id="",void(this.partner_name=""))}if(n.order=n.$parent.row,n.order.new_order_number="",n.extendData=n.$parent.$parent.config.extendData,n.rangeTimePanel=n.extendData.rangeTimePanel,n.selectData=i(),n.isOpenEditBox=!1,n.contactEdit={isOpen:!1,current:{assignInfo:null,pickupName:"",deliveryName:"",pickupMobilePhone:"",deliveryMobilePhone:"",pickupPhone:"",deliveryPhone:""}},n.dateTransport=function(e){return new Date(e)},n.order.extendData.assignInfos||(n.order.extendData.assignInfos=[]),0===n.order.extendData.assignInfos.length)n.order.extendData.assignInfos.push(c());else for(var d=i(),p=0;p<n.order.extendData.assignInfos.length;p++)a(n.order.extendData.assignInfos[p],d);n.changeType=function(e){if(0!=e.enableEdit){var n=i();"driver"===e.type||"company"===e.type?(e.type="warehouse",e.currentChoice=null,e.defaultContent="搜索仓库管理员",e.options=n.executeWarehouseSelectData):(e.type="driver",e.currentChoice=null,e.defaultContent="搜索合作公司或司机",e.options=n.executeSelectData)}},n.addNewAssignInfo=function(){n.order.extendData.assignInfos.push(l())},n.cancelAssign=function(){n.order.isExpand=!1,n.rangeTimePanel.hide()},n.removeAssignInfo=function(e){if(!(e<0||e>=n.order.extendData.assignInfos.length||0===e&&1===n.order.extendData.assignInfos.length))return n.order.extendData.assignInfos.splice(e,1)},n.editAssignDetailInfo=function(e){console.log("editAssignDetailInfo"),console.log(e),n.contactEdit.isOpen=!0,n.contactEdit.current.assignInfo=e,n.contactEdit.current.pickupName=e.pickup_contact_name,n.contactEdit.current.deliveryName=e.delivery_contact_name,n.contactEdit.current.pickupMobilePhone=e.pickup_contact_mobile_phone,n.contactEdit.current.deliveryMobilePhone=e.delivery_contact_mobile_phone,n.contactEdit.current.pickupPhone=e.pickup_contact_phone,n.contactEdit.current.deliveryPhone=e.delivery_contact_phone},n.closeAssignDetailInfo=function(){n.contactEdit.isOpen=!1},n.saveAssignDetailInfo=function(){n.contactEdit.current.assignInfo.pickup_contact_name=n.contactEdit.current.pickupName,n.contactEdit.current.assignInfo.pickup_contact_mobile_phone=n.contactEdit.current.pickupMobilePhone,n.contactEdit.current.assignInfo.pickup_contact_phone=n.contactEdit.current.pickupPhone,n.contactEdit.current.assignInfo.delivery_contact_name=n.contactEdit.current.deliveryName,n.contactEdit.current.assignInfo.delivery_contact_mobile_phone=n.contactEdit.current.deliveryMobilePhone,n.contactEdit.current.assignInfo.delivery_contact_phone=n.contactEdit.current.deliveryPhone,n.contactEdit.isOpen=!1},n.submitOrderAssignInfos=function(){if(n.extendData.onRowSubmit){for(var e=0;e<n.order.extendData.assignInfos.length;e++){var t=n.order.extendData.assignInfos[e];t.currentChoice&&(t.enableEdit=!1)}n.extendData.onRowSubmit(n.order)}},n.openPickupRangeDatePicker=function(e){if(e.enableEdit&&n.rangeTimePanel){if(n.rangeTimePanel.isShow())n.rangeTimePanel.hide();else{var t,r;event.target?(t=event.target.offsetLeft,r=event.target.offsetTop):(t=event.srcElement.offsetLeft,r=event.srcElement.offsetTop),n.rangeTimePanel.setLocation({left:t,top:r}),n.rangeTimePanel.show()}n.rangeTimePanel.bindDateRangeChangedEvent(function(t){e.pickupTimeRange=t,e.pickup_start_time=t.startDate._d,e.pickup_end_time=t.endDate._d,console.log("changed"),console.log(e.pickup_start_time),console.log(e.pickup_end_time),n.rangeTimePanel.hide()})}},n.openDeliveryRangeDatePicker=function(e){if(e.enableEdit&&n.rangeTimePanel){if(n.rangeTimePanel.isShow())n.rangeTimePanel.hide();else{var t,r;event.target?(t=event.target.offsetLeft,r=event.target.offsetTop):(t=event.srcElement.offsetLeft,r=event.srcElement.offsetTop),n.rangeTimePanel.setLocation({left:t,top:r}),n.rangeTimePanel.show()}n.rangeTimePanel.bindDateRangeChangedEvent(function(t){e.deliveryTimeRange=t,e.delivery_start_time=t.startDate._d,e.delivery_end_time=t.endDate._d,n.rangeTimePanel.hide()})}}}}}]),zhuzhuqs.directive("zzList",["GlobalEvent",function(e){return{restrict:"EA",templateUrl:"directive/zz_list/zz_list.client.directive.view.html",replace:!0,transclude:!0,scope:{config:"="},link:function(n,t,r){function o(){for(var e=0;e<n.config.rows.length;e++)n.config.rows[e].isExpand=!1}function i(e){e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0}function a(){void 0!==n.config.isOptional&&null!==n.config.isOptional||(n.config.isOptional=!0),void 0!==n.config.selectionOption&&null!==n.config.selectionOption||(n.config.selectionOption={columnWidth:1}),void 0!==n.config.handleOption&&null!==n.config.handleOption||(n.config.handleOption={columnWidth:2}),void 0!==n.config.isFieldSetting&&null!==n.config.isFieldSetting||(n.config.isFieldSetting=!0),void 0!==n.config.rowExpand&&null!==n.config.rowExpand||(n.config.rowExpand={isSupport:!1,text:"展开"}),void 0!==n.config.rowExpand.enable&&null!==n.config.rowExpand.enable||(n.config.rowExpand.enable=!1),void 0!==n.config.rowExpand.expandText&&""!==n.config.rowExpand.expandText||(n.config.rowExpand.expandText="展开"),void 0!==n.config.rowExpand.cancelText&&""!==n.config.rowExpand.cancelText||(n.config.rowExpand.cancelText="取消"),void 0!==n.config.rowExpand.selfCloseButton&&""!==n.config.rowExpand.selfCloseButton||(n.config.rowExpand.selfCloseButton=!1),void 0!==n.config.isSelectedAll&&null!==n.config.isSelectedAll||(n.config.isSelectedAll=!1),n.config.selectedRows||(n.config.selectedRows=[]),n.config.fields_length||(n.config.fields_length=7),s()}function s(){if(n.enableOptionalCount=0,n.selectedRows.splice(0,n.selectedRows.length),n.isSelectedAll=!1,n.config.fields&&n.config.fields.length>0){for(var e=0;e<n.config.fields.length;e++)n.config.fields[e].columnWidth||(n.config.fields[e].columnWidth=1),n.config.fields[e].columnWidthStyle="zz-list-col-"+n.config.fields[e].columnWidth,n.config.fields[e].self_column_class&&(n.config.fields[e].columnWidthStyle+=" "+n.config.fields[e].self_column_class),n.config.fields[e].isExpanded=!1;for(var e=0;e<n.config.rows.length;e++)n.config.rows[e].selected=!1,n.config.rows[e].isExpand=!1,n.config.rows[e].disabled||n.enableOptionalCount++}n.config.selectionOption.columnWidth||(n.config.selectionOption.columnWidth=1),n.config.selectionOptionColumnWidthStyle="zz-list-col-"+n.config.selectionOption.columnWidth,n.config.handleOption.columnWidth||(n.config.handleOption.columnWidth=2),n.config.handleOptionColumnWidthStyle="zz-list-col-"+n.config.handleOption.columnWidth}function c(e,t,r){if(n.config.events&&n.config.events[e]&&n.config.events[e].length>0)for(var o=0;o<n.config.events[e].length;o++){var i=n.config.events[e][o];i&&"function"==typeof i&&i(t,r)}}n.enableOptionalCount=0,n.isSelectedAll=!1,n.isShowFieldOption=!1,n.selectedRows=[],n.config.load=function(e){s(),e&&e()},n.config.reLoad=function(e){if(n.config.isSelectedAll=!1,s(),e)return e()},n.toggleSelectAll=function(){n.isSelectedAll=!n.isSelectedAll,n.selectedRows.splice(0,n.selectedRows.length);for(var e=0;e<n.config.rows.length;e++){var t=n.config.rows[e];t.rowConfig.notOptional||(t.selected=n.isSelectedAll,n.isSelectedAll&&n.selectedRows.push(t))}c("selectedHandler",n.selectedRows)},n.onRowSelected=function(e,t){if(!e.rowConfig.notOptional){if(e.selected=!e.selected,e.selected)n.selectedRows.push(e);else for(var r=0;r<n.selectedRows.length;r++)n.selectedRows[r]._id===e._id&&n.selectedRows.splice(r,1);n.selectedRows.length===n.enableOptionalCount?n.isSelectedAll=!0:n.isSelectedAll=!1,c("selectedHandler",n.selectedRows,t)}},n.onRowClick=function(e){c("rowClickHandler",e)},n.onRowInfoEdit=function(e){c("rowInfoEditHandler",e)},n.onRowDelete=function(e){c("rowDeleteHandler",e)},n.onRowExpand=function(e){o(),e.isExpand=!e.isExpand},n.onSortItemClick=function(e,n){e.curSort=n,e.isExpanded=!1,c("headerSortChangedHandler",e)},n.onSearchItemSubmit=function(e){e.isExpanded=!1,c("headerKeywordsChangedHandler",e)},n.onHeaderFieldClick=function(e,n){e.isExpanded=!e.isExpanded,n.stopPropagation()},n.$on(e.onBodyClick,function(){for(var e=0;e<n.config.fields.length;e++)n.config.fields[e].isExpanded=!1;n.isShowFieldOption&&(n.isShowFieldOption=!1,c("saveDisplayFields"))}),n.onFieldSettingAreaClick=function(e){i(e)},n.onFieldOptionButtonClick=function(e){n.isShowFieldOption=!n.isShowFieldOption,n.isShowFieldOption||c("saveDisplayFields"),i(e)},n.onFiledOptionColumnClick=function(e,t){if(i(t),n.config.selectOptions&&!(n.config.selectOptions.length<=0))if(e.isSelected)e.isSelected=!1,c("updateDisplayFields");else{var r=0;n.config.selectOptions.forEach(function(e){e.isSelected&&(r+=1)}),r<n.config.fields_length&&(e.isSelected=!e.isSelected,c("updateDisplayFields"))}},a()}}}]),zhuzhuqs.directive("zzPagination",[function(){return{restrict:"EA",template:'<div class="zz-pagination" ng-show="config.pageCount>0"><div class="pagination_info"><div ng-show="config.isShowTotalInfo" class="base_info">总数: {{config.totalCount}}</div><div ng-show="config.canSetLimit" class="limit_set"><span>每页显示:</span><select ng-options="limitItem for limitItem in config.limitArray" ng-change="config.changePageLimit()" ng-model="config.limit" ></select></div><div ng-show="config.canSeekPage" class="currentPage_set"><span>跳转至第</span><input  ng-model="config.currentPage" ng-change="config.seekPage(config.currentPage);"/><span>页</span></div></div><div class="page_list"><ul><li ng-show="config.currentPage > 1" ng-click="config.changePage(1);"><a>首页</a></li><li ng-show="config.currentPage > 1" ng-click="config.changePage(config.currentPage - 1);"><a>上一页</a></li><li ng-repeat="pageNumber in config.pageList" ng-click="config.changePage(pageNumber);" ng-class="(config.currentPage == pageNumber)?\'current\':\'\'"><a>{{pageNumber}}</a></li><li ng-show="config.currentPage < config.pageCount" ng-click="config.changePage(config.currentPage + 1);"><a>下一页</a></li><li ng-show="config.currentPage < config.pageCount" ng-click="config.changePage(config.pageCount)"><a>最后</a></li></ul></div></div>',replace:!0,scope:{config:"="},link:function(e,n,t){function r(){e.config.currentPage&&0!==e.config.currentPage||(e.config.currentPage=1),e.config.limit&&0!==e.config.limit||(e.config.limit=20),e.config.totalCount||(e.config.totalCount=0),e.config.pageCount||(e.config.pageCount=0),e.config.limitArray&&0!==e.config.limitArray.length||(e.config.limitArray=[10,20,30,50,100]),e.config.pageNavigationCount&&0!==e.config.pageNavigationCount||(e.config.pageNavigationCount=5),void 0!==e.config.isShowTotalInfo&&null!=e.config.isShowTotalInfo||(e.config.isShowTotalInfo=!0),void 0!==e.config.canSetLimit&&null!=e.config.canSetLimit||(e.config.canSetLimit=!0),void 0!==e.config.canSeekPage&&null!=e.config.canSeekPage||(e.config.canSeekPage=!0),e.config.onChange||(e.onChange=function(){console.log("Turn to the "+e.config.currentPage+" page")})}function o(){if(""===e.config.currentPage||e.config.currentPage<=0)return e.config.currentPage=1;if(e.config.pageList.splice(0,e.config.pageList.length),e.config.pageCount>e.config.pageNavigationCount)for(var n=e.config.currentPage+e.config.pageNavigationCount-1>e.config.pageCount?e.config.pageCount:e.config.currentPage+e.config.pageNavigationCount-1,t=n-e.config.pageNavigationCount+1,r=t;r<=n;r++)e.config.pageList.push(r);else for(var r=1;r<=e.config.pageCount;r++)e.config.pageList.push(r)}function i(n){if(n!==e.config.currentPage)return e.config.currentPage=n,e.config.onCurrentPageChanged?void e.config.onCurrentPageChanged(function(e){e.totalCount=e.totalCount,e.pageCount=Math.ceil(e.totalCount/e.limit)}):void console.log("currentPage changed!")}e.config||(e.config={}),e.config.render=function(){r(),o()},e.config.changePage=function(e){i(e)},e.config.seekPage=function(n){n&&(n=parseInt(n),n>e.config.pageCount||i(n))},e.config.changePageLimit=function(){e.config.currentPage=1,e.config.onCurrentPageChanged(function(e){e.totalCount=e.totalCount,e.pageCount=Math.ceil(e.totalCount/e.limit)})},e.$watchCollection("config",function(){console.log("currentPage changed"),o()})}}}]),zhuzhuqs.directive("zzOrderOption",["GlobalEvent",function(e){return{restrict:"EA",templateUrl:"directive/zz_order_option/zz_order_option.client.directive.view.html",replace:!0,transclude:!0,scope:{config:"="},link:function(e,n,t){function r(n){var t=e.config;t.entrance.isOpen=n.must_entrance||!1,t.entrance_photo.isOpen=n.must_entrance_photo||!1,t.entrance_photo.isPlate=!1,t.take_photo.isOpen=n.must_take_photo||!1,t.take_photo.isPlate=!1,t.confirm_detail.isOpen=n.must_confirm_detail||!1,t.entrance_photo_array=[],n.entrance_photos&&n.entrance_photos.length>0?n.entrance_photos.forEach(function(e){e.isPlate?(t.entrance_photo_array.push({name:e.name,isPlate:!0}),t.entrance_photo.isPlate=!0):t.entrance_photo_array.push({name:e.name})}):t.entrance_photo_array.push({name:"拍货物"}),t.take_photo_array=[],n.take_photos&&n.take_photos.length>0?n.take_photos.forEach(function(e){e.isPlate?(t.take_photo_array.push({name:e.name,isPlate:!0}),t.take_photo.isPlate=!0):t.take_photo_array.push({name:e.name})}):t.take_photo_array.push({name:"拍货物"})}function o(){var n={},t=[],r=e.config;return n.must_entrance=r.entrance.isOpen||!1,n.must_entrance_photo=r.entrance_photo.isOpen||!1,n.must_take_photo=r.take_photo.isOpen||!1,n.must_confirm_detail=r.confirm_detail.isOpen||!1,n.entrance_photos=[],r.entrance_photo_array.forEach(function(e){e.name?(n.entrance_photos.push({name:e.name}),e.isPlate&&(n.entrance_photos[n.entrance_photos.length-1].isPlate=!0)):t.push("entrance_photo_array")}),n.take_photos=[],r.take_photo_array.forEach(function(e){e.name?(n.take_photos.push({name:e.name}),e.isPlate&&(n.take_photos[n.take_photos.length-1].isPlate=!0)):t.push("take_photo_array")}),{config:n,invalid:t}}function i(n){var t="";if(n.invalid.length>0){if("entrance_photo_array"===n.invalid[0]&&n.config.must_entrance_photo)return t="进场拍照有未编辑步骤，请编辑文字",e.config.title+t;if("take_photo_array"===n.invalid[0]&&n.config.must_take_photo)return t="拍照有未编辑步骤，请编辑文字",e.config.title+t}return n.config.must_entrance_photo&&0===n.config.entrance_photos.length?(t="强制进场拍照后，必须设置拍照步骤",e.config.title+t):n.config.must_take_photo&&0===n.config.take_photos.length?(t="强制拍照后，必须设置拍照步骤",
e.config.title+t):""}function a(e,n){if(e.must_entrance!==n.must_entrance)return!0;if(e.must_entrance_photo!==n.must_entrance_photo)return!0;if(e.must_take_photo!==n.must_take_photo)return!0;if(e.must_confirm_detail!==n.must_confirm_detail)return!0;if(e.entrance_photos.length!==n.entrance_photos.length)return!0;for(var t=0;t<e.entrance_photos.length;t++)if(e.entrance_photos[t].name!==n.entrance_photos[t].name)return!0;if(e.take_photos.length!==n.take_photos.length)return!0;for(var t=0;t<e.take_photos.length;t++)if(e.take_photos[t].name!==n.take_photos[t].name)return!0;return!1}var s;e.config.removePhotoItem=function(e,n,t){0===n.length||e<0||e>=n.length||(n[e].isPlate&&(t.isPlate=!1),n.splice(e,1))},e.config.addPhotoItem=function(e){e.push({name:""})},e.config.addPlatePhotoItem=function(e,n){n.isPlate||(e.push({name:"拍车牌",isPlate:!0}),n.isPlate=!0)},e.config.load=function(e){s=e,e&&r(e)},e.config.getData=function(){var e=o(),n=i(e),t=!1;return t=!s||a(s,e.config),{err:n,isModify:t,config:e.config}}}}}]),zhuzhuqs.directive("zzPhotoScan",["$document",function(e){return{restrict:"EA",template:'<div class="zz-photo-scan-mask" ng-show="show"><div class="zz-photo-scan-top"><span>{{photoShow.currentPhoto.order}}</span><span>{{photoShow.currentPhoto.title}}</span><span class="warning">{{photoShow.currentPhoto.warning}}</span></div><div class="row zz-photo-scan-wrap"><div class="col-xs-12 col-sm-10 col-sm-offset-1 container" ng-mouseover="showRemark(true)" ng-mouseleave="showRemark(false)"><img ng-src="{{photoShow.currentPhoto.url}}" class="photo-info"/><div class="zz-photo-scan-remark" ng-show="photoShow.showRemark"><div class="remark-info">{{photoShow.currentPhoto.remark}}</div></div></div></div><div class="zz-photo-scan-close"  ng-click="close()"><img src="images/global/close_white.png" /></div><div class="zz-photo-scan-arrow-left-warp"><div class="zz-photo-scan-arrow-left"  ng-class="{\'disable\':!photoShow.pre_enable}" ng-click="preClick()"><img src="images/global/arrow_left.png" /></div><div class="btn-mask" ng-show="!photoShow.pre_enable"></div></div><div class="zz-photo-scan-arrow-right-warp"><div class="zz-photo-scan-arrow-right" ng-class="{\'disable\':!photoShow.next_enable}" ng-click="nextClick()"><img src="images/global/arrow_right.png" /></div> <div class="btn-mask" ng-show="!photoShow.next_enable"></div></div></div>',replace:!0,scope:{photos:"=",show:"=",startIndex:"="},link:function(e,n,t){function r(){e.photoShow.pre_enable=!(e.photoShow.current_index<=0),e.photoShow.next_enable=!(e.photoShow.current_index>=e.photos.length-1)}e.photos||(e.photos=[]),e.show||(e.show=!1),e.startIndex||(e.startIndex=0),e.photoShow={currentPhoto:e.photos.length>0?e.photos[e.startIndex]:null,current_index:e.startIndex,next_enable:!0,pre_enable:!1,showRemark:!1},e.preClick=function(){0!=e.photoShow.current_index&&0!=e.photos.length&&(e.photoShow.current_index--,e.photoShow.currentPhoto=e.photos[e.photoShow.current_index],r())},e.nextClick=function(){0!=e.photos.length&&e.photoShow.current_index!=e.photos.length-1&&(e.photoShow.current_index++,e.photoShow.currentPhoto=e.photos[e.photoShow.current_index],r())},e.close=function(){e.show=!1},e.initShow=function(){e.photoShow.current_index=e.startIndex,e.photoShow.currentPhoto=e.photos[e.photoShow.current_index],r()},e.showRemark=function(n){e.photoShow.currentPhoto.remark&&""!=e.photoShow.currentPhoto.remark&&(e.photoShow.showRemark=n)},e.$watch("show",function(n,t){e.initShow()})}}}]),zhuzhuqs.controller("ProgressBarController",["$scope","$attrs",function(e,n){var t=this,r=!angular.isDefined(n.animate)||e.$parent.$eval(n.animate);this.bars=[],e.max=angular.isDefined(e.max)?e.max:100,this.addBar=function(n,o,i){r||o.css({transition:"none"}),this.bars.push(n),n.max=e.max,n.title=i&&angular.isDefined(i.title)?i.title:"progressbar",n.$watch("value",function(e){n.recalculatePercentage()}),n.recalculatePercentage=function(){var e=t.bars.reduce(function(e,n){return n.percent=+(100*n.value/n.max).toFixed(2),e+n.percent},0);e>100&&(n.percent-=e-100)},n.$on("$destroy",function(){o=null,t.removeBar(n)})},this.removeBar=function(e){this.bars.splice(this.bars.indexOf(e),1),this.bars.forEach(function(e){e.recalculatePercentage()})},e.$watch("max",function(n){t.bars.forEach(function(n){n.max=e.max,n.recalculatePercentage()})})}]).directive("progressbar",function(){return{replace:!0,transclude:!0,controller:"ProgressBarController",scope:{value:"=",max:"=?",type:"@"},templateUrl:"directive/zz_progressbar/zz_progressbar.client.directive.view.html",link:function(e,n,t,r){r.addBar(e,angular.element(n.children()[0]),{title:t.title})}}}),angular.module("zhuzhuqs").directive("zzRangeDatePicker",function(){return{restrict:"E",replace:!0,template:'<input ng-show="zzRangeDatePickerConfig.isShow" type="text" date-range-picker  class="zz-range-date-picker"ng-model="zzRangeDatePickerConfig.queryLogTimeRange"min="zzRangeDatePickerConfig.queryLogMaxTime"options="zzRangeDatePickerConfig.dateOptions" readonly/>',link:function(e,n,t){e.element=n,e.zzRangeDatePickerConfig={isShow:!1,queryLogTimeRange:{startDate:new Date,endDate:new Date},queryLogMaxTime:moment().format("YY/MM/DD HH:mm"),dateOptions:{locale:{fromLabel:"起始时间",toLabel:"结束时间",cancelLabel:"取消",applyLabel:"确定",customRangeLabel:"区间",daysOfWeek:["日","一","二","三","四","五","六"],firstDay:1,monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]},timePicker:!0,timePicker12Hour:!1,timePickerIncrement:1,separator:"~",format:"YY/MM/DD HH:mm",opens:"left"},onDateRangeChanged:null},e.zzRangeDatePicker={isShow:function(){return e.zzRangeDatePickerConfig.isShow},isBindEvent:function(){return void 0!==e.zzRangeDatePickerConfig.onDateRangeChanged&&null!==e.zzRangeDatePickerConfig.onDateRangeChanged},show:function(){e.zzRangeDatePickerConfig.isShow=!0},hide:function(){e.zzRangeDatePickerConfig.isShow=!1},bindDateRangeChangedEvent:function(n){e.zzRangeDatePickerConfig.onDateRangeChanged=n},setDateValue:function(n,t){e.zzRangeDatePickerConfig.queryLogTimeRange.startDate=n,e.zzRangeDatePickerConfig.queryLogTimeRange.endDate=t},setLocation:function(n){e.element.css({position:"absolute",top:n.top.toString()+"px",left:n.left.toString()+"px"})}},e.$watch(function(){var n=e.zzRangeDatePickerConfig.queryLogTimeRange.startDate,t=e.zzRangeDatePickerConfig.queryLogTimeRange.endDate;return n+t},function(){e.zzRangeDatePickerConfig.onDateRangeChanged&&(console.log("queryLogTimeRange changed"),console.log(e.zzRangeDatePickerConfig.queryLogTimeRange.startDate),console.log(e.zzRangeDatePickerConfig.queryLogTimeRange.endDate),e.zzRangeDatePickerConfig.onDateRangeChanged(e.zzRangeDatePickerConfig.queryLogTimeRange))})}}}),angular.module("zhuzhuqs").directive("zzSelect",["GlobalEvent",function(e){return{require:"?ngModel",restrict:"E",replace:!0,template:'<div class="zz-select" ng-class="{\'disabled\': !config.enableEdit}"><div class="zz-select-current"><input class="zz-select-current-text" ng-class="{\'not-empty\': config.currentText}" ng-disabled="!config.enableEdit" ng-blur="onLeaveInputBox();" ng-model="config.currentText" zzplacehold="{{config.defaultContent}}" ng-readonly="!config.enableEdit" /><div class="zz-select-current-icon" ng-class="isExpand? \'expand\':\'\'" ng-click="toggleExpand($event);"></div></div><div class="zz-select-options" ng-show="isExpand"><div class="zz-select-option" ng-repeat="option in config.options | filter: config.currentText" ng-value="option.key" ng-class="{\'option-tag\': option.key == null || option.key == \'\' || option.unable, \'selected\': config.currentChoice.key === option.key}" ng-click="changeValue(option);" ><span class="text" title={{option.value}} ng-class="{authed: option.group_type===\'company\' && option.authed, gold: option.group_type===\'driver\' && option.goodEvaluation >=80, silver: option.group_type===\'driver\' && option.goodEvaluation < 80 && option.goodEvaluation >= 60 ,bronze: option.group_type===\'driver\' && option.goodEvaluation < 60 ,wechat: option.is_wechat}">{{option.value}}</span></div></div></div>',scope:{config:"="},link:function(n,t,r,o){function i(){n.config.currentText||(n.config.currentChoice&&n.config.currentChoice.value?n.config.currentText=n.config.currentChoice.value:n.config.currentText=""),n.config.enableEdit!==!1&&"false"!==n.config.enableEdit&&(n.config.enableEdit=!0),n.config.options||(n.options=[]),n.config.defaultContent||(n.config.defaultContent="请选择")}n.$watch("config.currentText",function(e){r.required&&o.$setValidity("required",!!e)}),n.config.closeSelect=function(){n.isExpand=!1},n.isExpand=!1,n.toggleExpand=function(e){n.config.enableEdit&&(n.isExpand=!n.isExpand),e.stopPropagation()},n.changeValue=function(e){if(e&&!e.unable&&null!=e.key&&""!=e.key){if(n.config.currentChoice&&e.key===n.config.currentChoice.key)return void(n.config.currentText=n.config.currentChoice.value);n.config.currentChoice=e,n.config.currentText=n.config.currentChoice.value,n.isExpand=!1,n.config.onSelected&&n.config.onSelected(e)}},i(),n.onLeaveInputBox=function(){var e=!1;n.config.currentChoice?n.config.currentChoice.value!==n.config.currentText&&(e=!0):e=!0,e&&(n.config.currentChoice=null,n.config.onSelected&&n.config.onSelected(null))},n.$on(e.onBodyClick,function(){n.isExpand&&(n.isExpand=!1)}),n.$watch(function(){return n.config.currentText},function(){n.config.currentText!==n.config.currentChoice&&(n.config.currentChoice&&n.config.currentText===n.config.currentChoice.value||n.config.enableEdit&&(n.isExpand=!0))})}}}]),zhuzhuqs.directive("zzSwitch",["GlobalEvent",function(e){return{restrict:"EA",templateUrl:"directive/zz_switch/zz_switch.client.directive.view.html",replace:!0,transclude:!0,scope:{config:"="},link:function(e,n,t){function r(){e.config.isOpen=e.config.isOpen||!1,e.config.openText=e.config.openText||"是",e.config.closeText=e.config.closeText||"否"}e.config.switchHandle=function(){e.config.isOpen=!e.config.isOpen},r()}}}]);